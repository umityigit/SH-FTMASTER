<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ShiftMaster v114.0 - GHOST PIN & PATRON EDITION (SOCIAL PANEL)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f8fafc; --warning: #facc15; --danger: #ef4444; --success: #10b981; --week: #334155; --undo: #fb7185; }
        
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); padding: 25px; margin: 0; padding-bottom: 90px; }

        /* âœ¨ GÄ°RÄ°Å EKRANI */
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999999; transition: opacity 1s ease; perspective: 1000px; }
        .splash-hospital { font-size: 18px; color: var(--accent); letter-spacing: 4px; margin-bottom: 40px; font-weight: 800; text-align: center; text-shadow: 0 0 20px rgba(56, 189, 248, 0.5); line-height: 1.6; opacity: 0; animation: fadeUp 1s forwards 0.5s; }
        .splash-logo { width: 150px; height: 150px; background: var(--accent); border-radius: 40px; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 80px rgba(56, 189, 248, 0.5); animation: pulse 2.5s infinite, logoDrop 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; margin-bottom: 30px; }
        .splash-text-container { display: flex; gap: 5px; margin-bottom: 15px; }
        .splash-char { font-size: 56px; font-weight: 900; color: var(--text); text-shadow: 0 5px 15px #000; opacity: 0; transform: rotateY(90deg) translateY(50px); display: inline-block; animation: letterReveal 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards; }
        
        /* GÄ°ZLÄ° KÄ°LÄ°T TETÄ°KLEYÄ°CÄ°SÄ° */
        .splash-prod { font-size: 14px; color: #94a3b8; letter-spacing: 3px; font-weight: 600; opacity: 0; border-top: 1px solid #334155; padding-top: 20px; margin-top: 10px; width: 300px; text-align: center; animation: fadeUp 1s forwards 1.5s; cursor: pointer; user-select: none; }
        .splash-prod:active { color: var(--warning); }

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 60px rgba(56, 189, 248, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 0 100px rgba(56, 189, 248, 0.8); } 100% { transform: scale(1); box-shadow: 0 0 60px rgba(56, 189, 248, 0.4); } }
        @keyframes logoDrop { from { transform: scale(0) rotate(-180deg); opacity: 0; } to { transform: scale(1) rotate(0); opacity: 1; } }
        @keyframes letterReveal { to { opacity: 1; transform: rotateY(0) translateY(0); text-shadow: 0 0 20px var(--accent); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ğŸ” KÄ°ÅÄ°SEL KÄ°LÄ°T EKRANI */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #1e293b 0%, #020617 100%); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 999998; }
        
        .profile-container { display: flex; gap: 30px; margin-bottom: 40px; }
        .profile-card { background: rgba(15, 23, 42, 0.8); border: 2px solid #334155; padding: 30px 20px; border-radius: 20px; width: 140px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .profile-card:hover { transform: translateY(-10px); border-color: var(--accent); box-shadow: 0 15px 40px rgba(56, 189, 248, 0.3); }
        .profile-card.active { border-color: var(--success); background: rgba(16, 185, 129, 0.1); transform: scale(1.05); }
        .profile-icon { font-size: 50px; margin-bottom: 15px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.8)); }
        .profile-name { font-size: 18px; font-weight: 800; color: #fff; letter-spacing: 1px; }
        
        .pass-box { background: rgba(15, 23, 42, 0.95); padding: 30px; border-radius: 30px; border: 2px solid var(--accent); text-align: center; width: 350px; box-shadow: 0 0 50px rgba(56, 189, 248, 0.3); transition: transform 0.2s; display: none; flex-direction: column; align-items: center; }
        .pass-input { width: 80%; background: #020617; border: 2px solid var(--accent); color: var(--accent); padding: 15px; border-radius: 15px; font-size: 24px; text-align: center; margin-bottom: 20px; outline: none; transition: 0.3s; font-family: 'Poppins', sans-serif; letter-spacing: 5px; }
        .shake { animation: shake 0.5s; } @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 50% { transform: translateX(10px); } 75% { transform: translateX(-10px); } 100% { transform: translateX(0); } }

        /* KICK (GÃ–LGE KÄ°LÄ°T) EKRANI */
        #kickScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000000; }

        /* ANA YAPI */
        #mainContent { display: none; opacity: 0; animation: fadeIn 1s forwards; } @keyframes fadeIn { to { opacity: 1; } }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: var(--card); padding: 25px; border-radius: 25px; border: 1px solid #334155; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; overflow: hidden; transition: transform 0.3s; }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--accent), #a855f7); }

        /* HEADER / KONTROL Ã‡UBUÄU */
        .main-header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 15px 25px; border-radius: 20px; border: 1px solid #334155; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        /* ğŸ“¢ YENÄ° NESÄ°L HABERLEÅME VE LOG EKRANI */
        .top-panels { display: flex; gap: 20px; margin-bottom: 25px; }
        
        .news-container { flex: 1; background: var(--card); border: 2px solid #334155; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; }
        .news-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .news-list { height: 350px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-right: 5px; scroll-behavior: smooth; }
        .news-item { background: rgba(56, 189, 248, 0.05); border-left: 4px solid var(--accent); padding: 15px; border-radius: 12px; position: relative; transition: 0.3s; display: flex; flex-direction: column; gap: 6px; }
        .news-text { font-size: 13px; font-weight: 500; color: #fff; line-height: 1.5; }
        .news-time { font-size: 10px; color: #94a3b8; font-weight: 400; font-style: italic; }
        
        /* Sosyal Butonlar ve Emoji Stilleri */
        .news-actions { display: flex; gap: 8px; align-items: center; margin-top: 8px; flex-wrap: wrap; }
        .reaction-btn { background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; padding: 4px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; color: #cbd5e1; transition: 0.2s; display: flex; align-items: center; gap: 5px; user-select: none; }
        .reaction-btn:hover { background: rgba(56, 189, 248, 0.15); border-color: var(--accent); transform: translateY(-2px); }
        .reaction-btn.active { background: rgba(56, 189, 248, 0.2); border-color: var(--accent); color: var(--accent); box-shadow: 0 0 10px rgba(56, 189, 248, 0.2); }
        .reply-btn { background: transparent; border: none; color: var(--accent); font-size: 12px; cursor: pointer; font-weight: 700; padding: 4px; margin-left: auto; transition: 0.2s; }
        .reply-btn:hover { color: #fff; text-shadow: 0 0 5px var(--accent); }
        
        /* Emoji AÃ§Ä±lÄ±r Penceresi */
        .emoji-picker-wrapper { position: relative; }
        .emoji-picker { display: none; position: absolute; bottom: 120%; left: 0; background: #0f172a; border: 1px solid var(--accent); padding: 8px; border-radius: 15px; z-index: 100; gap: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.8); }
        .emoji-picker.active { display: flex; }
        .emoji-item { cursor: pointer; font-size: 18px; transition: 0.2s; padding: 2px; }
        .emoji-item:hover { transform: scale(1.3); }

        /* Ä°Ã§iÃ§e Cevaplar (Replies) */
        .replies-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; padding-left: 12px; border-left: 2px dashed #475569; }
        .reply-item { background: rgba(0, 0, 0, 0.25); padding: 10px; border-radius: 10px; font-size: 12px; }
        .reply-input-box { display: none; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #334155; animation: fadeIn 0.3s; }
        .reply-input-box.active { display: flex; }

        /* ğŸ•µï¸â€â™‚ï¸ LOG PANOSU (BÃ¼yÃ¼tÃ¼ldÃ¼) */
        .log-container { flex: 1; background: #0f172a; border: 2px solid var(--warning); border-radius: 20px; padding: 20px; box-shadow: inset 0 0 30px rgba(0,0,0,0.8); }
        .log-list { height: 350px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 5px; }
        .log-item { background: rgba(0,0,0,0.5); border-left: 3px solid var(--warning); padding: 10px 12px; border-radius: 8px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; color: #cbd5e1; }
        .log-user { font-weight: 800; color: var(--warning); margin-right: 8px; }

        .archive-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; max-height: 250px; overflow-y: auto; padding-right: 5px; }
        .archive-card { background: #0f172a; border: 1px solid #334155; padding: 15px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .archive-card:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.4); border-color: var(--accent); }
        .archive-card::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent); opacity: 0; transition: 0.3s; }
        .archive-card:hover::after { opacity: 1; }

        /* âœ¨ POPUP MODALLARI */
        .full-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); z-index: 10005; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .full-modal-content { background: var(--bg); width: 98%; height: 98%; border-radius: 25px; border: 1px solid var(--accent); box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 30px rgba(56, 189, 248, 0.15); display: flex; flex-direction: column; position: relative; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); overflow: hidden; }
        .full-modal-overlay.show { opacity: 1; }
        .full-modal-overlay.show .full-modal-content { transform: scale(1); }
        
        .modal-header-bar { padding: 20px 30px; background: #0f172a; border-bottom: 2px solid #38bdf8; display: flex; justify-content: space-between; align-items: center; z-index: 1001; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-body-area { padding: 25px; flex: 1; overflow-y: auto; }

        /* Ã‡OKLU TABLO YAPISI */
        .table-wrapper { background: var(--card); border: 2px solid #334155; border-radius: 20px; padding: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .table-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .table-title { font-size: 18px; font-weight: 800; color: var(--accent); letter-spacing: 1px; }
        .table-actions-bottom { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; padding: 15px; background: rgba(15, 23, 42, 0.6); border-radius: 15px; border: 1px solid #334155; align-items: center; justify-content: flex-start; }
        
        .scroll-area { overflow-x: auto; border-radius: 15px; border: 1px solid #334155; background: #0f172a; max-width: 100%; box-shadow: inset 0 0 20px #000; position: relative; padding-bottom: 15px; }
        table { width: auto; border-collapse: collapse; min-width: 100%; table-layout: auto; }
        
        /* TABLO HÃœCRELERÄ° */
        th, td { border: 1px solid #1e293b; padding: 10px 6px; text-align: center; font-size: 12px; font-weight: 600; white-space: normal; line-height: 1.2; position: relative; transition: all 0.2s; }
        th { background: #1e293b; color: var(--accent); text-transform: uppercase; height: 50px; user-select: none; font-weight: 800; }
        td { color: #cbd5e1; height: 50px; }

        .shift-cell { box-shadow: inset 1px 1px 4px rgba(255, 255, 255, 0.3), inset -2px -2px 6px rgba(0, 0, 0, 0.6); text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9); color: #ffffff !important; }
        .shift-cell:focus, .editable-name:focus { background: rgba(255, 255, 255, 0.1) !important; backdrop-filter: blur(12px); box-shadow: inset 0 0 20px rgba(56, 189, 248, 0.6), 0 0 15px var(--accent) !important; color: #fff !important; outline: none; }
        .selected-cell { background: rgba(56, 189, 248, 0.4) !important; outline: 2px solid var(--accent) !important; color: #fff !important; z-index: 10; }
        .row-checkbox { width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent); }
        .name-wrapper { display: flex; align-items: center; justify-content: space-between; gap: 8px; width: 190px; padding: 0 5px; }
        .editable-name { flex: 1; text-align: left; outline: none; border-bottom: 1px solid transparent; transition: 0.3s; font-weight: 700; }
        .editable-name:focus { border-bottom: 2px solid var(--accent); color: var(--accent); }
        .nav-box { display: flex; flex-direction: column; gap: 2px; }
        .mini-btn { background: #334155; color: var(--accent); border: 1px solid #475569; padding: 2px 5px; border-radius: 4px; cursor: pointer; font-size: 8px; font-weight: 900; }
        .select-icon { background: var(--accent); color: #000; border: none; width: 26px; height: 26px; border-radius: 50%; cursor: pointer; font-weight: 900; display: flex; align-items: center; justify-content: center; transition: 0.3s; }

        .btn { padding: 10px 18px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 11px; transition: 0.3s; display: inline-flex; align-items: center; gap: 6px; font-family: 'Poppins', sans-serif; letter-spacing: 0.5px; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .glass-input { background: rgba(30, 41, 59, 0.6); border: 1px solid #475569; color: white; padding: 12px; border-radius: 12px; outline: none; font-family: 'Poppins', sans-serif; font-weight: 500; transition: 0.3s; }
        .glass-input:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); background: #1e293b; }

        .custom-menu { display: none; position: absolute; background: #1e293b; border: 2px solid var(--accent); border-radius: 20px; z-index: 100010; width: 360px; box-shadow: 0 15px 50px #000; padding: 12px; animation: menuPop 0.2s; }
        @keyframes menuPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .menu-item { padding: 14px 8px; cursor: pointer; border-radius: 12px; text-align: center; font-weight: 800; font-size: 11px; transition: 0.2s; display: flex; align-items: center; justify-content: center; box-shadow: inset 2px 2px 5px rgba(255, 255, 255, 0.25), inset -3px -3px 8px rgba(0, 0, 0, 0.5), 0 5px 15px rgba(0, 0, 0, 0.4); text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); color: #ffffff !important; }
        .menu-item:hover { transform: scale(1.05); border-color: rgba(255,255,255,0.5); box-shadow: inset 2px 2px 5px rgba(255, 255, 255, 0.4), inset -3px -3px 8px rgba(0, 0, 0, 0.5), 0 8px 20px rgba(56, 189, 248, 0.4); }
        
        .stat-sub { display: inline-block; width: 44%; border: 1px solid #555; font-size: 11px; padding: 4px 0; border-radius: 6px; margin: 1px; font-weight: 800; background: rgba(0,0,0,0.2); transition: 0.2s; }
        .week-summary-cell, .total-summary-cell { width: 95px !important; min-width: 95px !important; background: #334155 !important; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10015; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--card); padding: 30px; border-radius: 30px; border: 1px solid #334155; width: 90%; max-width: 600px; }

        /* ğŸ‘¥ PERSONEL HAVUZU */
        .pool-header { display: flex; align-items: center; margin-bottom: 20px; gap: 15px; border-bottom: 2px solid #334155; padding-bottom: 10px; }
        .pool-count { color: var(--accent); font-size: 24px; text-shadow: 0 0 10px var(--accent); }
        .pool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; align-items: stretch; } 
        .staff-chip { background: #1e293b; border: 1px solid #475569; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: flex-start; gap: 10px; font-size: 13px; color: #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); width: 100%; box-sizing: border-box; user-select: none; }
        .staff-chip:hover { border-color: var(--accent); background: #29384d; transform: translateY(-3px); }
        .staff-chip.selected { border-color: var(--accent); background: rgba(56, 189, 248, 0.15); box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); color: white; }
        .staff-chip input { pointer-events: none; width: 18px; height: 18px; accent-color: var(--accent); }
        .staff-del { margin-left: auto; color: #ef4444; font-size: 18px; font-weight: bold; cursor: pointer; padding: 2px 8px; border-radius: 4px; pointer-events: auto; }
        .staff-del:hover { background: rgba(239, 68, 68, 0.2); }

        .shift-cell[data-pin]::before { content: 'ğŸ“'; position: absolute; top: 2px; right: 2px; font-size: 13px; z-index: 10; cursor: help; text-shadow: 0 0 5px #000; animation: pinPulse 2s infinite; }
        @keyframes pinPulse { 0% { transform: scale(1); } 50% { transform: scale(1.25); } 100% { transform: scale(1); } }
        .shift-cell[data-pin]:hover::after { content: attr(data-pin); position: absolute; bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.95); border: 1px solid var(--warning); color: var(--warning); padding: 10px 15px; border-radius: 12px; font-size: 12px; font-weight: 700; white-space: pre-wrap; width: max-content; max-width: 200px; z-index: 99999; pointer-events: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="splash">
        <div class="splash-hospital">T.C. SAÄLIK BAKANLIÄI<br>ANTALYA DÃ–ÅEMEALTI DEVLET HASTANESÄ°</div>
        <div class="splash-logo"><svg viewBox="0 0 24 24" width="80" fill="#0f172a"><path d="M19,19H5V8H19M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3Z"/></svg></div>
        <div class="splash-text-container" id="splashTextContainer"></div>
        <div class="splash-prod" id="secretTrigger">PROD. BY ÃœMÄ°T ABÄ° 2026</div>
    </div>

    <div id="kickScreen">
        <div style="font-size: 80px; margin-bottom: 20px;">ğŸ›‘</div>
        <h1 style="color: var(--danger); font-weight: 900; text-align: center; text-transform: uppercase;">SÄ°STEM YÃ–NETÄ°CÄ° TARAFINDAN KÄ°LÄ°TLENDÄ°</h1>
        <p style="color: #94a3b8; font-size: 18px; text-align: center; max-width: 600px;">Sistem ÅŸu anda Ãœmit tarafÄ±ndan bakÄ±ma alÄ±nmÄ±ÅŸ veya kilitlenmiÅŸtir. LÃ¼tfen yÃ¶neticiniz ile iletiÅŸime geÃ§in.</p>
    </div>

    <div id="lockScreen">
        <h2 style="color:white; margin-bottom:40px; font-weight:900; font-size: 28px; letter-spacing: 2px;">ğŸ‘¥ KULLANICI SEÃ‡Ä°N</h2>
        
        <div class="profile-container" id="profileContainer">
            <div class="profile-card" onclick="selectProfile('ali')">
                <div class="profile-icon">ğŸï¸</div>
                <div class="profile-name">ALÄ°</div>
            </div>
            <div class="profile-card" onclick="selectProfile('gullu')">
                <div class="profile-icon">ğŸŒ¹</div>
                <div class="profile-name">GÃœLLÃœ</div>
            </div>
            <div class="profile-card" onclick="selectProfile('umit')" style="border-color: var(--warning);">
                <div class="profile-icon">â˜€ï¸</div>
                <div class="profile-name" style="color: var(--warning);">ÃœMÄ°T</div>
            </div>
        </div>

        <div class="pass-box" id="passBox">
            <h3 style="color:var(--accent); margin-top:0;" id="loginTitle">ÅÄ°FRE GÄ°RÄ°NÄ°Z</h3>
            <input type="password" id="passInput" class="pass-input" placeholder="â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter') checkPass()">
            <button class="btn" style="background:var(--accent); color:#000; width:100%; justify-content:center; font-size:16px; padding:15px;" onclick="checkPass()">GÄ°RÄ°Å YAP</button>
            <button class="btn" style="background:transparent; color:#94a3b8; margin-top:10px; font-size: 10px;" onclick="cancelLogin()">GERÄ° DÃ–N</button>
        </div>

        <div class="pass-box" id="newPassBox">
            <h3 style="color:var(--success); margin-top:0;">Ä°LK GÄ°RÄ°Å: ÅÄ°FRE BELÄ°RLE</h3>
            <p style="font-size:11px; color:#94a3b8; margin-top:-10px; margin-bottom:15px;">GÃ¼venliÄŸiniz iÃ§in lÃ¼tfen ÅŸifrenizi deÄŸiÅŸtirin.</p>
            <input type="password" id="newPass1" class="pass-input" placeholder="Yeni Åifre" style="margin-bottom:10px; font-size: 20px; letter-spacing: 2px;">
            <input type="password" id="newPass2" class="pass-input" placeholder="Åifre (Tekrar)" style="font-size: 20px; letter-spacing: 2px;">
            <button class="btn" style="background:var(--success); color:#fff; width:100%; justify-content:center; font-size:16px; padding:15px;" onclick="saveNewPassAndLogin()">KAYDET VE GÄ°RÄ°Å YAP</button>
            <button class="btn" style="background:transparent; color:#94a3b8; margin-top:10px; font-size: 10px;" onclick="cancelLogin()">GERÄ° DÃ–N</button>
        </div>
    </div>

    <div id="changePassModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 400px; text-align: center;">
            <h3 style="margin-top:0; color:var(--warning);">ğŸ”‘ ÅÄ°FRE DEÄÄ°ÅTÄ°R</h3>
            <input type="password" id="cpOld" class="glass-input" style="width:100%; margin-bottom:10px; text-align:center; box-sizing: border-box;" placeholder="Mevcut Åifreniz">
            <input type="password" id="cpNew1" class="glass-input" style="width:100%; margin-bottom:10px; text-align:center; box-sizing: border-box;" placeholder="Yeni Åifre">
            <input type="password" id="cpNew2" class="glass-input" style="width:100%; margin-bottom:15px; text-align:center; box-sizing: border-box;" placeholder="Yeni Åifre (Tekrar)">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:var(--success); color:white; justify-content:center;" onclick="updatePassAnytime()">GÃœNCELLE</button>
                <button class="btn" style="flex:1; background:var(--danger); color:white; justify-content:center;" onclick="document.getElementById('changePassModal').style.display='none'">Ä°PTAL</button>
            </div>
        </div>
    </div>

    <div id="mainContent">
        <div class="container">
            <div class="main-header">
                <div style="font-size: 18px; font-weight: 800; color: var(--accent);" id="welcomeText">ğŸ‘‹ HOÅ GELDÄ°N</div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" style="background: transparent; border: 1px solid var(--warning); color: var(--warning);" onclick="openChangePassModal()">ğŸ”‘ ÅÄ°FRE DEÄÄ°ÅTÄ°R</button>
                    <button class="btn" style="background: var(--danger); color: white;" onclick="logout()">ğŸšª Ã‡IKIÅ YAP</button>
                </div>
            </div>

            <div class="top-panels">
                <div class="news-container card">
                    <div class="news-header"><h4 style="margin:0; color:var(--accent); display:flex; align-items:center; gap:10px;">ğŸ“¢ HABERLEÅME PANOSU</h4></div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="newsInput" class="glass-input" style="flex:1;" placeholder="Ekip iÃ§in bir not bÄ±rak..." onkeydown="if(event.key==='Enter') addNews()">
                        <button class="btn" style="background:var(--accent); color:#000;" onclick="addNews()">GÃ–NDER</button>
                    </div>
                    <div id="newsList" class="news-list"></div>
                </div>

                <div class="log-container card">
                    <div class="news-header"><h4 style="margin:0; color:var(--warning); display:flex; align-items:center; gap:10px;">ğŸ•µï¸â€â™‚ï¸ SON Ä°ÅLEMLER (LOG)</h4></div>
                    <div id="logList" class="log-list">
                        <div style="color: #475569; font-size: 11px; text-align: center; margin-top: 20px;">Sistem hareketleri bekleniyor...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h4 style="margin-top:0; color:var(--text); border-bottom:1px solid #334155; padding-bottom:15px;">ğŸ“ PANODA KAYITLI Ã‡ALIÅMA PLANLARI (KLASÃ–RLER)</h4>
                <div id="archiveList" class="archive-grid"></div>
            </div>

            <div class="card">
                <div style="display:flex; flex-wrap:wrap; gap:15px; align-items:flex-end;">
                    <div><label style="font-size:10px; color:var(--accent); font-weight:900; margin-left:5px;">BAÅLANGIÃ‡</label><br><input type="date" id="startDate" class="glass-input"></div>
                    <div><label style="font-size:10px; color:var(--accent); font-weight:900; margin-left:5px;">GÃœN</label><br><input type="number" id="colCount" value="30" class="glass-input" style="width:60px; text-align:center;"></div>
                    <button class="btn" style="background:var(--accent); color:#000; padding:12px 30px; font-size: 14px;" onclick="generateTableFromSelected()">ğŸš€ SIFIRDAN YENÄ° MATRÄ°S OLUÅTUR</button>
                    <button class="btn" style="background:var(--success); color:white; padding:12px 20px; font-size: 14px;" onclick="openExcelModal()">ğŸ“¥ SIFIRDAN BÄ°R TABLOYA EXCEL'DEN Ã‡EK</button>
                </div>
            </div>

            <div class="card">
                <div class="pool-header"><div class="pool-title">PERSONEL HAVUZU <span id="staffCounter" class="pool-count">0</span> <span style="color:var(--accent);">ğŸ‘¥</span></div></div>
                <div id="staffPool" class="pool-grid" style="margin-bottom: 20px;"></div>
                <div style="display:flex; gap:15px;"><input type="text" id="staffInput" placeholder="Personel ismi..." class="glass-input" style="flex:1;" onkeydown="if(event.key==='Enter') addStaff()"><button class="btn" style="background:var(--accent); color:#000;" onclick="addStaff()">EKLE</button></div>
            </div>
        </div>
    </div>

    <div id="tableModalOverlay" class="full-modal-overlay">
        <div class="full-modal-content">
            <div class="modal-header-bar">
                <div style="font-size:22px; font-weight:900; color:var(--accent); display:flex; align-items:center; gap:10px;">
                    <span id="masterArchiveTitle">ğŸ“ Yeni Dosya</span>
                    <button class="btn" style="background:transparent; color:var(--warning); padding:5px; font-size:10px;" onclick="renameMasterArchive()">âœï¸ Ä°SÄ°M DEÄÄ°ÅTÄ°R</button>
                </div>
                <div style="display:flex; gap:12px; align-items:center;">
                    <button class="btn" style="background:#10b981; color:white; font-size:13px; padding:12px 25px; box-shadow:0 0 20px rgba(16,185,129,0.5);" onclick="saveMasterArchive()">ğŸ’¾ TÃœMÃœNÃœ PANODA KAYDET</button>
                    <span style="width:2px; height:30px; background:#334155; margin:0 5px;"></span>
                    <button class="btn" style="background:#3b82f6; color:white;" onclick="addGlobalBlankTable()">â• YENÄ° BOÅ TABLO EKLE</button>
                    <button class="btn" style="background:var(--danger); color:white; padding:12px 20px;" onclick="closeTableModal()">âŒ EKRANI KAPAT</button>
                </div>
            </div>
            
            <div class="modal-body-area" id="tablesContainer"></div>
        </div>
    </div>

    <div id="excelModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--accent);" id="excelModalTitle">ğŸ“¥ Excel'den Veri Ã‡ek</h3>
            <p style="font-size: 11px; color: #94a3b8; margin-top: -10px; margin-bottom: 15px;">AkÄ±llÄ± Sistem: BaÅŸlÄ±klarÄ± ve tarihleri kendisi siler. Sadece veriyi yapÄ±ÅŸtÄ±rÄ±n yeter.</p>
            <textarea id="excelInput" class="glass-input" style="width:100%; height:200px; font-family:monospace; font-size:11px; margin-bottom:15px;"></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:var(--success); color:white; justify-content:center;" onclick="importFromExcel()">VERÄ°LERÄ° Ä°ÅLE</button>
                <button class="btn" style="flex:1; background:var(--danger); color:white; justify-content:center;" onclick="closeExcelModal()">Ä°PTAL</button>
            </div>
        </div>
    </div>

    <div id="contextMenu" class="custom-menu">
        <div class="menu-grid">
            <div class="menu-item" style="background:linear-gradient(145deg, #f59e0b, #b45309);" onclick="setShift('08:00-20:00','linear-gradient(145deg, #f59e0b, #b45309)')">â˜€ï¸ 08-20</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #1e3a8a, #020617);" onclick="setShift('20:00-08:00','linear-gradient(145deg, #1e3a8a, #020617)')">ğŸŒ™ 20-08</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #f97316, #9a3412);" onclick="setShift('12:00-24:00','linear-gradient(145deg, #f97316, #9a3412)')">ğŸ•’ 12-24</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #0ea5e9, #0369a1);" onclick="setShift('08:00-16:00','linear-gradient(145deg, #0ea5e9, #0369a1)')">ğŸ•˜ 08-16</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #3b82f6, #1d4ed8);" onclick="setShift('16:00-24:00','linear-gradient(145deg, #3b82f6, #1d4ed8)')">ğŸŒ† 16-24</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #4338ca, #1e1b4b);" onclick="setShift('24:00-08:00','linear-gradient(145deg, #4338ca, #1e1b4b)')">ğŸŒ‘ 24-08</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #10b981, #047857);" onclick="setShift('07:00-15:00','linear-gradient(145deg, #10b981, #047857)')">ğŸŒ… 07-15</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #8b5cf6, #5b21b6);" onclick="setShift('15:00-23:00','linear-gradient(145deg, #8b5cf6, #5b21b6)')">ğŸŒ† 15-23</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #4c1d95, #2e1065);" onclick="setShift('23:00-07:00','linear-gradient(145deg, #4c1d95, #2e1065)')">ğŸŒƒ 23-07</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #d946ef, #86198f);" onclick="setShift('08:00-18:00','linear-gradient(145deg, #d946ef, #86198f)')">ğŸ•’ 08-18</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #14b8a6, #0f766e);" onclick="setShift('HT','linear-gradient(145deg, #14b8a6, #0f766e)')">ğŸ–ï¸ HT</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #f43f5e, #be123c);" onclick="setShift('YÄ°','linear-gradient(145deg, #f43f5e, #be123c)')">ğŸŒ´ YÄ°</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #ef4444, #991b1b);" onclick="setShift('R','linear-gradient(145deg, #ef4444, #991b1b)')">ğŸ’Š R</div>
            <div class="menu-item" style="background:linear-gradient(145deg, #334155, #0f172a);" onclick="setShift('')">âŒ SÄ°L</div>

            <div class="menu-item" style="background:linear-gradient(45deg, #38bdf8, #a855f7); grid-column: span 2;" onclick="setAdjustableShift()">âš™ï¸ AYARLANABÄ°LÄ°R SAAT GÄ°R</div>
            <div class="menu-item" style="background:var(--warning); color:#000; font-size:11px;" onclick="addGhostPinToCell()">ğŸ“ Ä°ÄNE AT</div>
            <div class="menu-item" style="background:transparent; border:1px solid var(--danger); color:var(--danger); font-size:11px;" onclick="removeGhostPinFromCell()">ğŸ—‘ï¸ Ä°ÄNE SÄ°L</div>
        </div>
    </div>
    <div id="staffSelectMenu" class="custom-menu" style="max-height:300px; overflow-y:auto; width:200px;"></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAAqT74kCwyr6ZULTR_ClRDJ5Iu4AhmXJQ", databaseURL: "https://shiftmaster1-7fc5f-default-rtdb.europe-west1.firebasedatabase.app", projectId: "shiftmaster1-7fc5f" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const users = {
            'ali': { name: 'ALÄ°', icon: 'ğŸï¸' },
            'gullu': { name: 'GÃœLLÃœ', icon: 'ğŸŒ¹' },
            'umit': { name: 'ÃœMÄ°T', icon: 'â˜€ï¸' }
        };
        
        let userPasswords = { ali: '1234', gullu: '1234', umit: '1234' };
        let currentUser = "";
        let selectedUserKey = "";

        db.ref('kullanici_sifreleri').on('value', snap => {
            if(snap.val()) { userPasswords = { ...userPasswords, ...snap.val() }; }
        });

        db.ref('sistem_kilitli').on('value', snap => {
            const isLocked = snap.val();
            if(isLocked && currentUser !== 'ÃœMÄ°T' && currentUser !== "") {
                document.getElementById('kickScreen').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
            }
        });

        function logAction(actionText) {
            if(!currentUser) return;
            const logData = { user: currentUser, action: actionText, time: new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'}) };
            db.ref("islem_loglari").push(logData);
        }

        db.ref("islem_loglari").limitToLast(25).on("value", snap => {
            const l = document.getElementById("logList"); l.innerHTML = "";
            const data = snap.val();
            if(data) {
                Object.values(data).reverse().forEach(val => {
                    l.innerHTML += `<div class="log-item"><span class="log-user">${val.user}:</span> <span style="flex:1;">${val.action}</span> <span style="color:#64748b; font-size:9px;">${val.time}</span></div>`;
                });
            } else { l.innerHTML = `<div style="color: #475569; font-size: 11px; text-align: center; margin-top: 20px;">HenÃ¼z iÅŸlem yok.</div>`; }
        });

        function selectProfile(key) {
            db.ref('sistem_kilitli').once('value').then(snap => {
                if(snap.val() && key !== 'umit') {
                    alert("ğŸ›‘ SÄ°STEM YÃ–NETÄ°CÄ° TARAFINDAN GEÃ‡Ä°CÄ° OLARAK BAKIMA ALINMIÅTIR.");
                    return;
                }
                selectedUserKey = key;
                document.querySelectorAll('.profile-card').forEach(c => c.classList.remove('active'));
                event.currentTarget.classList.add('active');
                
                document.getElementById('loginTitle').innerText = `${users[key].icon} ${users[key].name} ÅÄ°FRESÄ°`;
                document.getElementById('profileContainer').style.display = 'none';
                document.getElementById('passBox').style.display = 'flex';
                document.getElementById('newPassBox').style.display = 'none';
                document.getElementById('passInput').focus();
            });
        }

        function cancelLogin() {
            document.getElementById('passBox').style.display = 'none';
            document.getElementById('newPassBox').style.display = 'none';
            document.getElementById('profileContainer').style.display = 'flex';
            document.getElementById('passInput').value = "";
            document.getElementById('newPass1').value = "";
            document.getElementById('newPass2').value = "";
            document.querySelectorAll('.profile-card').forEach(c => c.classList.remove('active'));
            selectedUserKey = "";
        }

        function checkPass() {
            const input = document.getElementById("passInput").value;
            const correctPass = userPasswords[selectedUserKey];

            if(input === correctPass) {
                if(input === '1234') {
                    document.getElementById('passBox').style.display = 'none';
                    document.getElementById('newPassBox').style.display = 'flex';
                    document.getElementById('newPass1').focus();
                } else {
                    executeLogin();
                }
            } else {
                const box = document.getElementById("passBox"); box.classList.add("shake");
                setTimeout(() => box.classList.remove("shake"), 500);
                document.getElementById("passInput").value = "";
            }
        }

        function saveNewPassAndLogin() {
            const p1 = document.getElementById('newPass1').value;
            const p2 = document.getElementById('newPass2').value;
            
            if(p1.length < 4) return alert("Åifre en az 4 haneli olmalÄ±dÄ±r!");
            if(p1 !== p2) return alert("Åifreler eÅŸleÅŸmiyor!");

            db.ref('kullanici_sifreleri/' + selectedUserKey).set(p1);
            alert("âœ… Åifreniz onaylandÄ±!\n\nÄ°stediÄŸiniz zaman saÄŸ Ã¼st kÃ¶ÅŸedeki 'ÅÄ°FRE DEÄÄ°ÅTÄ°R' butonuna tÄ±klayarak gÃ¼ncelleyebilirsiniz.");
            executeLogin();
        }

        function executeLogin() {
            currentUser = users[selectedUserKey].name;
            logAction("Sisteme giriÅŸ yaptÄ±.");
            document.getElementById("lockScreen").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            document.getElementById("welcomeText").innerText = `ğŸ‘‹ HOÅ GELDÄ°N, ${currentUser}`;
            loadStaffPool(); loadArchives(); loadNews();
        }

        function logout() {
            currentUser = ""; selectedUserKey = "";
            document.getElementById("mainContent").style.display = "none";
            document.getElementById("lockScreen").style.display = "flex";
            cancelLogin();
        }

        function openChangePassModal() {
            document.getElementById('cpOld').value = ''; document.getElementById('cpNew1').value = ''; document.getElementById('cpNew2').value = '';
            document.getElementById('changePassModal').style.display = 'flex';
        }

        function updatePassAnytime() {
            const oldP = document.getElementById('cpOld').value; const newP1 = document.getElementById('cpNew1').value; const newP2 = document.getElementById('cpNew2').value;
            if(oldP !== userPasswords[selectedUserKey]) return alert("Mevcut ÅŸifrenizi yanlÄ±ÅŸ girdiniz!");
            if(newP1.length < 4) return alert("Yeni ÅŸifre en az 4 haneli olmalÄ±!");
            if(newP1 !== newP2) return alert("Yeni ÅŸifreler eÅŸleÅŸmiyor!");
            db.ref('kullanici_sifreleri/' + selectedUserKey).set(newP1);
            alert("âœ… Åifreniz baÅŸarÄ±yla deÄŸiÅŸtirildi.");
            document.getElementById('changePassModal').style.display = 'none';
        }

        let secretClicks = 0; let secretTimer;
        document.getElementById('secretTrigger').addEventListener('click', () => {
            secretClicks++; clearTimeout(secretTimer);
            secretTimer = setTimeout(() => { secretClicks = 0; }, 1500);
            
            if(secretClicks >= 3) {
                secretClicks = 0;
                const godPass = prompt("ğŸ”¥ GÃ–LGE KÄ°LÄ°T MASTER ÅÄ°FRE:");
                if(godPass === "PATRON") {
                    db.ref('sistem_kilitli').once('value').then(snap => {
                        let isLocked = snap.val();
                        if(isLocked) {
                            if(confirm("Sistem ÅŸu an kilitli. KÄ°LÄ°DÄ° AÃ‡MAK ister misin?")) { db.ref('sistem_kilitli').set(false); alert("Sistem Kiliti AÃ§Ä±ldÄ±. Herkes girebilir."); }
                        } else {
                            if(confirm("Sistemi kitlemek Ã¼zeresin. Senin dÄ±ÅŸÄ±nda herkes ATILACAK. OnaylÄ±yor musun?")) { db.ref('sistem_kilitli').set(true); alert("Sistem kilitlendi. YalnÄ±zca sen varsÄ±n."); }
                        }
                    });
                }
            }
        });

        // âœ¨ TAM Ã‡EVRÄ°MDIÅI (OFFLINE-FIRST) KALKANI - V2 âœ¨
        (function() {
            if (!window.firebase || !firebase.database) return;
            const dummyRef = firebase.database().ref(); const dbProto = Object.getPrototypeOf(dummyRef);
            function getPath(ref) { return ref.toString().replace(ref.root.toString(), '') || 'ana_dizin'; }

            const origOn = dbProto.on;
            dbProto.on = function(eventType, callback, cancelCallback, context) {
                if (eventType === 'value') {
                    const safePath = getPath(this); const cachedData = localStorage.getItem('sm_v2_' + safePath);
                    if (cachedData) { try { const parsed = JSON.parse(cachedData); const fakeSnap = { val: () => parsed, exists: () => parsed !== null, key: this.key }; setTimeout(() => { if (typeof callback === 'function') callback(fakeSnap); }, 10); } catch (e) {} }
                    const wrappedCallback = function(snap) { if (snap) localStorage.setItem('sm_v2_' + safePath, JSON.stringify(snap.val())); if (typeof callback === 'function') callback(snap); };
                    return origOn.call(this, eventType, wrappedCallback, cancelCallback, context);
                } return origOn.call(this, eventType, callback, cancelCallback, context);
            };

            const origOnce = dbProto.once;
            dbProto.once = function(eventType, callback, failureCallback, context) {
                const safePath = getPath(this);
                if (eventType === 'value' && !navigator.onLine) {
                    const cachedData = localStorage.getItem('sm_v2_' + safePath);
                    if (cachedData) { try { const parsed = JSON.parse(cachedData); const fakeSnap = { val: () => parsed, exists: () => parsed !== null, key: this.key }; if (typeof callback === 'function') callback(fakeSnap); return Promise.resolve(fakeSnap); } catch (e) {} }
                }
                return origOnce.call(this, eventType, callback, failureCallback, context).then(snap => { if (eventType === 'value' && snap) localStorage.setItem('sm_v2_' + safePath, JSON.stringify(snap.val())); return snap; });
            };

            const origSet = dbProto.set; dbProto.set = function(value, onComplete) { const safePath = getPath(this); localStorage.setItem('sm_v2_' + safePath, JSON.stringify(value)); if (!navigator.onLine) { let queue = JSON.parse(localStorage.getItem('sm_queue') || '[]'); queue.push({ type: 'set', path: safePath, data: value }); localStorage.setItem('sm_queue', JSON.stringify(queue)); if (typeof onComplete === 'function') onComplete(null); return Promise.resolve(); } return origSet.call(this, value, onComplete); };
            const origUpdate = dbProto.update; dbProto.update = function(value, onComplete) { const safePath = getPath(this); if (!navigator.onLine) { let queue = JSON.parse(localStorage.getItem('sm_queue') || '[]'); queue.push({ type: 'update', path: safePath, data: value }); localStorage.setItem('sm_queue', JSON.stringify(queue)); if (typeof onComplete === 'function') onComplete(null); return Promise.resolve(); } return origUpdate.call(this, value, onComplete); };
            const origRemove = dbProto.remove; dbProto.remove = function(onComplete) { const safePath = getPath(this); if (!navigator.onLine) { let queue = JSON.parse(localStorage.getItem('sm_queue') || '[]'); queue.push({ type: 'remove', path: safePath }); localStorage.setItem('sm_queue', JSON.stringify(queue)); if (typeof onComplete === 'function') onComplete(null); return Promise.resolve(); } return origRemove.call(this, onComplete); };

            function kuyruguBosalt() { let queue = JSON.parse(localStorage.getItem('sm_queue') || '[]'); if (queue.length > 0) { queue.forEach(item => { if (item.type === 'set') firebase.database().ref(item.path).set(item.data); else if (item.type === 'update') firebase.database().ref(item.path).update(item.data); else if (item.type === 'remove') firebase.database().ref(item.path).remove(); }); localStorage.removeItem('sm_queue'); } }
            window.addEventListener('online', kuyruguBosalt); setTimeout(() => { if (navigator.onLine) kuyruguBosalt(); }, 1500);
        })();

        let activeCell = null, staffList = [], history = [];
        let currentTargetTable = null; 
        let currentMasterArchiveId = null;
        let currentMasterArchiveName = "Yeni Dosya";

        const shiftRules = {
            '08:00-20:00': { w: 11, n: 0, color: 'linear-gradient(145deg, #f59e0b, #b45309)' },
            '20:00-08:00': { w: 11, n: 11, color: 'linear-gradient(145deg, #1e3a8a, #020617)' },
            '12:00-24:00': { w: 11, n: 4, color: 'linear-gradient(145deg, #f97316, #9a3412)' },
            '08:00-16:00': { w: 7.5, n: 0, color: 'linear-gradient(145deg, #0ea5e9, #0369a1)' },
            '16:00-24:00': { w: 7.5, n: 4, color: 'linear-gradient(145deg, #3b82f6, #1d4ed8)' },
            '24:00-08:00': { w: 7.5, n: 7.5, color: 'linear-gradient(145deg, #4338ca, #1e1b4b)' },
            '07:00-15:00': { w: 7.5, n: 0, color: 'linear-gradient(145deg, #10b981, #047857)' },
            '15:00-23:00': { w: 7.5, n: 3, color: 'linear-gradient(145deg, #8b5cf6, #5b21b6)' },
            '23:00-07:00': { w: 7.5, n: 7.5, color: 'linear-gradient(145deg, #4c1d95, #2e1065)' },
            '08:00-18:00': { w: 9, n: 0, color: 'linear-gradient(145deg, #d946ef, #86198f)' },
            'HT': { w: 0, n: 0, color: 'linear-gradient(145deg, #14b8a6, #0f766e)' },
            'YÄ°': { w: 0, n: 0, color: 'linear-gradient(145deg, #f43f5e, #be123c)' },
            'R': { w: 0, n: 0, color: 'linear-gradient(145deg, #ef4444, #991b1b)' }
        };

        function openTableModal() { const modal = document.getElementById('tableModalOverlay'); modal.style.display = 'flex'; document.body.style.overflow = 'hidden'; setTimeout(() => modal.classList.add('show'), 10); }
        function closeTableModal() { const modal = document.getElementById('tableModalOverlay'); modal.classList.remove('show'); setTimeout(() => { modal.style.display = 'none'; document.body.style.overflow = 'auto'; }, 300); }
        function startNewSession() { currentMasterArchiveId = null; currentMasterArchiveName = "Yeni Dosya"; document.getElementById("masterArchiveTitle").innerText = "ğŸ“ Yeni Dosya"; document.getElementById("tablesContainer").innerHTML = ""; }
        
        function loadNews() { 
            db.ref("haberler").on("value", snap => { 
                const l = document.getElementById("newsList"); l.innerHTML = ""; 
                const data = snap.val(); 
                if(data) { 
                    Object.entries(data).reverse().forEach(([id, val]) => { 
                        let repliesHtml = '';
                        if(val.replies) {
                            repliesHtml = '<div class="replies-container">';
                            Object.entries(val.replies).forEach(([rId, rVal]) => {
                                repliesHtml += `<div class="reply-item"><strong style="color:var(--warning);">${rVal.user}:</strong> <span style="color:#e2e8f0;">${rVal.text}</span> <span style="font-size:9px; color:#94a3b8; display:block; margin-top:3px;">${rVal.time}</span></div>`;
                            });
                            repliesHtml += '</div>';
                        }

                        const quickEmojis = ['ğŸ‘', 'ğŸ‘', 'â¤ï¸'];
                        let reactionsHtml = '';
                        const reactions = val.reactions || {};
                        
                        quickEmojis.forEach(emoji => {
                            const count = reactions[emoji] ? Object.keys(reactions[emoji]).length : 0;
                            const hasReacted = (reactions[emoji] && reactions[emoji][currentUser]) ? 'active' : '';
                            reactionsHtml += `<div class="reaction-btn ${hasReacted}" onclick="toggleReaction('${id}', '${emoji}')">${emoji} ${count > 0 ? count : ''}</div>`;
                        });

                        Object.keys(reactions).forEach(emoji => {
                            if (!quickEmojis.includes(emoji)) {
                                const count = Object.keys(reactions[emoji]).length;
                                const hasReacted = reactions[emoji][currentUser] ? 'active' : '';
                                reactionsHtml += `<div class="reaction-btn ${hasReacted}" onclick="toggleReaction('${id}', '${emoji}')">${emoji} ${count > 0 ? count : ''}</div>`;
                            }
                        });

                        l.innerHTML += `
                        <div class="news-item">
                            <div style="display:flex; justify-content:space-between;">
                                <div class="news-text">${val.text}</div>
                                <span class="news-delete" onclick="deleteNews('${id}')" style="color: var(--danger); cursor: pointer; font-size:16px;">Ã—</span>
                            </div>
                            <div class="news-time">${val.user} â€¢ ${val.time}</div>
                            
                            ${repliesHtml}
                            
                            <div class="news-actions">
                                ${reactionsHtml}
                                
                                <div class="emoji-picker-wrapper">
                                    <div class="reaction-btn" onclick="toggleEmojiPicker('${id}')" style="border-radius:50%; width:24px; height:24px; justify-content:center; padding:0;">â•</div>
                                    <div id="emoji-picker-${id}" class="emoji-picker">
                                        <span class="emoji-item" onclick="toggleReaction('${id}', 'ğŸ˜‚')">ğŸ˜‚</span>
                                        <span class="emoji-item" onclick="toggleReaction('${id}', 'ğŸŒ¸')">ğŸŒ¸</span>
                                        <span class="emoji-item" onclick="toggleReaction('${id}', 'ğŸ‰')">ğŸ‰</span>
                                        <span class="emoji-item" onclick="toggleReaction('${id}', 'ğŸ”¥')">ğŸ”¥</span>
                                        <span class="emoji-item" onclick="toggleReaction('${id}', 'ğŸ’¡')">ğŸ’¡</span>
                                    </div>
                                </div>

                                <button class="reply-btn" onclick="toggleReplyBox('${id}')">â†©ï¸ Cevapla</button>
                            </div>

                            <div id="reply-box-${id}" class="reply-input-box">
                                <input type="text" id="reply-input-${id}" class="glass-input" style="flex:1; padding:8px 12px; font-size:11px;" placeholder="CevabÄ±nÄ± yaz..." onkeydown="if(event.key==='Enter') sendReply('${id}')">
                                <button class="btn" style="background:var(--success); color:white; padding:8px 15px;" onclick="sendReply('${id}')">GÃ¶nder</button>
                            </div>
                        </div>`; 
                    }); 
                } 
            }); 
        }

        function addNews() { const i = document.getElementById("newsInput"); if(i.value.trim()) { db.ref("haberler").push({ text: i.value.trim(), user: currentUser, time: new Date().toLocaleString('tr-TR', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'}) }); logAction(`Panoya not bÄ±raktÄ±: "${i.value.substring(0,10)}..."`); i.value = ""; } }
        function deleteNews(id) { if(confirm("MesajÄ± kalÄ±cÄ± olarak silmek istiyor musun?")) { db.ref("haberler").child(id).remove(); logAction("Panodan bir mesaj sildi."); } }

        function toggleReplyBox(id) {
            const box = document.getElementById(`reply-box-${id}`);
            box.classList.toggle('active');
            if(box.classList.contains('active')) document.getElementById(`reply-input-${id}`).focus();
        }

        function sendReply(newsId) {
            const input = document.getElementById(`reply-input-${newsId}`);
            const text = input.value.trim();
            if(text) {
                db.ref(`haberler/${newsId}/replies`).push({
                    text: text,
                    user: currentUser,
                    time: new Date().toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})
                });
                input.value = '';
                toggleReplyBox(newsId);
                logAction("Bir mesaja cevap verdi.");
            }
        }

        function toggleEmojiPicker(id) {
            document.querySelectorAll('.emoji-picker.active').forEach(p => {
                if(p.id !== `emoji-picker-${id}`) p.classList.remove('active');
            });
            const picker = document.getElementById(`emoji-picker-${id}`);
            picker.classList.toggle('active');
        }

        function toggleReaction(newsId, emoji) {
            if(!currentUser) return;
            const ref = db.ref(`haberler/${newsId}/reactions/${emoji}/${currentUser}`);
            ref.once('value', snap => {
                if(snap.exists()) ref.remove(); 
                else ref.set(true); 
            });
            
            const picker = document.getElementById(`emoji-picker-${newsId}`);
            if(picker) picker.classList.remove('active');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.emoji-picker-wrapper')) {
                document.querySelectorAll('.emoji-picker.active').forEach(p => p.classList.remove('active'));
            }
        });


        function loadStaffPool() { db.ref("personel_havuzu").on("value", snap => { const p = document.getElementById("staffPool"); p.innerHTML = ""; const data = snap.val(); let count = 0; staffList = []; if(data) { Object.entries(data).forEach(([id, name]) => { staffList.push({id: id, name: name}); }); staffList.sort((a, b) => a.name.localeCompare(b.name)); staffList.forEach(item => { count++; const div = document.createElement("div"); div.className = "staff-chip"; div.innerHTML = `<input type="checkbox" value="${item.name}"> <span>${item.name}</span> <span class="staff-del" onclick="removeStaff(event, '${item.id}')">Ã—</span>`; div.onclick = (e) => { if(!e.target.classList.contains('staff-del')) { const cb = div.querySelector('input'); cb.checked = !cb.checked; if(cb.checked) div.classList.add('selected'); else div.classList.remove('selected'); } }; p.appendChild(div); }); } document.getElementById("staffCounter").innerText = count; }); }
        function addStaff() { const inp = document.getElementById("staffInput"); const v = inp.value.trim(); if(v) { db.ref("personel_havuzu").push(v); logAction(`Havuz'a kiÅŸi ekledi: ${v}`); inp.value = ""; } }
        function removeStaff(e, id) { e.stopPropagation(); if(confirm("Personel havuzdan silinsin mi?")) { db.ref("personel_havuzu").child(id).remove(); logAction("Havuzdan kiÅŸi sildi."); } }

        function addGhostPinToCell() {
            if(!activeCell) return;
            let currentNote = activeCell.getAttribute("data-pin") || "";
            let newNote = prompt("Bu hÃ¼creye iÄŸnelemek istediÄŸiniz notu yazÄ±n:", currentNote);
            if(newNote !== null) {
                if(newNote.trim() === "") { activeCell.removeAttribute("data-pin"); } 
                else { activeCell.setAttribute("data-pin", newNote.trim()); logAction(`HÃ¼creye iÄŸne taktÄ±.`); }
                saveHistory();
            }
            document.getElementById("contextMenu").style.display = "none";
        }
        function removeGhostPinFromCell() { if(!activeCell) return; activeCell.removeAttribute("data-pin"); saveHistory(); document.getElementById("contextMenu").style.display = "none"; logAction(`HÃ¼cre iÄŸnesini kaldÄ±rdÄ±.`); }

        function generateTable(isArchOrImp, data, tableName = "Yeni Liste", customStartDt = null, customColCount = null, insertAfterWrapper = null, savedNotes = "") {
            const cols = customColCount || parseInt(document.getElementById("colCount").value);
            let startDt = customStartDt;
            if(!startDt) { let startDateVal = document.getElementById("startDate").value || new Date().toISOString().split('T')[0]; startDt = new Date(startDateVal); }
            
            let h = `<table><thead><tr><th style="display:flex; align-items:center; gap:8px; justify-content:center; border:none; background:transparent;"><input type="checkbox" onclick="toggleAllRows(this)" class="row-checkbox"> PERSONEL</th>`;
            
            for(let i=0; i<cols; i++) {
                let d = new Date(startDt); d.setDate(startDt.getDate() + i);
                let fullDateStr = `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
                h += `<th data-date="${fullDateStr}">${d.toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit'})}<br><span style="font-size:10px; opacity:0.7;">${d.toLocaleDateString('tr-TR',{weekday:'short'})}</span></th>`;
                if(d.getDay() === 0) h += `<th class="week-summary-cell" style="color:var(--warning);">S | G</th>`;
            }
            h += `<th class="total-summary-cell" style="color:var(--success);">TOPLAM</th></tr></thead><tbody class="table-body">`;
            
            if(isArchOrImp) data.forEach(r => { h += createRowHtml(r.name, cols, startDt, r.shifts); });
            else data.forEach(n => { h += createRowHtml(n, cols, startDt); });
            h += '</tbody></table>';

            const wrapper = document.createElement("div"); wrapper.className = "table-wrapper";
            wrapper.setAttribute("data-startdt", startDt.toISOString()); wrapper.setAttribute("data-colcount", cols); wrapper.setAttribute("data-tablename", tableName);
            
            wrapper.innerHTML = `
                <div class="table-header">
                    <span class="table-title" style="cursor:pointer;" onclick="renameLocalTable(this)">ğŸ“Œ ${tableName} <span style="font-size:10px; opacity:0.6;">(DeÄŸiÅŸtirmek iÃ§in tÄ±kla)</span></span>
                    <span style="font-size:11px; color:#94a3b8; background:#1e293b; padding:4px 10px; border-radius:8px; margin-left:auto;">${startDt.toLocaleDateString('tr-TR')} / ${cols} GÃ¼n</span>
                </div>
                <div class="scroll-area">${h}</div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(15, 23, 42, 0.4); border-radius: 15px; border: 1px dashed var(--accent);">
                    <label style="font-size: 12px; font-weight: 800; color: var(--accent); display:flex; align-items:center; gap:8px;">ğŸ“ BU AY NE OLDU? <span style="color:#94a3b8; font-weight:400; font-size:10px;">(Genel Tablo NotlarÄ±, Olaylar... Hepsi arÅŸive kaydedilir.)</span></label>
                    <textarea class="table-notes glass-input" style="width: 100%; height: 60px; margin-top: 10px; resize: vertical; box-sizing: border-box; font-size:12px; color:#fff; border-color:var(--accent);" placeholder="Bu tabloyla ilgili aklÄ±nÄ±zda tutamadÄ±ÄŸÄ±nÄ±z her ÅŸeyi buraya yazÄ±n...">${savedNotes}</textarea>
                </div>
                <div class="table-actions-bottom">
                    <button class="btn" style="background:#10b981; color:white;" onclick="addEmptyRow(this)">â• SATIR EKLE</button>
                    <button class="btn" style="background:#0ea5e9; color:white;" onclick="copyTableRows(this)">ğŸ“‹ KOPYALA</button>
                    <button class="btn" style="background:#f59e0b; color:white;" onclick="exportTableToExcel(this)">ğŸ“¤ EXCEL (PUANTAJ)</button>
                    <button class="btn" style="background:#a855f7; color:white;" onclick="pasteToTableRows(this)">ğŸ“¥ HIZLI YAPIÅTIR</button>
                    <button class="btn" style="background:#0f766e; color:white;" onclick="openExcelModalForTable(this)">ğŸ“¥ EXCEL'DEN KUTUYA AL</button>
                    <button class="btn" style="background:var(--danger); color:white;" onclick="deleteTableRows(this)">ğŸ—‘ï¸ SEÃ‡Ä°LÄ°YÄ° SÄ°L</button>
                    <span style="width: 2px; height: 20px; background: #334155; margin: 0 5px;"></span>
                    <button class="btn" style="background:#8b5cf6; color:white;" onclick="calcTable(this)">ğŸ”„ HESAPLA</button>
                    <button class="btn" style="background:#ec4899; color:white;" onclick="takeFullScreenshot(this)">ğŸ“¸ FOTOÄRAF AL</button>
                    <span style="flex-grow:1;"></span>
                    <button class="btn" style="background:#3b82f6; color:white;" onclick="addTableWithSameStaff(this)">â• YENÄ° TABLO (AYNI KÄ°ÅÄ°LERLE)</button>
                    <button class="btn" style="background:transparent; border:1px solid var(--danger); color:var(--danger);" onclick="closeTable(this)">ğŸ—‘ï¸ TABLOYU EKRANDAN SÄ°L</button>
                </div>
            `;
            
            if(insertAfterWrapper) insertAfterWrapper.parentNode.insertBefore(wrapper, insertAfterWrapper.nextSibling);
            else document.getElementById("tablesContainer").appendChild(wrapper); 

            saveHistory(); updateAllStats(); openTableModal(); 
        }

        function createRowHtml(name, colCount, startDt, savedShifts = null) {
            let cells = `<td><div style="display:flex; align-items:center; gap:8px;"><input type="checkbox" class="row-checkbox"><div class="name-wrapper"><div class="nav-box"><button class="mini-btn" onclick="moveRow(this,-1)">â–²</button><button class="mini-btn" onclick="moveRow(this,1)">â–¼</button></div><div class="editable-name" contenteditable="true" onfocus="saveHistory()">${name}</div><button class="select-icon" onclick="openStaffQuickMenu(event, this)">â–¼</button></div></div></td>`;
            let shiftIdx = 0;
            for(let i=0; i<colCount; i++) {
                let d = new Date(startDt); d.setDate(startDt.getDate() + i);
                const txt = (savedShifts && savedShifts[shiftIdx]) ? savedShifts[shiftIdx].text : "";
                const bg = (savedShifts && savedShifts[shiftIdx]) ? savedShifts[shiftIdx].bg : "transparent";
                const pinText = (savedShifts && savedShifts[shiftIdx] && savedShifts[shiftIdx].pin) ? savedShifts[shiftIdx].pin : "";
                const pinAttr = pinText ? ` data-pin="${pinText.replace(/"/g, '&quot;')}"` : ""; 
                cells += `<td class="shift-cell" contenteditable="true" style="background:${bg}" oncontextmenu="openShiftMenu(event, this)" oninput="updateAllStats()"${pinAttr}>${txt}</td>`;
                shiftIdx++; if(d.getDay() === 0) cells += `<td class="week-summary-cell" style="background:#334155 !important;"></td>`;
            }
            cells += `<td class="total-summary-cell" style="background:#020617 !important;"></td>`;
            return `<tr>${cells}</tr>`;
        }

        function takeFullScreenshot(btn) { const wrapper = btn.closest('.table-wrapper'); const captureArea = wrapper.querySelector(".scroll-area"); const table = wrapper.querySelector("table"); let oldText = btn.innerHTML; btn.innerHTML = "â³ FOTO ALINIYOR..."; let oldOverflow = captureArea.style.overflowX; captureArea.style.overflowX = 'visible'; html2canvas(captureArea, { backgroundColor: "#0f172a", scale: 2, useCORS: true, width: table.scrollWidth + 10 }).then(canvas => { const link = document.createElement("a"); link.download = `Vardiya_${wrapper.getAttribute('data-tablename')}.png`; link.href = canvas.toDataURL(); link.click(); btn.innerHTML = oldText; captureArea.style.overflowX = oldOverflow; }); logAction("Tablonun fotoÄŸrafÄ±nÄ± aldÄ±."); }
        function renameLocalTable(span) { const wrapper = span.closest('.table-wrapper'); let current = wrapper.getAttribute("data-tablename"); let pName = prompt("Bu alt tablonun adÄ± ne olsun?", current); if(pName && pName.trim() !== "") { wrapper.setAttribute("data-tablename", pName.trim()); span.innerHTML = `ğŸ“Œ ${pName.trim()} <span style="font-size:10px; opacity:0.6;">(DeÄŸiÅŸtirmek iÃ§in tÄ±kla)</span>`; } }
        function addEmptyRow(btn) { const wrapper = btn.closest('.table-wrapper'); const startDt = new Date(wrapper.getAttribute("data-startdt")); const cols = parseInt(wrapper.getAttribute("data-colcount")); const newRowHtml = createRowHtml("Ä°SÄ°M GÄ°RÄ°NÄ°Z...", cols, startDt); wrapper.querySelector('tbody').insertAdjacentHTML('beforeend', newRowHtml); saveHistory(); updateAllStats(); }

        /* KOPYALAMA Ä°Ã‡Ä°N YENÄ° TEMÄ°Z TEXT Ã‡EKÄ°CÄ° (Sorunu KÃ¶kten Ã‡Ã¶zer) */
        function getCleanCellText(cell) { 
            if (cell.tagName === 'TH' && cell.hasAttribute('data-date')) return cell.getAttribute('data-date'); 
            if (cell.querySelector('.editable-name')) return cell.querySelector('.editable-name').textContent.trim(); 
            if (cell.querySelector('.stat-sub')) return cell.textContent.replace(/\n/g, " | "); 
            let text = (cell.textContent || "").replace(/\n/g, " ").trim(); 
            if (cell.tagName === 'TH' && text.includes("PERSONEL")) return "PERSONEL"; 
            return text; 
        }

        function copyTableRows(btn) {
            const wrapper = btn.closest('.table-wrapper'); const table = wrapper.querySelector('table'); const cbs = table.querySelectorAll('tbody .row-checkbox:checked');
            if(cbs.length === 0) return alert("Kopyalanacak satÄ±rlarÄ± seÃ§iniz!");
            let html = "<table border='1'><thead><tr>"; let tsv = "";
            table.querySelectorAll('thead th').forEach(th => { if(th.classList.contains('week-summary-cell') || th.classList.contains('total-summary-cell')) return; let text = getCleanCellText(th); html += `<th>${text}</th>`; tsv += text + "\t"; });
            html += "</tr></thead><tbody>"; tsv += "\n";
            cbs.forEach(cb => { const tr = cb.closest('tr'); html += "<tr>"; let rowData = []; tr.querySelectorAll('td').forEach(td => { if(td.classList.contains('week-summary-cell') || td.classList.contains('total-summary-cell')) return; let text = getCleanCellText(td); html += `<td>${text}</td>`; rowData.push(text); }); html += "</tr>"; tsv += rowData.join("\t") + "\n"; });
            html += "</tbody></table>";
            navigator.clipboard.write([new ClipboardItem({ "text/html": new Blob([html], { type: "text/html" }), "text/plain": new Blob([tsv], { type: "text/plain" }) })]).then(() => { let oldText = btn.innerHTML; btn.innerHTML = "âœ… KOPYALANDI"; btn.style.background = "#10b981"; setTimeout(() => { btn.innerHTML = oldText; btn.style.background = "#0ea5e9"; }, 2000); });
        }

        function cleanExcelRows(raw) { let rows = raw.split("\n").filter(r => r.trim() !== ""); while (rows.length > 0) { let rText = rows[0].toUpperCase(); let cols = rows[0].split("\t"); if (rText.includes("PERSONEL") || rText.includes("AD SOYAD") || rText.match(/\b(PZT|SAL|Ã‡AR|PER|CUM|CMT|PAZ)\b/) || rText.includes("S | G") || rText.includes("TOPLAM") || cols.every(val => val.trim() === "" || val.trim().match(/^[0-9]{1,2}\.[0-9]{1,2}/) || val.trim().match(/^[0-9]+$/))) { rows.shift(); } else break; } return rows; }

        async function pasteToTableRows(btn) {
            const wrapper = btn.closest('.table-wrapper'); const cbs = wrapper.querySelectorAll('tbody .row-checkbox:checked');
            try { const text = await navigator.clipboard.readText(); if(!text) return; saveHistory();
                const rows = cleanExcelRows(text); const startDt = new Date(wrapper.getAttribute("data-startdt")); const colCount = parseInt(wrapper.getAttribute("data-colcount")); let tbody = wrapper.querySelector('tbody'); let existingNames = Array.from(tbody.querySelectorAll('.editable-name')).map(el => el.innerText.trim());
                
                if(rows.length === 1 && rows[0].split('\t').length === 1 && cbs.length > 0) {
                    let val = rows[0].trim();
                    cbs.forEach(cb => { 
                        const tr = cb.closest('tr');
                        tr.querySelectorAll('.shift-cell').forEach(td => {
                            let oldPin = td.getAttribute("data-pin"); 
                            td.innerText = val; 
                            if(oldPin) td.setAttribute("data-pin", oldPin); 
                            let r = shiftRules[val] || keyMatchesVal(val); 
                            td.style.background = r ? r.color : "transparent";
                        });
                    });
                    updateAllStats(); logAction("Tabloya veri yapÄ±ÅŸtÄ±rdÄ±."); let oldText = btn.innerHTML; btn.innerHTML = "âœ… YAPIÅTIRILDI"; btn.style.background = "#10b981"; setTimeout(() => { btn.innerHTML = oldText; btn.style.background = "#a855f7"; }, 2000);
                    return;
                }
                
                if(cbs.length > 0) {
                    let rowIndex = 0;
                    cbs.forEach(cb => { if(rowIndex >= rows.length) return; const tr = cb.closest('tr'); const cols = rows[rowIndex].split("\t"); let colIndex = 0; tr.querySelectorAll('td').forEach(td => { if(td.classList.contains('week-summary-cell') || td.classList.contains('total-summary-cell')) return; if(colIndex < cols.length) { let val = cols[colIndex].trim(); if(td.querySelector('.editable-name') && val !== "") td.querySelector('.editable-name').innerText = val; else if(td.classList.contains('shift-cell')) { let oldPin = td.getAttribute("data-pin"); td.innerText = val; if(oldPin) td.setAttribute("data-pin", oldPin); const r = shiftRules[val] || keyMatchesVal(val); td.style.background = r ? r.color : "transparent"; } } colIndex++; }); rowIndex++; });
                } else {
                    if(existingNames.length === 1 && existingNames[0] === "Ä°SÄ°M GÄ°RÄ°NÄ°Z...") { tbody.innerHTML = ""; } 
                    rows.forEach(row => { const cols = row.split("\t"); let name = cols[0] ? cols[0].trim() : "Ä°SÄ°M GÄ°RÄ°NÄ°Z..."; let shifts = cols.slice(1).map(s => { return { text: s ? s.trim() : "", bg: "transparent" } }); const newRowHtml = createRowHtml(name, colCount, startDt, shifts); tbody.insertAdjacentHTML('beforeend', newRowHtml); });
                } updateAllStats(); logAction("Tabloya veri yapÄ±ÅŸtÄ±rdÄ±."); let oldText = btn.innerHTML; btn.innerHTML = "âœ… YAPIÅTIRILDI"; btn.style.background = "#10b981"; setTimeout(() => { btn.innerHTML = oldText; btn.style.background = "#a855f7"; }, 2000);
            } catch (err) { alert("TarayÄ±cÄ± panodan okuma izni vermedi! 'EXCEL'DEN KUTUYA AL' butonunu kullanabilirsiniz."); }
        }

        function exportTableToExcel(btn) {
            const wrapper = btn.closest('.table-wrapper'); const table = wrapper.querySelector('table'); let html = "<table border='1'>"; let tsv = "";
            table.querySelectorAll("tr").forEach(tr => { html += "<tr>"; let rowData = []; tr.querySelectorAll("th, td").forEach(cell => { if(cell.classList.contains('week-summary-cell') || cell.classList.contains('total-summary-cell')) return; let text = getCleanCellText(cell); html += `<td>${text}</td>`; rowData.push(text); }); html += "</tr>"; tsv += rowData.join("\t") + "\n"; }); html += "</table>";
            navigator.clipboard.write([new ClipboardItem({ "text/html": new Blob([html], { type: "text/html" }), "text/plain": new Blob([tsv], { type: "text/plain" }) })]).then(() => { alert("Tablo Puantaj Sistemine uygun formatta kopyalandÄ±! ğŸ“¤"); logAction("Tabloyu Excel'e (Puantaja) kopyaladÄ±."); });
        }

        function deleteTableRows(btn) { const wrapper = btn.closest('.table-wrapper'); const cbs = wrapper.querySelectorAll('tbody .row-checkbox:checked'); if(cbs.length === 0) return alert("Silinecek satÄ±rlarÄ± seÃ§in!"); if(confirm(cbs.length + " satÄ±rÄ± silmek istiyor musunuz?")) { saveHistory(); cbs.forEach(cb => cb.closest('tr').remove()); updateAllStats(); logAction("Tablodan satÄ±r sildi."); } }
        function calcTable(btn) { updateAllStats(); let old = btn.innerHTML; btn.innerHTML = "âœ… HESAPLANDI"; setTimeout(() => btn.innerHTML = old, 1000); }
        function closeTable(btn) { if(confirm("Bu matrisi ekrandan silmek istediÄŸinize emin misiniz?")) { btn.closest('.table-wrapper').remove(); saveHistory(); if(document.querySelectorAll('.table-wrapper').length === 0) { closeTableModal(); } } }

        function addTableWithSameStaff(btn) { const wrapper = btn.closest('.table-wrapper'); let staffNames = Array.from(wrapper.querySelectorAll('.editable-name')).map(el => el.innerText.trim()); if(staffNames.length === 0) return alert("Bu tabloda hiÃ§ personel yok!"); let d = prompt("KaÃ§ gÃ¼nlÃ¼k yeni bir tablo oluÅŸturulsun?", "30"); if(!d) return; let c = parseInt(d); let currentStart = new Date(wrapper.getAttribute("data-startdt")); let nextMonth = new Date(currentStart.getFullYear(), currentStart.getMonth() + 1, 1); let nextMonthStr = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth()+1).padStart(2,'0')}-${String(nextMonth.getDate()).padStart(2,'0')}`; let s = prompt("BaÅŸlangÄ±Ã§ tarihi (YÄ±l-Ay-GÃ¼n formatÄ±nda):", nextMonthStr); if(!s) return; generateTable(false, staffNames, "Yeni Tablo", new Date(s), c, wrapper); }
        function addGlobalBlankTable() { let cols = parseInt(document.getElementById("colCount").value) || 30; let startDateVal = document.getElementById("startDate").value || new Date().toISOString().split('T')[0]; generateTable(false, ["Ä°SÄ°M GÄ°RÄ°NÄ°Z..."], "Yeni Tablo", new Date(startDateVal), cols); logAction("Yeni boÅŸ tablo ekledi."); }
        function renameMasterArchive() { let mName = prompt("Panodaki Ana KlasÃ¶r AdÄ± (Ã–rn: Acil Servis):", currentMasterArchiveName); if(mName && mName.trim() !== "") { currentMasterArchiveName = mName.trim(); document.getElementById("masterArchiveTitle").innerText = "ğŸ“ " + currentMasterArchiveName; } }

        function saveMasterArchive() {
            if(!currentMasterArchiveId || document.getElementById("masterArchiveTitle").innerText.includes("Yeni Dosya")) { let mName = prompt("Panoda (ArÅŸivde) gÃ¶rÃ¼necek ANA KLASÃ–R adÄ±nÄ± girin (Ã–rn: Acil Servis):", "Vardiya KlasÃ¶rÃ¼"); if(!mName) return; currentMasterArchiveName = mName.trim(); document.getElementById("masterArchiveTitle").innerText = "ğŸ“ " + currentMasterArchiveName; }
            const tables = document.querySelectorAll('.table-wrapper'); if(tables.length === 0) return alert("Kaydedilecek hiÃ§bir tablo yok!");
            const tablesData = [];
            tables.forEach((wrapper, index) => {
                let tName = wrapper.getAttribute("data-tablename");
                if(tName === "Yeni Liste" || tName === "Yeni Tablo" || tName === "Ä°Ã§e AktarÄ±lan Liste") { let pName = prompt((index+1) + ". Tablonun adÄ±nÄ± belirleyin (Ã–rn: Doktorlar):", tName); if(pName && pName.trim() !== "") { tName = pName.trim(); wrapper.setAttribute("data-tablename", tName); wrapper.querySelector('.table-title').innerHTML = `ğŸ“Œ ${tName} <span style="font-size:10px; opacity:0.6;">(DeÄŸiÅŸtirmek iÃ§in tÄ±kla)</span>`; } }
                const rowsData = [];
                wrapper.querySelectorAll("tbody tr").forEach(tr => { let name = tr.querySelector(".editable-name").innerText.trim(); let shifts = Array.from(tr.querySelectorAll(".shift-cell")).map(td => ({ text: td.innerText, bg: td.style.background, pin: td.getAttribute("data-pin") || "" })); rowsData.push({ name: name, shifts: shifts }); });
                let notesVal = wrapper.querySelector(".table-notes").value; tablesData.push({ tableName: tName, startDate: wrapper.getAttribute("data-startdt"), colCount: wrapper.getAttribute("data-colcount"), data: rowsData, notes: notesVal });
            });
            const saveData = { name: currentMasterArchiveName, date: new Date().toLocaleString('tr-TR'), tables: tablesData };
            if(currentMasterArchiveId) { db.ref("arsivlenmis_shiftler").child(currentMasterArchiveId).update(saveData); } else { const ref = db.ref("arsivlenmis_shiftler").push(); ref.set(saveData); currentMasterArchiveId = ref.key; }
            logAction(`'${currentMasterArchiveName}' klasÃ¶rÃ¼nÃ¼ kaydetti.`);
            alert(`ğŸ’¾ TÃ¼m Tablolar baÅŸarÄ±yla '${currentMasterArchiveName}' iÃ§ine kaydedildi!`);
        }

        function openExcelModalForTable(btn) { currentTargetTable = btn.closest('.table-wrapper'); document.getElementById("excelModalTitle").innerText = "ğŸ“¥ Bu Tabloya Veri Ekle"; document.getElementById("excelModal").style.display = "flex"; document.getElementById("excelInput").value = ""; setTimeout(() => document.getElementById("excelInput").focus(), 100); }
        function openExcelModal() { startNewSession(); currentTargetTable = null; document.getElementById("excelModalTitle").innerText = "ğŸ“¥ SÄ±fÄ±r Tablo OluÅŸtur"; document.getElementById("excelModal").style.display = "flex"; document.getElementById("excelInput").value = ""; setTimeout(() => document.getElementById("excelInput").focus(), 100); }
        function closeExcelModal() { document.getElementById("excelModal").style.display = "none"; }
        
        function importFromExcel() { 
            saveHistory(); const raw = document.getElementById("excelInput").value; if(!raw) return alert("Veri yapÄ±ÅŸtÄ±rÄ±lmadÄ±!"); 
            const rows = cleanExcelRows(raw); 
            const parsed = rows.map(row => { const p = row.split("\t"); return { name: p[0] ? p[0].trim() : "Ä°SÄ°M GÄ°RÄ°NÄ°Z...", shifts: p.slice(1).map(s => { let text = s ? s.trim() : ""; let r = shiftRules[text] || keyMatchesVal(text); let bg = r ? r.color : "transparent"; return { text: text, bg: bg }; })}; }); 
            if(currentTargetTable) {
                const startDt = new Date(currentTargetTable.getAttribute("data-startdt")); const colCount = parseInt(currentTargetTable.getAttribute("data-colcount")); let tbody = currentTargetTable.querySelector('tbody'); let existingNames = Array.from(tbody.querySelectorAll('.editable-name')).map(el => el.innerText.trim());
                if(existingNames.length === 1 && existingNames[0] === "Ä°SÄ°M GÄ°RÄ°NÄ°Z...") { tbody.innerHTML = ""; } 
                parsed.forEach(p => { const newRowHtml = createRowHtml(p.name, colCount, startDt, p.shifts); tbody.insertAdjacentHTML('beforeend', newRowHtml); }); updateAllStats();
            } else { if(parsed.length > 0 && parsed[0].shifts.length > 0) { document.getElementById("colCount").value = parsed[0].shifts.length; } generateTable(true, parsed, "Ä°Ã§e AktarÄ±lan Liste"); }
            logAction("Excel'den sisteme veri Ã§ekti."); closeExcelModal(); document.getElementById("excelInput").value = "";
        }

        function toggleAllRows(cb) { const table = cb.closest('table'); table.querySelectorAll('.row-checkbox').forEach(c => { if(c !== cb) c.checked = cb.checked; }); }
        function keyMatchesVal(val) { for(let k in shiftRules) { if(k.replace(/\s/g,'') === val.replace(/\s/g,'') || (val !== "" && k.includes(val))) return shiftRules[k]; } return null; }

        function updateAllStats() {
            document.querySelectorAll("table tbody tr").forEach(row => {
                const cells = Array.from(row.querySelectorAll("td")); let hW=0, hN=0, aW=0, aN=0;
                cells.forEach(td => {
                    if(td.classList.contains("shift-cell")) {
                        const val = td.innerText.trim(); let r = shiftRules[val]; 
                        if(r) { td.style.background = r.color; hW += r.w; hN += r.n; aW += r.w; aN += r.n; } else if(td.hasAttribute("data-custom-w")) { hW += parseFloat(td.getAttribute("data-custom-w")) || 0; hN += parseFloat(td.getAttribute("data-custom-n")) || 0; aW += hW; aN += hN; } else { td.style.background = "transparent"; }
                    }
                    if(td.classList.contains("week-summary-cell")) { td.innerHTML = `<div class="stat-sub">${hW}</div><div class="stat-sub" style="color:var(--warning)">${hN}</div>`; hW=0; hN=0; }
                    if(td.classList.contains("total-summary-cell")) { td.innerHTML = `<div class="stat-sub">${aW}</div><div class="stat-sub" style="color:var(--warning)">${aN}</div>`; }
                });
            });
        }

        function moveRow(btn, dir) { saveHistory(); const row = btn.closest('tr'); if(dir===-1 && row.previousElementSibling) row.parentNode.insertBefore(row, row.previousElementSibling); else if(dir===1 && row.nextElementSibling) row.parentNode.insertBefore(row.nextElementSibling, row); }
        function setShift(v, c) { if(activeCell) { saveHistory(); activeCell.innerText = v; activeCell.style.background = v==="" ? "transparent" : c; updateAllStats(); if(v!=="") logAction(`Bir hÃ¼creye '${v}' yazdÄ±.`); } document.getElementById("contextMenu").style.display = "none"; }
        
        function setAdjustableShift() {
            if(!activeCell) return; let label = prompt("Vardiya etiketini girin (Ã–rn: 09:00-15:00):"); if(!label) return;
            let workHours = prompt("Toplam Ã§alÄ±ÅŸma saati (SayÄ± girin, Ã–rn: 6):", "7.5"); let nightHours = prompt("Gece Ã§alÄ±ÅŸma saati (Varsa girin, Ã–rn: 2):", "0");
            if(label && !isNaN(workHours)) { saveHistory(); activeCell.innerText = label; activeCell.style.background = "linear-gradient(145deg, #475569, #1e293b)"; activeCell.setAttribute("data-custom-w", workHours); activeCell.setAttribute("data-custom-n", nightHours); updateAllStats(); logAction(`Ayarlanabilir saat girdi: ${label}`); }
            document.getElementById("contextMenu").style.display = "none";
        }  
        
        function openStaffQuickMenu(e, btn) { e.preventDefault(); e.stopPropagation(); activeCell = btn.previousElementSibling; const m = document.getElementById("staffSelectMenu"); m.innerHTML = ""; const poolNames = Array.from(document.querySelectorAll("#staffPool input")).map(i => i.value); poolNames.forEach(n => { const d = document.createElement("div"); d.className = "menu-item"; d.innerText = n; d.onclick = () => { saveHistory(); activeCell.innerText = n; m.style.display = "none"; }; m.appendChild(d); }); m.style.display = "block"; m.style.left = e.pageX + "px"; m.style.top = e.pageY + "px"; }

        function loadArchives() { 
            db.ref("arsivlenmis_shiftler").on("value", snap => { 
                const l = document.getElementById("archiveList"); l.innerHTML = ""; const data = snap.val(); 
                if(data) { Object.entries(data).reverse().forEach(([id, val]) => { 
                    let tableCount = val.tables ? val.tables.length : 1; const div = document.createElement("div"); div.className = "archive-card"; 
                    div.innerHTML = `<div style="flex:1" onclick="openArchive('${id}', '${val.name.replace(/'/g,"\\'")}')"><b style="color:var(--accent); font-size:15px;">ğŸ“ ${val.name}</b><br><small style="color:#94a3b8; font-size:10px;">${val.date} | <b>${tableCount}</b> Tablo Ä°Ã§eriyor</small></div><div style="display:flex; flex-direction:column; gap:5px; margin-left:10px;"><button class="btn" style="background:var(--warning); color:#000; padding:4px 8px; font-size:10px; justify-content:center;" onclick="renameArchive(event, '${id}', '${val.name.replace(/'/g,"\\'")}')">âœï¸ KLASÃ–R ADI</button><button class="btn" style="background:transparent; color:var(--danger); border:1px solid var(--danger); padding:4px 8px; font-size:10px; justify-content:center;" onclick="delArchive(event, '${id}')">ğŸ—‘ï¸ SÄ°L</button></div>`; l.appendChild(div); 
                }); } 
            }); 
        }
        function delArchive(e, id) { e.stopPropagation(); if(confirm("TÃ¼m klasÃ¶rÃ¼ ve iÃ§indeki tablolarÄ± kalÄ±cÄ± olarak silmek istediÄŸine emin misin?")) { db.ref("arsivlenmis_shiftler").child(id).remove(); logAction("ArÅŸivden bir klasÃ¶r sildi."); } }
        function renameArchive(e, id, oldName) { e.stopPropagation(); let newName = prompt("KlasÃ¶rÃ¼n yeni adÄ±nÄ± girin:", oldName); if (newName && newName.trim() !== "" && newName !== oldName) { db.ref("arsivlenmis_shiftler").child(id).update({name: newName.trim()}); } }
        
        function openArchive(id, name) { 
            db.ref("arsivlenmis_shiftler").child(id).once("value", snap => {
                const val = snap.val(); currentMasterArchiveId = id; currentMasterArchiveName = name;
                document.getElementById("masterArchiveTitle").innerText = "ğŸ“ " + name; document.getElementById("tablesContainer").innerHTML = ""; 
                if(val.tables) { val.tables.forEach(t => { generateTable(true, t.data, t.tableName, new Date(t.startDate), t.colCount, null, t.notes || ""); }); } else if(val.data) { generateTable(true, val.data, val.name, new Date(val.startDate), val.colCount); }
                logAction(`'${name}' klasÃ¶rÃ¼nÃ¼ aÃ§tÄ±.`);
            });
        }
        function openShiftMenu(e, c) { e.preventDefault(); activeCell = c; const m = document.getElementById("contextMenu"); m.style.display = "block"; m.style.left = e.pageX + "px"; m.style.top = e.pageY + "px"; }

        function saveHistory() { const cont = document.getElementById("tablesContainer").innerHTML; history.push(cont); if(history.length > 25) history.shift(); }
        function undo() { if(history.length > 0) { document.getElementById("tablesContainer").innerHTML = history.pop(); updateAllStats(); } }
        document.addEventListener('keydown', e => { if (e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); } });
        function generateTableFromSelected() { const sel = Array.from(document.querySelectorAll("#staffPool input:checked")).map(cb => cb.value); if(sel.length===0) return alert("LÃ¼tfen havuzdan personel seÃ§in!"); startNewSession(); generateTable(false, sel, "Yeni Tablo"); logAction("Havuzdan seÃ§erek yeni tablo oluÅŸturdu."); }

        let isDraggingCells = false; let startSelectCell = null;
        document.addEventListener('mousedown', e => {
            if(e.button !== 0) return; if(e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return; 
            const cell = e.target.closest('td, th');
            if(cell && cell.closest('table')) { isDraggingCells = true; startSelectCell = cell; document.querySelectorAll('.selected-cell').forEach(c => c.classList.remove('selected-cell')); cell.classList.add('selected-cell'); if (cell.classList.contains('shift-cell')) activeCell = cell; } 
            else if (!e.target.closest('td') && !e.target.closest('th') && !e.target.closest('.custom-menu') && !e.target.closest('.btn')) { document.querySelectorAll('.selected-cell').forEach(c => c.classList.remove('selected-cell')); }
        });
        document.addEventListener('mouseover', e => { if(isDraggingCells) { const cell = e.target.closest('td, th'); if(cell && cell.closest('table') === startSelectCell.closest('table')) selectCellRange(startSelectCell, cell); } });
        document.addEventListener('mouseup', () => { isDraggingCells = false; });
        document.addEventListener('selectstart', e => { if(isDraggingCells) e.preventDefault(); }); 
        
        function selectCellRange(start, end) {
            document.querySelectorAll('.selected-cell').forEach(c => c.classList.remove('selected-cell'));
            const table = start.closest('table'); const rows = Array.from(table.querySelectorAll('tr')); const startRowIdx = rows.indexOf(start.closest('tr')); const endRowIdx = rows.indexOf(end.closest('tr')); const startColIdx = Array.from(start.closest('tr').querySelectorAll('th, td')).indexOf(start); const endColIdx = Array.from(end.closest('tr').querySelectorAll('th, td')).indexOf(end);
            const minRow = Math.min(startRowIdx, endRowIdx); const maxRow = Math.max(startRowIdx, endRowIdx); const minCol = Math.min(startColIdx, endColIdx); const maxCol = Math.max(startColIdx, endColIdx);
            for(let r = minRow; r <= maxRow; r++) { const trCells = Array.from(rows[r].querySelectorAll('th, td')); for(let c = minCol; c <= maxCol; c++) { if(trCells[c]) trCells[c].classList.add('selected-cell'); } }
        }

        document.addEventListener('copy', e => {
            const selected = document.querySelectorAll('.selected-cell');
            if(selected.length > 0) { 
                e.preventDefault(); let html = "<table border='1'>"; let tsv = ""; let currentRow = null; let rowData = []; let trHtml = "";
                selected.forEach(cell => { 
                    if(cell.classList.contains('week-summary-cell') || cell.classList.contains('total-summary-cell')) return; 
                    const cellRow = cell.closest('tr'); 
                    if(currentRow !== cellRow) { 
                        if(currentRow !== null) { tsv += rowData.join("\t") + "\n"; html += trHtml + "</tr>"; rowData = []; } 
                        currentRow = cellRow; trHtml = "<tr>"; 
                    } 
                    let text = getCleanCellText(cell); 
                    trHtml += `<td>${text}</td>`; 
                    rowData.push(text); 
                });
                if(rowData.length > 0) { tsv += rowData.join("\t"); html += trHtml + "</tr>"; } html += "</table>";
                e.clipboardData.setData('text/html', html); e.clipboardData.setData('text/plain', tsv);
            }
        });

        document.addEventListener('paste', e => {
            const selectedCells = document.querySelectorAll('.selected-cell'); const targetCell = selectedCells.length > 0 ? selectedCells[0] : activeCell;
            if(document.activeElement && (document.activeElement.classList.contains('shift-cell') || document.activeElement.classList.contains('editable-name')) && selectedCells.length <= 1) { const pastedData = (e.clipboardData || window.clipboardData).getData('text'); if(!pastedData.includes('\t') && !pastedData.includes('\n')) return; }
            if(targetCell && (targetCell.classList.contains('shift-cell') || targetCell.closest('td'))) {
                e.preventDefault(); saveHistory(); const pastedData = (e.clipboardData || window.clipboardData).getData('text');
                const rows = cleanExcelRows(pastedData); 
                
                if (rows.length === 1 && rows[0].split('\t').length === 1 && selectedCells.length > 1) {
                    let val = rows[0].trim();
                    selectedCells.forEach(cell => {
                        if(cell.classList.contains('shift-cell')) {
                            let oldPin = cell.getAttribute("data-pin"); 
                            cell.innerText = val; 
                            if(oldPin) cell.setAttribute("data-pin", oldPin); 
                            let r = shiftRules[val] || keyMatchesVal(val); 
                            cell.style.background = r ? r.color : "transparent";
                        }
                    });
                    updateAllStats(); logAction("Ã‡oklu hÃ¼creye veri yapÄ±ÅŸtÄ±rdÄ±.");
                    return;
                }

                const table = targetCell.closest('table'); const tableRows = Array.from(table.querySelectorAll('tr')); const startRowIdx = tableRows.indexOf(targetCell.closest('tr')); 
                let validCellsInStartRow = Array.from(targetCell.closest('tr').querySelectorAll('th, td')).filter(c => !c.classList.contains('week-summary-cell') && !c.classList.contains('total-summary-cell')); let startValidColIdx = validCellsInStartRow.indexOf(targetCell); if(startValidColIdx === -1) startValidColIdx = 0;
                for(let i = 0; i < rows.length; i++) { const cols = rows[i].split('\t'); const targetTr = tableRows[startRowIdx + i]; if(!targetTr) break; let validCells = Array.from(targetTr.querySelectorAll('th, td')).filter(c => !c.classList.contains('week-summary-cell') && !c.classList.contains('total-summary-cell')); for(let j = 0; j < cols.length; j++) { const cell = validCells[startValidColIdx + j]; if(!cell) break; let val = cols[j].trim(); if(cell.querySelector('.editable-name')) cell.querySelector('.editable-name').innerText = val; else if(cell.classList.contains('shift-cell')) { let oldPin = cell.getAttribute("data-pin"); cell.innerText = val; if(oldPin) cell.setAttribute("data-pin", oldPin); let r = shiftRules[val] || keyMatchesVal(val); cell.style.background = r ? r.color : "transparent"; } } } updateAllStats(); logAction("Tablo iÃ§ine veri yapÄ±ÅŸtÄ±rdÄ±.");
            }
        });

        window.onclick = (e) => { if(!e.target.closest('.custom-menu') && !e.target.closest('.select-icon')) { document.getElementById("contextMenu").style.display = "none"; document.getElementById("staffSelectMenu").style.display = "none"; } };
        window.onload = () => {
            const text = "SHIFTMASTER"; const container = document.getElementById("splashTextContainer");
            text.split("").forEach((char, index) => { const span = document.createElement("span"); span.innerText = char; span.className = "splash-char"; span.style.animationDelay = (0.5 + (index * 0.1)) + "s"; container.appendChild(span); });
            setTimeout(() => { document.getElementById('splash').style.opacity = '0'; setTimeout(() => { document.getElementById('splash').style.display = 'none'; document.getElementById('lockScreen').style.display = 'flex'; }, 1000); }, 3500);
            document.getElementById('startDate').valueAsDate = new Date();
        };
    </script>
    <style>
    /* ShiftMaster temasÄ±na uygun ÅŸÄ±k, cam efektli tasarÄ±m */
    .sm-player {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid #3b82f6;
        border-radius: 50px;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        color: white;
        z-index: 9999;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        font-family: 'Segoe UI', sans-serif;
        transition: all 0.3s ease;
    }
    .sm-player:hover { border-color: #f59e0b; box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3); }
    .sm-btn {
        background: none; border: none; color: #3b82f6; 
        font-size: 1.2rem; cursor: pointer; transition: 0.2s;
        display: flex; align-items: center; justify-content: center;
    }
    .sm-btn:hover { color: #f59e0b; transform: scale(1.2); }
    .sm-track-info {
        display: flex; flex-direction: column;
    }
    .sm-title { font-size: 0.85rem; font-weight: bold; color: #f3f4f6; width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sm-status { font-size: 0.7rem; color: #10b981; }
    /* MÃ¼zik Ã§alarken beliren ses dalgasÄ± animasyonu */
    .equalizer { display: none; gap: 2px; height: 15px; align-items: flex-end; }
    .equalizer.active { display: flex; }
    .bar { width: 3px; background: #10b981; animation: eq 1s infinite ease-in-out alternate; }
    .bar:nth-child(2) { animation-delay: 0.2s; }
    .bar:nth-child(3) { animation-delay: 0.4s; }
    @keyframes eq { 0% { height: 3px; } 100% { height: 15px; } }
</style>

<div class="sm-player" id="sm-player">
    <button class="sm-btn" onclick="smMusic.prev()" title="Ã–nceki">â®</button>
    <button class="sm-btn" onclick="smMusic.toggle()" id="sm-play-btn" style="font-size: 1.5rem;" title="Oynat/Durdur">â–¶</button>
    <button class="sm-btn" onclick="smMusic.next()" title="Sonraki">â­</button>
    
    <div class="sm-track-info">
        <span class="sm-title" id="sm-title">ShiftMaster Radyo</span>
        <span class="sm-status" id="sm-status">Sistem Bekleniyor...</span>
    </div>

    <div class="equalizer" id="sm-eq">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
</div>

<script>
    const smMusic = {
        audio: new Audio(),
        isPlaying: false,
        index: 0,
        // BURAYA Ä°STEDÄ°ÄÄ°N ÅARKILARIN Ä°NTERNET LÄ°NKLERÄ°NÄ° KOYABÄ°LÄ°RSÄ°N
        // Åimdilik test iÃ§in telifsiz dinlendirici radyolar/mÃ¼zikler ekledim.
        playlist: [
            // Ä°ÅTE SENÄ°N GÃœNÃœN BOMBASI (1. SIRADA)
            { name: "Hee Hee Haa Haa ğŸ˜‚", url: "https://umityigit.github.io/shiftmaster/hee-hee-haa-haa.mp3" }, 
            
            // DÄ°ÄER SAKÄ°N RADYOLAR
            { name: "Ã‡alÄ±ÅŸma Modu (Lofi)", url: "https://stream.zeno.fm/f3wvbbqmdg8uv" }, 
            { name: "Odaklanma (Piyano)", url: "https://stream.zeno.fm/8q7v1b1m8x8uv" }, 
            { name: "Hareketli BaÅŸlangÄ±Ã§", url: "https://stream.zeno.fm/0r0xa792kwzuv" }  
        ],

        init() {
            this.audio.src = this.playlist[this.index].url;
            this.audio.volume = 0.5; // Ses seviyesi %50 (Hastanede rahatsÄ±z etmesin diye)
            document.getElementById('sm-title').innerText = this.playlist[this.index].name;
            
            // ÅarkÄ± bitince diÄŸerine geÃ§
            this.audio.onended = () => this.next();
        },

        toggle() {
            if (this.isPlaying) this.pause();
            else this.play();
        },

        play() {
            this.audio.play().then(() => {
                this.isPlaying = true;
                document.getElementById('sm-play-btn').innerText = "â¸";
                document.getElementById('sm-status').innerText = "OynatÄ±lÄ±yor";
                document.getElementById('sm-status').style.color = "#10b981";
                document.getElementById('sm-eq').classList.add('active');
            }).catch(e => console.log("Otomatik Ã§alma engellendi, kullanÄ±cÄ± tÄ±klamasÄ± bekleniyor."));
        },

        pause() {
            this.audio.pause();
            this.isPlaying = false;
            document.getElementById('sm-play-btn').innerText = "â–¶";
            document.getElementById('sm-status').innerText = "DuraklatÄ±ldÄ±";
            document.getElementById('sm-status').style.color = "#f59e0b";
            document.getElementById('sm-eq').classList.remove('active');
        },

        next() {
            this.index = (this.index + 1) % this.playlist.length;
            this.changeTrack();
        },

        prev() {
            this.index = (this.index - 1 + this.playlist.length) % this.playlist.length;
            this.changeTrack();
        },

        changeTrack() {
            this.audio.src = this.playlist[this.index].url;
            document.getElementById('sm-title').innerText = this.playlist[this.index].name;
            if (this.isPlaying) this.play();
        },
        
        // Bu fonksiyonu ShiftMaster'Ä±n "GiriÅŸ Yap" butonunun iÃ§ine ekleyebilirsin
        loginTrigger() {
            if(!this.isPlaying) {
                this.play();
            }
        }
    };

    // Sistemi hazÄ±rla
    smMusic.init();
</script>
</body>
</html>


