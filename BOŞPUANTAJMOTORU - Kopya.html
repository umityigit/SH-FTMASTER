<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEMÄ°ZLÄ°K BÄ°RÄ°MÄ° PUANTAJ SÄ°STEMÄ° v115 (BULUT & TC DESTEKLÄ°)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --green: #27ae60; --orange: #e67e22; --red: #c0392b; --blue: #2980b9; --dark: #1a252f; }
        body { margin: 0; background: #eef2f5; font-family: 'Roboto', sans-serif; }

        /* GÄ°RÄ°Å */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #loginBox { background: white; padding: 40px; border-radius: 10px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 320px; position: relative; }
        .prod-by { margin-top: 15px; font-size: 10px; color: #7f8c8d; font-weight: bold; letter-spacing: 1px; }

        /* ANA PANEL */
        #mainContent { display: none; padding-bottom: 50px; }
        .panel-container { background: white; padding: 15px; width: 98%; margin: 10px auto; border-radius: 10px; display: flex; gap: 15px; flex-wrap: wrap; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 5px solid var(--blue); }
        .panel-col { flex: 1; min-width: 280px; display: flex; flex-direction: column; gap: 8px; position: relative; }
        
        h3 { margin: 0; font-size: 14px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: var(--primary); text-transform: uppercase; cursor: text; transition: 0.2s;}
        h3:hover { background: #f0f8ff; }
        h3:focus { outline: 2px solid var(--blue); background: #fff; }

        .personel-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .modern-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; box-sizing: border-box;}
        .personel-listesi { height: 180px; overflow-y: auto; border: 1px solid #ddd; background: #fff; padding: 5px; border-radius: 5px; }
        .personel-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; border-bottom: 1px solid #f0f0f0; font-size: 11px; }
        
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-add { background: var(--green); padding: 5px 10px; }
        .btn-del { background: var(--red); padding: 2px 6px; font-size: 10px; }
        .btn-del-group { position: absolute; right: 0; top: 0; background: var(--red); padding: 2px 8px; font-size: 10px; }
        .btn-big { width: 100%; padding: 15px; font-size: 14px; margin-top: 5px; text-transform: uppercase; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn-big:active { transform: translateY(3px); box-shadow: none; }
        .btn-org { background: var(--orange); } .btn-grn { background: var(--green); } .btn-blu { background: var(--blue); }

        /* VARDÄ°YA CHIPLERÄ° */
        .vardiya-chip { display:flex; align-items:center; background:#2ecc71; color:white; padding:6px 10px; border-radius:5px; font-size:11px; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .vardiya-chip.izin { background:#e74c3c; }
        .vardiya-del { margin-left:10px; cursor:pointer; font-size:12px; transition:0.2s;}
        .vardiya-del:hover { color:#2c3e50; }

        /* TABLO VE Ã‡IKTI */
        .sayfa { background: white; width: 297mm; min-height: 200mm; margin: 0 auto 20px auto; padding: 2mm; page-break-after: always; font-family: 'Arial Narrow', sans-serif; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 7.5px; border: 1px solid #000; margin: 0; padding: 0; user-select: none; }
        
        th, td { 
            border: 1px solid #000; 
            text-align: center; 
            vertical-align: middle; 
            padding: 0px; 
            line-height: 1.1; 
            white-space: normal; 
            word-break: break-all; 
            overflow: hidden;
            position: relative;
        }
        
        .veri-hucre { font-size: 7px; font-weight: bold; height: 22px; }

        td[contenteditable="true"], th[contenteditable="true"] { cursor: text; }
        td[contenteditable="true"]:focus, th[contenteditable="true"]:focus, div[contenteditable="true"]:focus { background: #fff9c4 !important; outline: 1px solid orange; }

        /* SEÃ‡Ä°LMÄ°Å HÃœCRE STÄ°LÄ° */
        .selected-cell { background-color: #d0ebff !important; outline: 2px solid #1c7ed6 !important; z-index: 10; }
        
        /* SAÄ TIK MENÃœSÃœ EFEKTLERÄ° */
        .ctx-item { padding: 8px 15px; font-size: 13px; cursor: pointer; transition: 0.2s; font-family: 'Roboto', sans-serif; color: #333; }
        .ctx-item:hover { background-color: #f1f3f5; color: var(--blue); }

        col.c-sno { width: 16px; } col.c-tc { width: 55px; } col.c-isim { width: 85px; } col.c-gun { width: 18px; }
        th { background: #eee; padding: 2px 1px; }
        .bg-hafta { background-color: #dff0d8 !important; border-left: 1px solid #000; }
        .bg-genel { background-color: #fcf3cf !important; border-left: 1px solid #000; }
        .bg-gece { background-color: #e8daef !important; border-left: 1px solid #000; }
        .hucre-izin { background-color: #fadbd8 !important; color: #c0392b; font-weight: bold; }
        .hucre-haftasonu { background-color: #f2f2f2 !important; }
        
        .dikey-yazi { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; margin: auto; font-size: 6px; font-weight: normal; letter-spacing: -0.4px; padding: 2px 0; line-height: 1; }
        .dikey-tarih { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; margin: auto; font-size: 6px; font-weight: bold; letter-spacing: -0.2px; padding: 2px 0; line-height: 1.1; color: #111; }

        #dynamicGroups { display: flex; gap: 15px; flex-wrap: wrap; width: 100%; }

        /* EXCEL BUTONU TASARIMI */
        #btnExceleKopyala { position: fixed; bottom: 20px; right: 20px; background: #27ae60; color: white; border: none; padding: 15px 25px; border-radius: 50px; font-size: 14px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: none; z-index: 100000; transition: 0.3s; }
        #btnExceleKopyala:hover { background: #219653; transform: scale(1.05); }

        /* BULUT SENKRONÄ°ZASYON BÄ°LDÄ°RÄ°MÄ° */
        #cloudStatus { position: fixed; top: 10px; right: 10px; background: #27ae60; color: white; padding: 5px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; display: none; z-index: 999999; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        @media print {
            @page { size: A4 landscape; margin: 2mm; }
            #loginScreen, .panel-container, #tableContextMenu, #btnExceleKopyala, #cloudStatus { display: none !important; }
            #mainContent { display: block !important; }
            .sayfa { margin: 0; padding: 0; width: 100%; border: none; box-shadow: none; page-break-after: always; }
            .selected-cell { outline: none !important; background-color: inherit !important; } 
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="cloudStatus">â˜ï¸ BULUT SENKRONÄ°ZE</div>

<div id="loginScreen">
    <div id="loginBox">
        <div style="font-size:40px;">â˜ï¸</div>
        <h2>TEMÄ°ZLÄ°K BÄ°RÄ°MÄ° PUANTAJ <br><span style="font-size:12px; color:#e67e22;">(BULUT BAÄLANTILI)</span></h2>
        <input type="password" id="passInput" placeholder="Åifre: 1234" style="width:100%; padding:10px; text-align:center;">
        <button onclick="sifreKontrol()" style="background:var(--blue); width:100%; padding:12px; margin-top:10px;">GÄ°RÄ°Å YAP</button>
        <div class="prod-by">PROD.BY. UMIT ABI 2026</div>
    </div>
</div>

<div id="mainContent">
    <div class="panel-container" style="border-top-color: var(--orange);">
        <div style="width:100%; padding-bottom:5px; border-bottom:2px solid #eee; margin-bottom:10px;">
            <h3 style="border:none; padding:0; display:inline-block; color:var(--orange);">VARDÄ°YA YÃ–NETÄ°MÄ° (Ayarlar)</h3>
            <span style="font-size:10px; color:#666; margin-left:10px;">Excel'de olan veya elle gireceÄŸiniz vardiyalarÄ±n Ã§alÄ±ÅŸma saatlerini buradan belirleyin.</span>
        </div>
        <div style="width:100%; display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
            <div style="flex:2; min-width: 150px;">
                <label style="font-size:10px; font-weight:bold;">Vardiya AdÄ± / Kodu</label>
                <input type="text" id="vAd" class="modern-input" placeholder="Ã–rn: 08:00-20:00 veya NÄ°">
            </div>
            <div style="flex:1; min-width: 80px;">
                <label style="font-size:10px; font-weight:bold;">Toplam Saat</label>
                <input type="number" id="vSaat" class="modern-input" placeholder="Ã–rn: 11" step="0.5">
            </div>
            <div style="flex:1; min-width: 80px;">
                <label style="font-size:10px; font-weight:bold;">Gece Saati</label>
                <input type="number" id="vGece" class="modern-input" placeholder="Ã–rn: 0" step="0.5">
            </div>
            <div style="flex:1.5; min-width: 120px;">
                <label style="font-size:10px; font-weight:bold;">TÃ¼r (Ã‡alÄ±ÅŸma/Ä°zin)</label>
                <select id="vTip" class="modern-input">
                    <option value="calisma">Ã‡alÄ±ÅŸma / Mesai</option>
                    <option value="izin">Ä°zin / Ä°stirahat</option>
                </select>
            </div>
            <div>
                <button onclick="vardiyaEkle()" class="btn-big btn-grn" style="margin:0; padding:8px 20px;">EKLE</button>
            </div>
        </div>
        <div id="vardiyaListesi" style="width:100%; display:flex; gap:8px; flex-wrap:wrap; margin-top:15px;"></div>
    </div>

    <div class="panel-container">
        <div id="dynamicGroups"></div>
        <div class="panel-col" style="flex:1; min-width: 250px; justify-content: center; align-items: center; border: 2px dashed #ccc; border-radius: 10px; padding: 20px;">
            <button onclick="yeniGrupEkle()" class="btn-big btn-blu">+ YENÄ° GRUP EKLE</button>
        </div>
        <div class="panel-col" style="flex:100%; border-top: 1px solid #eee; padding-top: 15px; margin-top: 5px;">
            <div style="display:flex; gap:10px;">
                <input type="date" id="inpTarihBas" class="modern-input" title="BaÅŸlangÄ±Ã§ Tarihi">
                <input type="date" id="inpTarihBit" class="modern-input" title="BitiÅŸ Tarihi">
                <button onclick="shiftMasterdanCek()" class="btn-big" style="background:#8b5cf6; margin:0; flex:2; color:white;">ğŸ”„ SHÄ°FTMASTER'DAN Ã‡EK</button>
                <button onclick="raporuOlustur()" class="btn-big btn-org" style="margin:0; flex:2;">MANUEL OLUÅTUR</button>
                <button onclick="window.print()" class="btn-big btn-grn" style="margin:0; flex:1;">YAZDIR</button>
            </div>
            <textarea id="inpExcel" placeholder="Excel'den kopyaladÄ±ÄŸÄ±nÄ±z vardiyalarÄ± buraya yapÄ±ÅŸtÄ±rÄ±n..." style="height:150px; margin-top: 10px;" class="modern-input"></textarea>
            <div style="margin-top: 5px; font-size: 11px; color: #e67e22; font-weight: bold;">ğŸ’¡ Ä°PUCU: Tabloda oluÅŸturulan hÃ¼creleri farenizle sÃ¼rÃ¼kleyerek seÃ§ebilir, ardÄ±ndan saÄŸ tÄ±klayarak hÃ¼creleri birleÅŸtirebilirsiniz! Hastane adÄ± ve kod kÄ±sÄ±mlarÄ±na tÄ±klayarak metinleri kendi hastanenize gÃ¶re dÃ¼zenleyebilirsiniz.</div>
        </div>
    </div>
    <div id="raporAlani"></div>
</div>

<button id="btnExceleKopyala" onclick="exceleSifirKayipsizKopyala()">ğŸ“‹ EXCEL'E KOPYALA</button>

<div id="tableContextMenu" style="display:none; position:absolute; background:white; border:1px solid #ced4da; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:99999; border-radius:5px; overflow:hidden;">
    <div class="ctx-item" onclick="mergeSelectedCells()">ğŸ”— SeÃ§ili HÃ¼creleri BirleÅŸtir</div>
    <div style="border-bottom: 1px solid #eee;"></div>
    <div class="ctx-item" onclick="unmergeSelectedCells()">âœ‚ï¸ HÃ¼cre BirleÅŸtirmesini AyÄ±r</div>
</div>

<script>
// --- FÄ°REBASE BAÄLANTISI ---
const firebaseConfig = { apiKey: "AIzaSyAAqT74kCwyr6ZULTR_ClRDJ5Iu4AhmXJQ", databaseURL: "https://shiftmaster1-7fc5f-default-rtdb.europe-west1.firebasedatabase.app", projectId: "shiftmaster1-7fc5f" };
firebase.initializeApp(firebaseConfig); const db = firebase.database();

document.addEventListener('DOMContentLoaded', function() {
    let passInput = document.getElementById('passInput');
    if (passInput) passInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') sifreKontrol(); });
    
    let bugun = new Date();
    let bas = new Date(bugun.getFullYear(), bugun.getMonth(), 15);
    let bit = new Date(bugun.getFullYear(), bugun.getMonth() + 1, 14);
    document.getElementById('inpTarihBas').value = bas.toISOString().split('T')[0];
    document.getElementById('inpTarihBit').value = bit.toISOString().split('T')[0];
    
    bulutBaglantisiniKur();
});

const DEFAULT_VARDIYALAR = { 
    "08:00-18:00":{t:9,g:0, tip:"calisma"}, "08:00-20:00":{t:11,g:0, tip:"calisma"}, "08:00-16:00":{t:7.5,g:0, tip:"calisma"}, 
    "20:00-08:00":{t:11,g:11, tip:"calisma"}, "16:00-24:00":{t:7.5,g:4, tip:"calisma"}, "24:00-08:00":{t:7.5,g:6, tip:"calisma"}, 
    "HT":{t:0,g:0, tip:"izin"}, "YÄ°":{t:0,g:0, tip:"izin"}, "R":{t:0,g:0, tip:"izin"}, "Ä°":{t:0,g:0, tip:"izin"}, 
    "NÄ°":{t:0,g:0, tip:"izin"}, "RT":{t:0,g:0, tip:"izin"}, "RTÃ‡":{t:9,g:0, tip:"calisma"} 
};

let appData = { gruplar: [], vardiyalar: null };

function sifreKontrol() {
    if(document.getElementById('passInput').value.trim() === "1234") {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
    } else alert("HATALI ÅÄ°FRE!");
}

function showCloudStatus() {
    const status = document.getElementById('cloudStatus');
    status.style.display = 'block';
    setTimeout(() => { status.style.display = 'none'; }, 2000);
}

function ilkKurulumuYap() {
    appData = { gruplar: [], vardiyalar: DEFAULT_VARDIYALAR };
    const genelListe = [
        "10006543166 - NEJLA NÄ°LÄ°", "10580422338 - TAYYÄ°P DOÄAN", "11620640910 - ZELÄ°HA ERSOY", "12547486254 - MEHMET OÄUZ DÃ–ÄÃœN", 
        "13097253044 - ORHAN KAHRAMAN", "14671540086 - GÃœLBAHAR ÃœNVER", "15097363778 - MERVE Ã–Z", "15958477590 - NAZMÄ°YE DURAN", 
        "16015509254 - SONGÃœL ERDOÄAN", "16709091126 - GÃœLLÃœ TOSUN", "16900491572 - SONGÃœL DÄ°LEK", "19589057206 - SEDA YILMAZ", 
        "19741371508 - Ã–ZLEM DURSUN", "21283980216 - ÅAHABETTÄ°N ORHAN", "22918496584 - HATÄ°CE YILDIRIM", "24475058656 - ZEYNEP BOZAN", 
        "25282186846 - BURCU DERELÄ°OÄLU", "25624852712 - SONGÃœL Ã–ZTÃœRK", "26872123876 - HURÄ°YE ELMAS", "27091143096 - KADÄ°R GAMSIZ", 
        "28543103354 - AYÅE BOZKAYA", "29386066998 - SAFÄ°YE DENECÄ°", "30163049264 - ADEM KÃ–MÃœR", "30623331236 - SADIK MACÄ°T", 
        "30937798466 - ALÄ° GENÃ‡EL", "37927835576 - HALÄ°L VAR", "40186499618 - DENÄ°Z USLU", "45925910836 - ENES ABDULLAH ALTUN", 
        "53164244964 - MAKBULE DENK", "58708122418 - MUST MUSTAFA DÄ°K", "61585026564 - FATMA Ã‡ALIÅKAN", "10588692368 - ÃœMÄ°T YÄ°ÄÄ°T", 
        "21604545568 - NUSRETTÄ°N Ã–ZSOY", "23665254878 - ÃœMMÃœ KURU", "26542158924 - HAFÄ°SE DÄ°KMEN", "29056059848 - FATMA IÅIK", 
        "30328031684 - BURAK TURAN", "32827531146 - HATÄ°CE KARAKUÅ", "00000000000 - FATMA KOÃ‡AR", "10546692058 - HAFÄ°ZE Ã–NAL", 
        "23467244800 - FUNDA POYRAZ", "62074286230 - BETÃœL ÅÄ°MÅEK"
    ];
    appData.gruplar = [{ id: "g_1", ad: "TÃœM PERSONEL (GENEL LÄ°STE)", kisiler: genelListe }];
    veriKaydet(); 
}

function bulutBaglantisiniKur() {
    // Ã–nce zorunlu geÃ§iÅŸin yapÄ±lÄ±p yapÄ±lmadÄ±ÄŸÄ±nÄ± kontrol et
    db.ref("puantaj_v115_zorunlu_gecis").once("value", snap => {
        if(!snap.val()) {
            // Ä°lk kez v115'e geÃ§iliyor, Ãœmit abinin verdiÄŸi listeyi zorla yaz!
            ilkKurulumuYap();
            db.ref("puantaj_v115_zorunlu_gecis").set(true);
            arayuzCiz(); vardiyaArayuzCiz();
        } else {
            // Zaten geÃ§iÅŸ yapÄ±lmÄ±ÅŸ, buluttan anlÄ±k Ã§ek
            db.ref("puantaj_motoru_ayarlar").on("value", snap => {
                let data = snap.val();
                if(data) {
                    appData = data;
                    if (!appData.vardiyalar) appData.vardiyalar = DEFAULT_VARDIYALAR;
                    if (!appData.gruplar) appData.gruplar = [];
                    arayuzCiz();
                    vardiyaArayuzCiz();
                    showCloudStatus();
                } else {
                    ilkKurulumuYap();
                }
            });
        }
    });
}

// ARTIK VERÄ°LER LOCALSTORAGE DEÄÄ°L DÄ°REKT FIREBASE'E YAZILIYOR
function veriKaydet() { 
    db.ref("puantaj_motoru_ayarlar").set(appData);
}

function vardiyaEkle() {
    let kod = document.getElementById("vAd").value.trim().toUpperCase();
    let t = parseFloat(document.getElementById("vSaat").value) || 0;
    let g = parseFloat(document.getElementById("vGece").value) || 0;
    let tip = document.getElementById("vTip").value;
    if(!kod) return alert("Vardiya adÄ±/kodu boÅŸ olamaz!");
    appData.vardiyalar[kod] = { t: t, g: g, tip: tip };
    veriKaydet(); 
    document.getElementById("vAd").value = ""; document.getElementById("vSaat").value = ""; document.getElementById("vGece").value = "";
}

function vardiyaSil(kod) { if(confirm(kod + " vardiyasÄ±nÄ± silmek istediÄŸinize emin misiniz?")) { delete appData.vardiyalar[kod]; veriKaydet(); } }

function vardiyaArayuzCiz() {
    const root = document.getElementById("vardiyaListesi"); root.innerHTML = "";
    for(let v in appData.vardiyalar) {
        let info = appData.vardiyalar[v];
        let cClass = info.tip === 'izin' ? 'izin' : 'calisma';
        let desc = info.tip === 'calisma' ? `(${info.t}s / G:${info.g}s)` : '(Ä°zin)';
        root.innerHTML += `<div class="vardiya-chip ${cClass}"><span>${v} ${desc}</span><span class="vardiya-del" onclick="vardiyaSil('${v}')">âœ–</span></div>`;
    }
}

function formatliVardiya(val) { if(!val) return ""; val = val.trim(); if(val.match(/\d{2}:\d{2}.*\d{2}:\d{2}/)) return val.replace(/[\s-]+/, "<br>"); return val; }
function getCleanValue(html) { if(!html) return ""; return html.replace(/<br\s*\/?>/gi, "-").replace(/&nbsp;/g, " ").replace(/<(?:.|\n)*?>/gm, '').trim().toUpperCase(); }

function getVardiyaInfo(val) {
    if (!val) return {t:0, g:0, tip:"bilinmeyen", val:""};
    let cleanVal = val.replace(/<br\s*\/?>/gi, "-").trim().toUpperCase(); 
    if (appData.vardiyalar && appData.vardiyalar[cleanVal]) return { ...appData.vardiyalar[cleanVal], val: cleanVal };
    let valWithHyphen = cleanVal.replace(/[\s\n\r]+/g, "-");
    if (appData.vardiyalar && appData.vardiyalar[valWithHyphen]) return { ...appData.vardiyalar[valWithHyphen], val: valWithHyphen };
    return {t:0, g:0, tip:"bilinmeyen", val: cleanVal};
}

function yeniGrupEkle() { appData.gruplar.push({ id: "g_" + Date.now(), ad: "YENÄ° GRUP", kisiler: [] }); veriKaydet(); }
function grupSil(id) { if (confirm("Grup silinsin mi?")) { appData.gruplar = appData.gruplar.filter(g => g.id !== id); veriKaydet(); } }
function grupAdiGuncelle(id, ad) { let g = appData.gruplar.find(g => g.id === id); if (g) { g.ad = ad.trim() || "Ä°SÄ°MSÄ°Z GRUP"; veriKaydet(); } }

function personelEkle(grupId) {
    let input = document.getElementById("add_" + grupId); let isim = input.value.trim().toUpperCase();
    let grup = appData.gruplar.find(g => g.id === grupId);
    if(!grup.kisiler) grup.kisiler = [];
    if (isim && grup && !grup.kisiler.includes(isim)) { grup.kisiler.push(isim); veriKaydet(); }
    input.value = "";
}
function personelSil(gId, isim) { if (confirm("Silinsin mi?")) { let g = appData.gruplar.find(g => g.id === gId); g.kisiler = g.kisiler.filter(k => k !== isim); veriKaydet(); } }

function arayuzCiz() {
    const container = document.getElementById("dynamicGroups"); container.innerHTML = "";
    appData.gruplar.forEach(grup => {
        let html = `
        <div class="panel-col">
            <button class="btn-del-group" onclick="grupSil('${grup.id}')" title="Grubu Sil">X</button>
            <h3 contenteditable="true" onblur="grupAdiGuncelle('${grup.id}', this.innerText)">${grup.ad}</h3>
            <div class="personel-row"><input type="text" id="add_${grup.id}" class="modern-input" placeholder="12345678912 - PERSONEL ADI..." onkeypress="if(event.key==='Enter') personelEkle('${grup.id}')"><button onclick="personelEkle('${grup.id}')" class="btn-add">+</button></div>
            <div class="personel-listesi">`;
        if(grup.kisiler) {
            grup.kisiler.sort((a,b)=>a.localeCompare(b,'tr')).forEach((isim) => {
                html += `<div class="personel-item"><span>${isim}</span><button onclick="personelSil('${grup.id}', '${isim}')" class="btn-del">X</button></div>`;
            });
        }
        container.innerHTML += html + `</div></div>`;
    });
}

function tarihGuncelle(){ let bas=new Date(document.getElementById('inpTarihBas').value); let bit=new Date(document.getElementById('inpTarihBit').value); return {bas,bit,str: `${bas.toLocaleDateString('tr-TR')} - ${bit.toLocaleDateString('tr-TR')}`}; }
function getKey(d){return d.getFullYear()+(d.getMonth()+1).toString().padStart(2,'0')+d.getDate().toString().padStart(2,'0');}
function excelTarih(s){if(!s)return null; let m=s.trim().match(/^(\d{1,2})[./](\d{1,2})[./](\d{4})$/); return m?m[3]+m[2].padStart(2,'0')+m[1].padStart(2,'0'):null;}

// ANA HESAPLAMA MOTORU
function satirHesapla(td) {
    if (!td) return;
    const tr = td.closest('tr');
    if (!tr) return;

    const rawVal = getCleanValue(td.innerHTML);
    const info = getVardiyaInfo(rawVal);
    
    const manuelSaat = parseFloat(rawVal.replace(",", "."));
    const aktifSaat = (info && info.t > 0) ? info.t : (!isNaN(manuelSaat) ? manuelSaat : 0);

    td.classList.remove('hucre-izin');
    if (aktifSaat === 0 && rawVal !== "" && rawVal !== "0") {
        td.classList.add('hucre-izin');
    }

    if (rawVal.length > 5 && rawVal.includes("-")) {
        td.innerHTML = formatliVardiya(rawVal);
    }

    let tAg = 0, n_rt = 0, n_ht = 0, n_r = 0, n_i = 0, n_rtc = 0, n_htc = 0, tAge = 0, tFM = 0;
    let wHs = 0, wHg = 0;

    const allCells = Array.from(tr.children);
    allCells.forEach(c => {
        if (c.style.display === 'none' || c.hasAttribute('data-merged-by')) return;

        if (c.classList.contains('veri-hucre') && !c.classList.contains('bg-hafta')) {
            const v = getCleanValue(c.innerHTML);
            if (v === "" || v === "0") return;

            const inf = getVardiyaInfo(v);
            const mS = parseFloat(v.replace(",", "."));
            const s = (inf && inf.t > 0) ? inf.t : (!isNaN(mS) ? mS : 0);

            tAg++; 
            if (v === "RT") n_rt++;
            else if (v === "HT" && s === 0) n_ht++;
            else if (v === "R") n_r++;
            else if (inf && inf.tip === "izin") n_i++;

            if (s > 0) {
                wHs += s;
                wHg++;
                tAge += (inf.g || 0);
                if (v === "RTÃ‡") n_rtc++;
                if (c.classList.contains('hucre-haftasonu')) n_htc++;
            }
        }

        if (c.classList.contains('bg-hafta')) {
            const type = c.getAttribute('data-type');
            if (type === 'h-gun') {
                c.innerText = wHg > 0 ? wHg : "";
            } else if (type === 'h-saat') {
                c.innerText = wHs > 0 ? Number(wHs.toFixed(2)) : "";
            } else if (type === 'h-fm') {
                let wFm = wHs > 45 ? (wHs - 45) : 0;
                c.innerText = wFm > 0 ? Number(wFm.toFixed(2)) : "";
                tFM += wFm; // AYLIK FM'ye ekle
                
                // HAFTA BÄ°TTÄ°ÄÄ° Ä°Ã‡Ä°N SIFIRLA
                wHs = 0; wHg = 0;
            }
        }
    });

    const update = (cls, v) => {
        const el = tr.querySelector(cls);
        if (el) el.innerText = (v === 0 || !v) ? "0" : Number(v.toFixed(2));
    };

    update('.s-calisma', tAg);
    update('.s-yol', tAg + n_rtc);
    update('.s-rapor', n_r);
    update('.s-izin', n_i);
    update('.s-ht', n_ht);
    update('.s-rt', n_rt);
    update('.s-rtc', n_rtc);
    update('.s-fm', tFM);
    update('.s-gecefm', 0);
    update('.s-gece', tAge);
}

function raporuOlustur() {
    const {bas,bit,str} = tarihGuncelle();
    let days=[]; let d=new Date(bas); while(d<=bit){ days.push(new Date(d)); d.setDate(d.getDate()+1); }
    
    let people = {};
    appData.gruplar.forEach(grup => {
        if(grup.kisiler) {
            grup.kisiler.forEach(n => { people[n] = { n: n, gId: grup.id, gAd: grup.ad, data: {} }; });
        }
    });

    const raw = document.getElementById('inpExcel').value.split('\n').filter(r=>r.trim());
    let map = {};
    raw.forEach(row => {
        let cols = row.split('\t'); let isHead=false, tmp={};
        cols.forEach((c,i)=>{ let k=excelTarih(c); if(k){tmp[k]=i; isHead=true;} });
        if(isHead) map=tmp;
        else {
            let shiftName = cols[0].trim().toUpperCase();
            if(shiftName.length > 2) {
                // Burada TC - Ä°sim ayrÄ±mÄ± yapÄ±yoruz
                let matchedPersonKey = Object.keys(people).find(pKey => {
                    let cleanPKey = pKey.includes("-") ? pKey.split("-")[1].trim() : pKey;
                    // EÄŸer "AYÅE Ã‡OBAN 2" ise sondaki sayÄ±yÄ± at
                    cleanPKey = cleanPKey.replace(/\s\d+$/, '').trim(); 
                    let cleanShiftName = shiftName.replace(/\s\d+$/, '').trim();
                    return cleanPKey === cleanShiftName || cleanPKey === shiftName;
                });

                if(matchedPersonKey) {
                    for(let k in map) {
                        let v = (cols[map[k]]||"").trim();
                        if(v) people[matchedPersonKey].data[k] = v;
                    }
                }
            }
        }
    });

    Object.values(people).forEach(p => {
        days.forEach(day => { let k = getKey(day); if(!p.data[k]) p.data[k] = (day.getDay()===0||day.getDay()===6) ? "HT" : "08:00-18:00"; });
    });

    // AY SONU SÃœTUN BAÅLIKLARI
    const HDR = [
        {n:"Ã‡alÄ±ÅŸma GÃ¼nÃ¼", c:"s-calisma"}, 
        {n:"Ä°ÅŸe Gelme GÃ¼nÃ¼(Yol)", c:"s-yol"}, 
        {n:"Raporlu GÃ¼n SayÄ±sÄ±", c:"s-rapor"}, 
        {n:"Ä°zinli OlduÄŸu GÃ¼n SayÄ±sÄ±", c:"s-izin"}, 
        {n:"Hafta Tatili ToplamÄ±(HT)", c:"s-ht"}, 
        {n:"Resmi Tatil(Tam GÃ¼n)(RT)", c:"s-rt"}, 
        {n:"Resmi Tatil Ã‡alÄ±ÅŸmasÄ±(RTÃ‡)", c:"s-rtc"}, 
        {n:"GÃ¼ndÃ¼z Fazla Mesai ToplamÄ± (Saat SayÄ±sÄ±)", c:"s-fm"},
        {n:"Ä°Å SAÄLIÄI VE GÃœVENLÄ°ÄÄ° (YOL)", c:"s-isg"}
    ];
    
    let sayfaHtml = ""; let gArr = Object.values(people).reduce((acc, p) => { acc[p.gAd] = acc[p.gAd]||[]; acc[p.gAd].push(p); return acc; }, {});
    
    for(let gAd in gArr) {
        let list = gArr[gAd].sort((a,b)=>a.n.localeCompare(b.n,'tr'));
        
        let gunSutunSayisi = 0;
        days.forEach((d, idx) => {
            gunSutunSayisi++;
            if (d.getDay() === 0 || idx === days.length - 1) gunSutunSayisi += 3;
        });
        
        let toplamSutun = 3 + gunSutunSayisi + HDR.length + 2;

        let h = `<div class="sayfa"><table class="veri-tablosu" data-grup="${gAd}">
        <colgroup><col class="c-sno"><col class="c-tc"><col class="c-isim">`;
        
        days.forEach((d, idx)=>{ 
            h+=`<col class="c-gun">`; 
            if(d.getDay()===0 || idx === days.length - 1) h+=`<col class="c-gun"><col class="c-gun"><col class="c-gun">`; 
        });
        HDR.forEach(()=>h+=`<col class="c-gun">`);
        h+=`<col class="c-gun"><col class="c-gun"></colgroup><thead>
        
        <tr>
            <td colspan="${toplamSutun}" style="border: none !important; padding: 10px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    
                    <div style="flex: 1; text-align: left;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/T.C._Sa%C4%9Fl%C4%B1k_Bakanl%C4%B1%C4%9F%C4%B1_Logo.png" style="height: 55px;">
                    </div>

                    <div style="flex: 3; text-align: center;">
                        <div contenteditable="true" style="font-weight: 800; font-size: 16px; text-transform: uppercase; margin-bottom: 3px;">
                            ${gAd.toUpperCase()} BAÅHEKÄ°MLÄ°ÄÄ°
                        </div>
                        <div style="font-size: 11px; font-weight: bold; color: #333;">
                            TEMÄ°ZLÄ°K BÄ°RÄ°MÄ° / SÃœREKLÄ° Ä°ÅÃ‡Ä° NÃ–BET LÄ°STESÄ° VE PUANTAJ CETVELÄ°
                        </div>
                        <div style="font-size: 10px; font-weight: bold; margin-top: 2px;">
                            (${str})
                        </div>
                    </div>

                    <div style="flex: 1; text-align: right;">
                        <table style="width: 190px; border: 1pt solid #000; border-collapse: collapse; font-family: 'Arial Narrow', sans-serif; display: inline-table; background: #fff;">
                            <tr><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-weight: bold; font-size: 8px;">DOKÃœMAN KODU:</td><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-size: 8px;" contenteditable="true">PNT.FR.01</td></tr>
                            <tr><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-weight: bold; font-size: 8px;">YAYIN TARÄ°HÄ°:</td><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-size: 8px;" contenteditable="true">${new Date().toLocaleDateString('tr-TR')}</td></tr>
                            <tr><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-weight: bold; font-size: 8px;">REVÄ°ZYON NO:</td><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-size: 8px;" contenteditable="true">00</td></tr>
                            <tr><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-weight: bold; font-size: 8px;">REV. TARÄ°HÄ°:</td><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-size: 8px;" contenteditable="true">--/--/----</td></tr>
                            <tr><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-weight: bold; font-size: 8px;">SAYFA NO:</td><td style="border: 0.5pt solid #000; text-align: left; padding: 1px 3px; font-size: 8px;" contenteditable="true">1/1</td></tr>
                        </table>
                    </div>
                </div>
            </td>
        </tr>

        <tr><th>S.NO</th><th>TC KÄ°MLÄ°K NO</th><th style="border:none;">ADI SOYADI</th>`;
        
        let weekCount = 1;
        days.forEach((d, idx)=>{
            let gg = String(d.getDate()).padStart(2, '0');
            let aa = String(d.getMonth() + 1).padStart(2, '0');
            let gunAdi = d.toLocaleDateString('tr-TR', { weekday: 'long' }).toUpperCase();
            let tamTarih = `${gg}/${aa}/${d.getFullYear()}<br><span style="font-weight:normal; font-size:5.5px">${gunAdi}</span>`;
            
            h+=`<th style="${(d.getDay()===0||d.getDay()===6)?'background:#eee':''}; border-top:none;"><div class="dikey-tarih">${tamTarih}</div></th>`;
            
            // HER PAZARDAN SONRA VEYA AYIN EN SON GÃœNÃœNDEYSE HAFTALIK Ã–ZETÄ° EKLE
            if(d.getDay()===0 || idx === days.length - 1) {
                h+=`<th class="bg-hafta" style="border-top:none"><div class="dikey-yazi">${weekCount}-HaftalÄ±k Ä°ÅŸe Gelme GÃ¼nÃ¼</div></th>
                    <th class="bg-hafta" style="border-top:none"><div class="dikey-yazi">${weekCount}.Hafta ToplamÄ±</div></th>
                    <th class="bg-hafta" style="border-top:none"><div class="dikey-yazi">${weekCount}.Hafta Fazla Mesai</div></th>`;
                weekCount++;
            }
        });

        HDR.forEach(b => { h += `<th class="bg-genel" style="border-top:none"><div class="dikey-yazi">${b.n}</div></th>`; });
        h += `<th class="bg-gece" style="border-top:none"><div class="dikey-yazi">Gece Fazla Mesai ToplamÄ± (Saat SayÄ±sÄ±)</div></th><th class="bg-gece" style="border-top:none; border-right:none"><div class="dikey-yazi">Toplam Gece Ã‡alÄ±ÅŸmasÄ± (Saat SayÄ±sÄ±)</div></th></tr>
        </thead>
        <tbody>`;

        list.forEach((p, index)=>{
            let tcNo = "";
            let gosterilecekIsim = p.n;
            
            // TC NumarasÄ±nÄ± ParÃ§alama Ä°ÅŸlemi
            if (p.n.includes("-")) {
                let parts = p.n.split("-");
                tcNo = parts[0].trim();
                gosterilecekIsim = parts[1].trim();
            }

            h+=`<tr><td contenteditable="true">${index + 1}</td><td contenteditable="true">${tcNo}</td><td class="isim-hucre" style="border-left:none; text-align:left; padding-left:3px;" contenteditable="true">${gosterilecekIsim}</td>`;
            
            days.forEach((d, idx)=>{
                let v = p.data[getKey(d)] || "";
                let info = getVardiyaInfo(v);
                let bg=(d.getDay()===0||d.getDay()===6)?'hucre-haftasonu':''; 
                if(info.tip==='izin') bg='hucre-izin';
                h+=`<td contenteditable="true" class="veri-hucre ${bg}" oninput="satirHesapla(this)">${formatliVardiya(v)}</td>`;
                
                if(d.getDay()===0 || idx === days.length - 1){
                    h+=`<th class="bg-hafta veri-hucre" data-type="h-gun"></th>
                        <th class="bg-hafta veri-hucre" data-type="h-saat"></th>
                        <th class="bg-hafta veri-hucre" style="color:red" data-type="h-fm"></th>`;
                }
            });
            // Burada s-isg sÃ¼tunu iÃ§in contenteditable ekliyoruz
            HDR.forEach(b => { h += `<th class="bg-genel ${b.c}" ${b.c === 's-isg' ? 'contenteditable="true"' : ''}>0</th>`; });
            h += `<th class="bg-gece s-gecefm">0</th><th class="bg-gece s-gece" style="border-right:none">0</th></tr>`;
        });

        h+=`</tbody>
        <tfoot>
            <tr><td colspan="${toplamSutun}" style="border: none; text-align: left; padding-top: 5px;"><div style="font-size: 8px; font-weight: bold; color: #2c3e50;">NOT: "Fazla Mesai Saat" = HaftalÄ±k 45 Saati AÅŸan Mesailer ToplamÄ±dÄ±r.</div></td></tr>
            <tr><td colspan="${toplamSutun}" style="border: none; text-align: center; font-weight: bold; font-size: 11px; padding: 5px 0;">AÃ‡IKLAMALAR</td></tr>
            <tr><td colspan="${toplamSutun}" style="border: 1px solid #000; text-align: left; font-size: 9px; padding: 4px;" contenteditable="true"><strong>1-</strong> (AÃ§Ä±klamalarÄ±nÄ±zÄ± buraya yazÄ±n...)</td></tr>
            <tr>
                <td colspan="${Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 11px; padding-top: 25px;" contenteditable="true"><strong>DÃ¼zenleyen</strong><br>TEMÄ°ZLÄ°K Birim Sorumlusu<br><br><br>...................</td>
                <td colspan="${Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 11px; padding-top: 25px;" contenteditable="true"><strong>Kontrol Eden</strong><br>Ä°DARÄ° VE MALÄ° Ä°ÅLER MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±<br><br><br>...................</td>
                <td colspan="${toplamSutun - 2*Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 11px; padding-top: 25px;" contenteditable="true"><strong>Onaylayan</strong><br>Ä°DARÄ° VE MALÄ° Ä°ÅLER MÃ¼dÃ¼rÃ¼<br><br><br>...................</td>
            </tr>
        </tfoot>
        </table></div>`;
        sayfaHtml+=h;
    }
    document.getElementById('raporAlani').innerHTML = sayfaHtml;
    document.querySelectorAll('.veri-hucre').forEach(td => satirHesapla(td));
    document.getElementById('btnExceleKopyala').style.display = "block";
}
// ------------------------------------
// HÃœCRE BÄ°RLEÅTÄ°RME (MERGE) Ä°ÅLEMLERÄ°
// ------------------------------------
let isSelecting = false; let startCell = null; let selectedCells = [];
function getRowIdx(td) { return Array.from(td.parentNode.parentNode.children).indexOf(td.parentNode); }
function getColIdx(td) { let tr = td.parentNode; let idx = 0; for (let i = 0; i < tr.children.length; i++) { if (tr.children[i] === td) return idx; idx += parseInt(tr.children[i].getAttribute('colspan') || 1); } return idx; }

function clearSelection() { selectedCells.forEach(td => { if(td) td.classList.remove('selected-cell'); }); selectedCells = []; }
function selectRectangle(start, end) {
    clearSelection(); let r1 = getRowIdx(start), r2 = getRowIdx(end); let c1 = getColIdx(start), c2 = getColIdx(end);
    let minR = Math.min(r1, r2), maxR = Math.max(r1, r2); let minC = Math.min(c1, c2), maxC = Math.max(c1, c2);
    let rows = start.closest('tbody').children;
    for (let r = minR; r <= maxR; r++) {
        let tds = rows[r].children;
        for (let c = minC; c <= maxC; c++) {
            let td = tds[c]; if (td && td.style.display !== 'none' && !td.hasAttribute('colspan')) { td.classList.add('selected-cell'); selectedCells.push(td); }
        }
    }
}
document.addEventListener('mousedown', function(e) { if (e.button !== 0 || e.target.closest('#tableContextMenu')) return; if (e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) { isSelecting = true; startCell = e.target; clearSelection(); e.target.classList.add('selected-cell'); selectedCells.push(e.target); } else clearSelection(); });
document.addEventListener('mouseover', function(e) { if (isSelecting && e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) selectRectangle(startCell, e.target); });
document.addEventListener('mouseup', function() { isSelecting = false; });
document.addEventListener('contextmenu', function(e) { if (e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) { e.preventDefault(); if (!selectedCells.includes(e.target)) { clearSelection(); e.target.classList.add('selected-cell'); selectedCells.push(e.target); } let ctxMenu = document.getElementById('tableContextMenu'); ctxMenu.style.display = 'block'; ctxMenu.style.left = e.pageX + 'px'; ctxMenu.style.top = e.pageY + 'px'; } });

function mergeSelectedCells() {
    document.getElementById('tableContextMenu').style.display = 'none'; if (selectedCells.length <= 1) return clearSelection();
    selectedCells.sort((a, b) => { let rDiff = getRowIdx(a) - getRowIdx(b); return rDiff !== 0 ? rDiff : getColIdx(a) - getColIdx(b); });
    let mainCell = selectedCells[0]; let mergeId = "merge_" + Date.now();
    let isRowMerge = getRowIdx(selectedCells[0]) === getRowIdx(selectedCells[1]);
    if (isRowMerge) {
        let totalColSpan = 0; let mergedText = "";
        selectedCells.forEach((td, index) => { totalColSpan += parseInt(td.getAttribute('colspan') || 1); if(getCleanValue(td.innerHTML) !== "" && mergedText === "") mergedText = td.innerHTML; if (index > 0) { td.style.display = 'none'; td.setAttribute('data-merged-by', mergeId); } });
        mainCell.setAttribute('colspan', totalColSpan); mainCell.setAttribute('data-merge-id', mergeId); mainCell.innerHTML = mergedText;
    } else {
        let totalRowSpan = 0; let mergedText = "";
        selectedCells.forEach((td, index) => { totalRowSpan += parseInt(td.getAttribute('rowspan') || 1); if(getCleanValue(td.innerHTML) !== "" && mergedText === "") mergedText = td.innerHTML; if (index > 0) { td.style.display = 'none'; td.setAttribute('data-merged-by', mergeId); } });
        mainCell.setAttribute('rowspan', totalRowSpan); mainCell.setAttribute('data-merge-id', mergeId); mainCell.innerHTML = mergedText;
    }
    satirHesapla(mainCell); clearSelection();
}
function unmergeSelectedCells() {
    document.getElementById('tableContextMenu').style.display = 'none';
    selectedCells.forEach(td => {
        let mergeId = td.getAttribute('data-merge-id');
        if (mergeId) {
            td.removeAttribute('colspan'); td.removeAttribute('rowspan'); td.removeAttribute('data-merge-id');
            td.closest('tbody').querySelectorAll(`td[data-merged-by="${mergeId}"]`).forEach(hiddenTd => { hiddenTd.style.display = ''; hiddenTd.removeAttribute('data-merged-by'); satirHesapla(hiddenTd); });
        }
    });
    if(selectedCells.length > 0) satirHesapla(selectedCells[0]); clearSelection();
}

function shiftMasterdanCek() {
    let basInput = document.getElementById('inpTarihBas').value; let bitInput = document.getElementById('inpTarihBit').value;
    if(!basInput || !bitInput) return alert("Tarih seÃ§in!");
    let btn = document.querySelector('button[onclick="shiftMasterdanCek()"]'); let oldText = btn.innerHTML;
    btn.innerHTML = "â³ Ã‡EKÄ°LÄ°YOR..."; btn.style.pointerEvents = "none";
    let bas = new Date(basInput); let bit = new Date(bitInput);

    db.ref("arsivlenmis_shiftler").once("value").then(snap => {
        let data = snap.val(); if(!data) return alert("ArÅŸiv yok!");
        let personelShiftleri = {};
        Object.values(data).forEach(arsiv => {
            let tablolar = arsiv.tables ? arsiv.tables : (arsiv.data ? [arsiv] : []);
            tablolar.forEach(tablo => {
                let tBas = new Date(tablo.startDate);
                tablo.data.forEach(satir => {
                    let isim = satir.name.trim().toUpperCase(); if(!personelShiftleri[isim]) personelShiftleri[isim] = {};
                    satir.shifts.forEach((shiftObj, index) => {
                        let suankiTarih = new Date(tBas); suankiTarih.setDate(tBas.getDate() + index);
                        if(suankiTarih >= bas && suankiTarih <= bit) {
                            let tStr = `${String(suankiTarih.getDate()).padStart(2,'0')}.${String(suankiTarih.getMonth()+1).padStart(2,'0')}.${suankiTarih.getFullYear()}`;
                            if(shiftObj.text) personelShiftleri[isim][tStr] = shiftObj.text;
                        }
                    });
                });
            });
        });
        let days = []; let d = new Date(bas); while(d <= bit) { days.push(`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`); d.setDate(d.getDate() + 1); }
        let excelStr = "AD SOYAD\t" + days.join("\t") + "\n";
        Object.keys(personelShiftleri).forEach(isim => {
            let satirStr = isim; days.forEach(t => satirStr += "\t" + (personelShiftleri[isim][t] || "")); excelStr += satirStr + "\n";
        });
        document.getElementById('inpExcel').value = excelStr;
        btn.innerHTML = "âœ… BAÅARILI"; setTimeout(() => { btn.innerHTML = oldText; btn.style.pointerEvents = "auto"; }, 2000);
        raporuOlustur();
    });
}

function exceleSifirKayipsizKopyala() {
    const tablolar = document.querySelectorAll('.veri-tablosu'); if (tablolar.length === 0) return;
    let combinedHtml = `<html><head><meta charset="utf-8"><style>table { border-collapse: collapse; } th, td { border: 0.5pt solid black; text-align: center; }</style></head><body>`;
    tablolar.forEach(tablo => {
        let clone = tablo.cloneNode(true);
        clone.querySelectorAll('td[style*="display: none"]').forEach(c => c.remove());
        clone.querySelectorAll('.selected-cell').forEach(c => c.classList.remove('selected-cell'));
        combinedHtml += clone.outerHTML + "<br><br>"; 
    });
    combinedHtml += "</body></html>";
    const blob = new Blob([combinedHtml], { type: 'text/html' });
    try {
        const data = [new ClipboardItem({ 'text/html': blob })];
        navigator.clipboard.write(data).then(() => alert("âœ… KopyalandÄ±! Excel'e yapÄ±ÅŸtÄ±rÄ±n."));
    } catch (e) { alert("TarayÄ±cÄ± hatasÄ±!"); }
}
</script>
</body>
</html>
