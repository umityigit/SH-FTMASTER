<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEMƒ∞ZLƒ∞K Bƒ∞Rƒ∞Mƒ∞ PUANTAJ Sƒ∞STEMƒ∞ v119 (CANLI HESAP & TEK SIRA Dƒ∞K)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --green: #27ae60; --orange: #e67e22; --red: #c0392b; --blue: #2980b9; --dark: #1a252f; }
        body { margin: 0; background: #eef2f5; font-family: 'Roboto', sans-serif; }

        /* Gƒ∞Rƒ∞≈û */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #loginBox { background: white; padding: 40px; border-radius: 10px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 320px; position: relative; }
        .prod-by { margin-top: 15px; font-size: 10px; color: #7f8c8d; font-weight: bold; letter-spacing: 1px; }

        /* ANA PANEL */
        #mainContent { display: none; padding-bottom: 50px; }
        .panel-container { background: white; padding: 15px; width: 98%; margin: 10px auto; border-radius: 10px; display: flex; gap: 15px; flex-wrap: wrap; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 5px solid var(--blue); }
        .panel-col { flex: 1; min-width: 280px; display: flex; flex-direction: column; gap: 8px; position: relative; }
        
        h3 { margin: 0; font-size: 14px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: var(--primary); text-transform: uppercase; cursor: text; transition: 0.2s;}
        h3:hover { background: #f0f8ff; }
        h3:focus { outline: 2px solid var(--blue); background: #fff; }

        .personel-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .modern-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; box-sizing: border-box;}
        .personel-listesi { height: 180px; overflow-y: auto; border: 1px solid #ddd; background: #fff; padding: 5px; border-radius: 5px; }
        .personel-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; border-bottom: 1px solid #f0f0f0; font-size: 11px; }
        
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-add { background: var(--green); padding: 5px 10px; }
        .btn-del { background: var(--red); padding: 2px 6px; font-size: 10px; }
        .btn-del-group { position: absolute; right: 0; top: 0; background: var(--red); padding: 2px 8px; font-size: 10px; }
        .btn-big { width: 100%; padding: 15px; font-size: 14px; margin-top: 5px; text-transform: uppercase; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn-big:active { transform: translateY(3px); box-shadow: none; }
        .btn-org { background: var(--orange); } .btn-grn { background: var(--green); } .btn-blu { background: var(--blue); }

        .vardiya-chip { display:flex; align-items:center; background:#2ecc71; color:white; padding:6px 10px; border-radius:5px; font-size:11px; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .vardiya-chip.izin { background:#e74c3c; }
        .vardiya-del { margin-left:10px; cursor:pointer; font-size:12px; transition:0.2s;}
        .vardiya-del:hover { color:#2c3e50; }

        /* TABLO ALANI */
        .sayfa-container { width: 100%; overflow-x: auto; padding-bottom: 20px; text-align: center; }
        .sayfa { background: white; padding: 20px; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-top: 20px; text-align: left; page-break-after: always; }
        
        table { width: 2350px !important; border-collapse: collapse; table-layout: fixed; border: 1px solid #000; margin: 0; padding: 0; user-select: none; }
        
        th, td { 
            border: 1px solid #000; 
            text-align: center; 
            vertical-align: middle; 
            padding: 2px; 
            line-height: 1.1; 
            word-break: break-word;
            overflow: visible;
        }
        
        /* Dƒ∞K YAZI ALANLARI */
        .veri-hucre { height: 100px !important; padding: 0 !important; cursor: text; transition: all 0.2s;}
        .veri-hucre:focus { background: #fff9c4 !important; outline: 2px solid #e67e22; font-size: 14px; font-weight: bold; }
        
        .dik-yazi {
            writing-mode: vertical-lr; 
            transform: rotate(180deg); 
            font-size: 12px; 
            font-weight: bold;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            pointer-events: none; /* Mouse ile tƒ±klamayƒ± kolayla≈ütƒ±rƒ±r */
        }

        .selected-cell { background-color: #d0ebff !important; outline: 2px solid #1c7ed6 !important; z-index: 10; }
        
        .ctx-item { padding: 8px 15px; font-size: 13px; cursor: pointer; transition: 0.2s; font-family: 'Roboto', sans-serif; color: #333; }
        .ctx-item:hover { background-color: #f1f3f5; color: var(--blue); }

        /* YATAY, KALIN VE GENƒ∞≈û OLACAK ALANLAR */
        col.c-sno { width: 35px; } 
        col.c-tc { width: 100px; } 
        col.c-isim { width: 130px; } 
        col.c-gun { width: 38px; } 

        .kalin-yatay { font-weight: bold !important; font-size: 12px !important; text-align: center; padding: 5px !important; }
        .isim-yatay { font-weight: bold !important; font-size: 12px !important; text-align: left; padding-left: 5px !important; }

        th { background: #eee; padding: 4px; font-size: 10px; }
        
        .bg-hafta { background-color: #dff0d8 !important; border-left: 2px solid #000; }
        .bg-genel { background-color: #fcf3cf !important; border-left: 2px solid #000; }
        .bg-gece { background-color: #e8daef !important; border-left: 2px solid #000; }
        .hucre-izin { background-color: #fadbd8 !important; color: #c0392b; font-weight: bold; }
        .hucre-haftasonu { background-color: #f2f2f2 !important; }
        
        .baslik-dik { writing-mode: vertical-lr; transform: rotate(180deg); white-space: nowrap; margin: auto; font-size: 11px; font-weight: bold; padding: 2px 0; }
        .baslik-dik-kucuk { writing-mode: vertical-lr; transform: rotate(180deg); white-space: nowrap; margin: auto; font-size: 9px; font-weight: normal; padding: 2px 0; color: #444; }

        #dynamicGroups { display: flex; gap: 15px; flex-wrap: wrap; width: 100%; }

        #btnExceleKopyala { position: fixed; bottom: 20px; right: 20px; background: #27ae60; color: white; border: none; padding: 15px 25px; border-radius: 50px; font-size: 14px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: none; z-index: 100000; transition: 0.3s; }
        #btnExceleKopyala:hover { background: #219653; transform: scale(1.05); }

        #cloudStatus { position: fixed; top: 10px; right: 10px; background: #27ae60; color: white; padding: 5px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; display: none; z-index: 999999; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        @media print {
            @page { size: A3 landscape; margin: 2mm; } 
            #loginScreen, .panel-container, #tableContextMenu, #btnExceleKopyala, #cloudStatus { display: none !important; }
            #mainContent { display: block !important; overflow: visible; }
            .sayfa-container { overflow: visible; }
            .sayfa { margin: 0; padding: 0; width: 100%; border: none; box-shadow: none; page-break-after: always; }
            .selected-cell { outline: none !important; background-color: inherit !important; } 
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="cloudStatus">‚òÅÔ∏è BULUT SENKRONƒ∞ZE</div>

<div id="loginScreen">
    <div id="loginBox">
        <div style="font-size:40px;">‚òÅÔ∏è</div>
        <h2>TEMƒ∞ZLƒ∞K Bƒ∞Rƒ∞Mƒ∞ PUANTAJ <br><span style="font-size:12px; color:#e67e22;">(BULUT BAƒûLANTILI)</span></h2>
        <input type="password" id="passInput" placeholder="≈ûifre: 1234" style="width:100%; padding:10px; text-align:center;">
        <button onclick="sifreKontrol()" style="background:var(--blue); width:100%; padding:12px; margin-top:10px;">Gƒ∞Rƒ∞≈û YAP</button>
        <div class="prod-by">PROD.BY. UMIT ABI 2026</div>
    </div>
</div>

<div id="mainContent">
    <div class="panel-container" style="border-top-color: var(--orange);">
        <div style="width:100%; padding-bottom:5px; border-bottom:2px solid #eee; margin-bottom:10px;">
            <h3 style="border:none; padding:0; display:inline-block; color:var(--orange);">VARDƒ∞YA Y√ñNETƒ∞Mƒ∞ (Ayarlar)</h3>
        </div>
        <div style="width:100%; display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
            <div style="flex:2; min-width: 150px;">
                <label style="font-size:10px; font-weight:bold;">Vardiya Adƒ± / Kodu</label>
                <input type="text" id="vAd" class="modern-input" placeholder="√ñrn: 08:00-20:00 veya Nƒ∞">
            </div>
            <div style="flex:1; min-width: 80px;">
                <label style="font-size:10px; font-weight:bold;">Toplam Saat</label>
                <input type="number" id="vSaat" class="modern-input" placeholder="√ñrn: 11" step="0.5">
            </div>
            <div style="flex:1; min-width: 80px;">
                <label style="font-size:10px; font-weight:bold;">Gece Saati</label>
                <input type="number" id="vGece" class="modern-input" placeholder="√ñrn: 0" step="0.5">
            </div>
            <div style="flex:1.5; min-width: 120px;">
                <label style="font-size:10px; font-weight:bold;">T√ºr (√áalƒ±≈üma/ƒ∞zin)</label>
                <select id="vTip" class="modern-input">
                    <option value="calisma">√áalƒ±≈üma / Mesai</option>
                    <option value="izin">ƒ∞zin / ƒ∞stirahat</option>
                </select>
            </div>
            <div>
                <button onclick="vardiyaEkle()" class="btn-big btn-grn" style="margin:0; padding:8px 20px;">EKLE</button>
            </div>
        </div>
        <div id="vardiyaListesi" style="width:100%; display:flex; gap:8px; flex-wrap:wrap; margin-top:15px;"></div>
    </div>

    <div class="panel-container">
        <div id="dynamicGroups"></div>
        <div class="panel-col" style="flex:1; min-width: 250px; justify-content: center; align-items: center; border: 2px dashed #ccc; border-radius: 10px; padding: 20px;">
            <button onclick="yeniGrupEkle()" class="btn-big btn-blu">+ YENƒ∞ GRUP EKLE</button>
        </div>
        <div class="panel-col" style="flex:100%; border-top: 1px solid #eee; padding-top: 15px; margin-top: 5px;">
            <div style="display:flex; gap:10px;">
                <input type="date" id="inpTarihBas" class="modern-input" title="Ba≈ülangƒ±√ß Tarihi">
                <input type="date" id="inpTarihBit" class="modern-input" title="Biti≈ü Tarihi">
                <button onclick="shiftMasterdanCek()" class="btn-big" style="background:#8b5cf6; margin:0; flex:2; color:white;">üîÑ SHƒ∞FTMASTER'DAN √áEK</button>
                <button onclick="raporuOlustur()" class="btn-big btn-org" style="margin:0; flex:2;">MANUEL OLU≈ûTUR</button>
                <button onclick="window.print()" class="btn-big btn-grn" style="margin:0; flex:1;">YAZDIR</button>
            </div>
            <textarea id="inpExcel" placeholder="Excel'den kopyaladƒ±ƒüƒ±nƒ±z verileri buraya yapƒ±≈ütƒ±rƒ±n..." style="height:100px; margin-top: 10px;" class="modern-input"></textarea>
        </div>
    </div>
    
    <div class="sayfa-container">
        <div id="raporAlani"></div>
    </div>
</div>

<button id="btnExceleKopyala" onclick="exceleSifirKayipsizIndir()">üì• EXCEL DOSYASI ƒ∞NDƒ∞R</button>

<div id="tableContextMenu" style="display:none; position:absolute; background:white; border:1px solid #ced4da; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:99999; border-radius:5px; overflow:hidden;">
    <div class="ctx-item" onclick="mergeSelectedCells()">üîó Se√ßili H√ºcreleri Birle≈ütir</div>
    <div style="border-bottom: 1px solid #eee;"></div>
    <div class="ctx-item" onclick="unmergeSelectedCells()">‚úÇÔ∏è H√ºcre Birle≈ütirmesini Ayƒ±r</div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyAAqT74kCwyr6ZULTR_ClRDJ5Iu4AhmXJQ", databaseURL: "https://shiftmaster1-7fc5f-default-rtdb.europe-west1.firebasedatabase.app", projectId: "shiftmaster1-7fc5f" };
firebase.initializeApp(firebaseConfig); const db = firebase.database();

document.addEventListener('DOMContentLoaded', function() {
    let passInput = document.getElementById('passInput');
    if (passInput) passInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') sifreKontrol(); });
    
    let bugun = new Date();
    let bas = new Date(bugun.getFullYear(), bugun.getMonth(), 15);
    let bit = new Date(bugun.getFullYear(), bugun.getMonth() + 1, 14);
    
    document.getElementById('inpTarihBas').value = `${bas.getFullYear()}-${String(bas.getMonth()+1).padStart(2,'0')}-${String(bas.getDate()).padStart(2,'0')}`;
    document.getElementById('inpTarihBit').value = `${bit.getFullYear()}-${String(bit.getMonth()+1).padStart(2,'0')}-${String(bit.getDate()).padStart(2,'0')}`;
    
    bulutBaglantisiniKur();
});

const DEFAULT_VARDIYALAR = { 
    "08:00-18:00":{t:9,g:0, tip:"calisma"}, "08:00-20:00":{t:11,g:0, tip:"calisma"}, "08:00-16:00":{t:7.5,g:0, tip:"calisma"}, 
    "20:00-08:00":{t:11,g:11, tip:"calisma"}, "16:00-24:00":{t:7.5,g:4, tip:"calisma"}, "24:00-08:00":{t:7.5,g:6, tip:"calisma"}, 
    "HT":{t:0,g:0, tip:"izin"}, "Yƒ∞":{t:0,g:0, tip:"izin"}, "R":{t:0,g:0, tip:"izin"}, "ƒ∞":{t:0,g:0, tip:"izin"}, 
    "Nƒ∞":{t:0,g:0, tip:"izin"}, "RT":{t:0,g:0, tip:"izin"}, "RT√á":{t:9,g:0, tip:"calisma"} 
};

let appData = { gruplar: [], vardiyalar: null };

function sifreKontrol() {
    if(document.getElementById('passInput').value.trim() === "1234") {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
    } else alert("HATALI ≈ûƒ∞FRE!");
}

function showCloudStatus() {
    const status = document.getElementById('cloudStatus');
    status.style.display = 'block';
    setTimeout(() => { status.style.display = 'none'; }, 2000);
}

function ilkKurulumuYap() {
    appData = { gruplar: [], vardiyalar: DEFAULT_VARDIYALAR };
    const genelListe = [
        "10006543166 - NEJLA Nƒ∞Lƒ∞", "10580422338 - TAYYƒ∞P DOƒûAN", "11620640910 - ZELƒ∞HA ERSOY", "12547486254 - MEHMET OƒûUZ D√ñƒû√úN", 
        "13097253044 - ORHAN KAHRAMAN", "14671540086 - G√úLBAHAR √úNVER", "15097363778 - MERVE √ñZ", "15958477590 - NAZMƒ∞YE DURAN", 
        "16015509254 - SONG√úL ERDOƒûAN", "16709091126 - G√úLL√ú TOSUN", "16900491572 - SONG√úL Dƒ∞LEK", "19589057206 - SEDA YILMAZ", 
        "19741371508 - √ñZLEM DURSUN", "21283980216 - ≈ûAHABETTƒ∞N ORHAN", "22918496584 - HATƒ∞CE YILDIRIM", "24475058656 - ZEYNEP BOZAN", 
        "25282186846 - BURCU DERELƒ∞OƒûLU", "25624852712 - SONG√úL √ñZT√úRK", "26872123876 - HURƒ∞YE ELMAS", "27091143096 - KADƒ∞R GAMSIZ", 
        "28543103354 - AY≈ûE BOZKAYA", "29386066998 - SAFƒ∞YE DENECƒ∞", "30163049264 - ADEM K√ñM√úR", "30623331236 - SADIK MACƒ∞T", 
        "30937798466 - ALƒ∞ GEN√áEL", "37927835576 - HALƒ∞L VAR", "40186499618 - DENƒ∞Z USLU", "45925910836 - ENES ABDULLAH ALTUN", 
        "53164244964 - MAKBULE DENK", "58708122418 - MUSTAFA Dƒ∞K", "61585026564 - FATMA √áALI≈ûKAN", "10588692368 - √úMƒ∞T Yƒ∞ƒûƒ∞T", 
        "21604545568 - NUSRETTƒ∞N √ñZSOY", "23665254878 - √úMM√ú KURU", "26542158924 - HAFƒ∞SE Dƒ∞KMEN", "29056059848 - FATMA I≈ûIK", 
        "30328031684 - BURAK TURAN", "32827531146 - HATƒ∞CE KARAKU≈û", "00000000000 - FATMA KO√áAR", "10546692058 - HAFƒ∞ZE √ñNAL", 
        "23467244800 - FUNDA POYRAZ", "62074286230 - BET√úL ≈ûƒ∞M≈ûEK"
    ];
    appData.gruplar = [{ id: "g_1", ad: "T√úM PERSONEL (GENEL Lƒ∞STE)", kisiler: genelListe }];
    veriKaydet(); 
}

function bulutBaglantisiniKur() {
    db.ref("puantaj_v115_zorunlu_gecis").once("value", snap => {
        if(!snap.val()) {
            ilkKurulumuYap();
            db.ref("puantaj_v115_zorunlu_gecis").set(true);
            arayuzCiz(); vardiyaArayuzCiz();
        } else {
            db.ref("puantaj_motoru_ayarlar").on("value", snap => {
                let data = snap.val();
                if(data) {
                    appData = data;
                    if (!appData.vardiyalar) appData.vardiyalar = DEFAULT_VARDIYALAR;
                    if (!appData.gruplar || appData.gruplar.length === 0) appData.gruplar = [{ id: "g_1", ad: "T√úM PERSONEL", kisiler: [] }];
                    arayuzCiz();
                    vardiyaArayuzCiz();
                    showCloudStatus();
                } else {
                    ilkKurulumuYap();
                }
            });
        }
    });
}

function veriKaydet() { db.ref("puantaj_motoru_ayarlar").set(appData); }

function vardiyaEkle() {
    let kod = document.getElementById("vAd").value.trim().toUpperCase();
    let t = parseFloat(document.getElementById("vSaat").value) || 0;
    let g = parseFloat(document.getElementById("vGece").value) || 0;
    let tip = document.getElementById("vTip").value;
    if(!kod) return alert("Vardiya adƒ± bo≈ü olamaz!");
    appData.vardiyalar[kod] = { t: t, g: g, tip: tip };
    veriKaydet(); 
}

function vardiyaSil(kod) { if(confirm(kod + " silinsin mi?")) { delete appData.vardiyalar[kod]; veriKaydet(); } }

function vardiyaArayuzCiz() {
    const root = document.getElementById("vardiyaListesi"); root.innerHTML = "";
    for(let v in appData.vardiyalar) {
        let info = appData.vardiyalar[v];
        let cClass = info.tip === 'izin' ? 'izin' : 'calisma';
        let desc = info.tip === 'calisma' ? `(${info.t}s / G:${info.g}s)` : '(ƒ∞zin)';
        root.innerHTML += `<div class="vardiya-chip ${cClass}"><span>${v} ${desc}</span><span class="vardiya-del" onclick="vardiyaSil('${v}')">‚úñ</span></div>`;
    }
}

// =========================================================================
// YENƒ∞ FORMATLAMA VE HESAPLAMA MANTIƒûI (SORUNSUZ D√úZENLEME ƒ∞√áƒ∞N)
// =========================================================================

// Herhangi bir h√ºcrediki HTML kalƒ±ntƒ±larƒ±nƒ± temizleyip saf metni √ßƒ±karƒ±r
function getCleanValue(text) { 
    if(!text) return ""; 
    // Bo≈üluklarƒ± ve yeni satƒ±rlarƒ± tireye √ßevirir (08:00 20:00 -> 08:00-20:00)
    return text.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '').trim().toUpperCase(); 
}

// Kullanƒ±cƒ± h√ºcreye TIKLADIƒûINDA: S√ºsl√º div kaldƒ±rƒ±lƒ±r, d√ºz metin olur (Rahat√ßa yazsƒ±n diye)
function temizleFormat(td) {
    let metin = td.innerText || td.textContent || "";
    metin = metin.trim();
    td.innerHTML = metin; // Kutu silinir, sadece yazƒ± kalƒ±r
}

// Kullanƒ±cƒ± h√ºcreden √áIKTIƒûINDA: Yazdƒ±ƒüƒ± yazƒ± tekrar s√ºsl√º dik formata girer
function uygulaFormat(td) {
    let metin = getCleanValue(td.innerText || td.textContent);
    if (metin !== "") {
        td.innerHTML = `<div class="dik-yazi">${metin}</div>`;
    } else {
        td.innerHTML = "";
    }
    satirHesapla(td); // Garanti olsun diye tekrar hesaplat
}

// Sadece tablo ilk olu≈üurken √ßalƒ±≈üƒ±r
function formatliVardiya(val) { 
    if(!val) return ""; 
    val = val.trim(); 
    return `<div class="dik-yazi">${val}</div>`;
}

// =========================================================================

function getVardiyaInfo(val) {
    if (!val) return {t:0, g:0, tip:"bilinmeyen", val:""};
    let cleanVal = val.replace(/<br\s*\/?>/gi, "-").trim().toUpperCase(); 
    if (appData.vardiyalar && appData.vardiyalar[cleanVal]) return { ...appData.vardiyalar[cleanVal], val: cleanVal };
    let valWithHyphen = cleanVal.replace(/[\s\n\r]+/g, "-");
    if (appData.vardiyalar && appData.vardiyalar[valWithHyphen]) return { ...appData.vardiyalar[valWithHyphen], val: valWithHyphen };
    return {t:0, g:0, tip:"bilinmeyen", val: cleanVal};
}

function yeniGrupEkle() { appData.gruplar.push({ id: "g_" + Date.now(), ad: "YENƒ∞ GRUP", kisiler: [] }); veriKaydet(); }
function grupSil(id) { if (confirm("Grup silinsin mi?")) { appData.gruplar = appData.gruplar.filter(g => g.id !== id); veriKaydet(); } }
function grupAdiGuncelle(id, ad) { let g = appData.gruplar.find(g => g.id === id); if (g) { g.ad = ad.trim() || "ƒ∞Sƒ∞MSƒ∞Z GRUP"; veriKaydet(); } }

function personelEkle(grupId) {
    let input = document.getElementById("add_" + grupId); let isim = input.value.trim().toUpperCase();
    let grup = appData.gruplar.find(g => g.id === grupId);
    if(!grup.kisiler) grup.kisiler = [];
    if (isim && grup && !grup.kisiler.includes(isim)) { grup.kisiler.push(isim); veriKaydet(); }
    input.value = "";
}
function personelSil(gId, isim) { if (confirm("Silinsin mi?")) { let g = appData.gruplar.find(g => g.id === gId); g.kisiler = g.kisiler.filter(k => k !== isim); veriKaydet(); } }

function arayuzCiz() {
    const container = document.getElementById("dynamicGroups"); container.innerHTML = "";
    appData.gruplar.forEach(grup => {
        let html = `
        <div class="panel-col">
            <button class="btn-del-group" onclick="grupSil('${grup.id}')">X</button>
            <h3 contenteditable="true" onblur="grupAdiGuncelle('${grup.id}', this.innerText)">${grup.ad}</h3>
            <div class="personel-row"><input type="text" id="add_${grup.id}" class="modern-input" placeholder="12345678912 - PERSONEL ADI..." onkeypress="if(event.key==='Enter') personelEkle('${grup.id}')"><button onclick="personelEkle('${grup.id}')" class="btn-add">+</button></div>
            <div class="personel-listesi">`;
        if(grup.kisiler) {
            grup.kisiler.sort((a,b) => {
                let isimA = a.includes("-") ? a.split("-")[1].trim() : a;
                let isimB = b.includes("-") ? b.split("-")[1].trim() : b;
                return isimA.localeCompare(isimB, 'tr');
            }).forEach((isim) => {
                html += `<div class="personel-item"><span>${isim}</span><button onclick="personelSil('${grup.id}', '${isim}')" class="btn-del">X</button></div>`;
            });
        }
        container.innerHTML += html + `</div></div>`;
    });
}

function getSafeDate(val) {
    if (!val) return new Date();
    val = val.trim();
    let p;
    if (val.includes('-')) p = val.split('-');
    else if (val.includes('.')) p = val.split('.');
    else if (val.includes('/')) p = val.split('/');
    else return new Date(val);
    if (p && p.length === 3) {
        let y = parseInt(p[0].length === 4 ? p[0] : p[2]);
        let m = parseInt(p[1]) - 1;
        let d = parseInt(p[0].length === 4 ? p[2] : p[0]);
        return new Date(y, m, d);
    }
    return new Date(val);
}

function tarihGuncelle(){ 
    let bas = getSafeDate(document.getElementById('inpTarihBas').value); 
    let bit = getSafeDate(document.getElementById('inpTarihBit').value); 
    let str = `${String(bas.getDate()).padStart(2,'0')}.${String(bas.getMonth()+1).padStart(2,'0')}.${bas.getFullYear()} - ${String(bit.getDate()).padStart(2,'0')}.${String(bit.getMonth()+1).padStart(2,'0')}.${bit.getFullYear()}`;
    return {bas, bit, str}; 
}
function getKey(d){return d.getFullYear()+(d.getMonth()+1).toString().padStart(2,'0')+d.getDate().toString().padStart(2,'0');}
function excelTarih(s){
    if(!s)return null; 
    s = s.trim();
    let m = s.match(/^(\d{1,2})[./](\d{1,2})[./](\d{4})$/); 
    if(m) return m[3]+m[2].padStart(2,'0')+m[1].padStart(2,'0');
    let m2 = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if(m2) return m2[1]+m2[2].padStart(2,'0')+m2[3].padStart(2,'0');
    return null;
}

// CANLI HESAPLAMA MOTORU (HER HARF YAZILDIƒûINDA ANINDA √áALI≈ûIR)
function satirHesapla(td) {
    if (!td) return;
    const tr = td.closest('tr');
    if (!tr) return;

    // YAZIYI G√úVENLƒ∞ ≈ûEKƒ∞LDE ALIR (Kutunun ƒ∞√ßinden veya D√ºz Metinden)
    const rawVal = getCleanValue(td.innerText || td.textContent);
    const info = getVardiyaInfo(rawVal);
    
    const manuelSaat = parseFloat(rawVal.replace(",", "."));
    const aktifSaat = (info && info.t > 0) ? info.t : (!isNaN(manuelSaat) ? manuelSaat : 0);

    td.classList.remove('hucre-izin');
    if (aktifSaat === 0 && rawVal !== "" && rawVal !== "0") {
        td.classList.add('hucre-izin');
    }

    let tAg = 0, n_rt = 0, n_ht = 0, n_r = 0, n_i = 0, n_rtc = 0, n_htc = 0, tAge = 0, tFM = 0;
    let wHs = 0, wHg = 0;

    const allCells = Array.from(tr.children);
    allCells.forEach(c => {
        if (c.style.display === 'none' || c.hasAttribute('data-merged-by')) return;

        if (c.classList.contains('veri-hucre') && !c.classList.contains('bg-hafta')) {
            const v = getCleanValue(c.innerText || c.textContent);
            if (v === "" || v === "0") return;

            const inf = getVardiyaInfo(v);
            const mS = parseFloat(v.replace(",", "."));
            const s = (inf && inf.t > 0) ? inf.t : (!isNaN(mS) ? mS : 0);

            tAg++; 
            if (v === "RT") n_rt++;
            else if (v === "HT" && s === 0) n_ht++;
            else if (v === "R") n_r++;
            else if (inf && inf.tip === "izin") n_i++;

            if (s > 0) {
                wHs += s;
                wHg++;
                tAge += (inf.g || 0);
                if (v === "RT√á") n_rtc++;
                if (c.classList.contains('hucre-haftasonu')) n_htc++;
            }
        }

        if (c.classList.contains('bg-hafta')) {
            const type = c.getAttribute('data-type');
            if (type === 'h-gun') {
                c.innerText = wHg > 0 ? wHg : "";
            } else if (type === 'h-saat') {
                c.innerText = wHs > 0 ? Number(wHs.toFixed(2)) : "";
            } else if (type === 'h-fm') {
                let wFm = wHs > 45 ? (wHs - 45) : 0;
                c.innerText = wFm > 0 ? Number(wFm.toFixed(2)) : "";
                tFM += wFm; 
                wHs = 0; wHg = 0;
            }
        }
    });

    const update = (cls, v) => {
        const el = tr.querySelector(cls);
        if (el) el.innerText = (v === 0 || !v) ? "0" : Number(v.toFixed(2));
    };

    update('.s-calisma', tAg); update('.s-yol', tAg + n_rtc); update('.s-rapor', n_r);
    update('.s-izin', n_i); update('.s-ht', n_ht); update('.s-rt', n_rt);
    update('.s-rtc', n_rtc); update('.s-fm', tFM); update('.s-gecefm', 0); update('.s-gece', tAge);
    
    // NOT: BURADA FORMATLAMA YAPMIYORUZ Kƒ∞ KULLANICI YAZI YAZARKEN ƒ∞MLECƒ∞ KA√áMASIN.
    // FORMATLAMA ƒ∞≈ûLEMƒ∞Nƒ∞ ONBLUR (uygulaFormat) FONKSƒ∞YONUNA DEVRETTƒ∞K.
}

function raporuOlustur() {
    const {bas,bit,str} = tarihGuncelle();
    let days=[]; let d=new Date(bas.getTime()); while(d<=bit){ days.push(new Date(d.getTime())); d.setDate(d.getDate()+1); }
    
    let people = {};
    appData.gruplar.forEach(grup => {
        if(grup.kisiler) {
            grup.kisiler.forEach(n => { people[n] = { n: n, gId: grup.id, gAd: grup.ad, data: {} }; });
        }
    });

    const raw = document.getElementById('inpExcel').value.split('\n').filter(r=>r.trim());
    let map = {};
    raw.forEach(row => {
        let cols = row.split('\t'); let isHead=false, tmp={};
        cols.forEach((c,i)=>{ let k=excelTarih(c); if(k){tmp[k]=i; isHead=true;} });
        if(isHead) map=tmp;
        else {
            let textToSearch = cols.slice(0, 5).join(" ").toUpperCase();
            let matchedPersonKey = Object.keys(people).find(pKey => {
                let cleanPKey = pKey.includes("-") ? pKey.split("-")[1].trim() : pKey;
                cleanPKey = cleanPKey.replace(/\s\d+$/, '').replace(/\s+/g, ' ').trim(); 
                let normP = cleanPKey.replace(/ƒ∞/g,'I').replace(/ƒ±/g,'i').replace(/√ñ/g,'O').replace(/√ú/g,'U').replace(/≈û/g,'S').replace(/√á/g,'C').replace(/ƒû/g,'G');
                let normText = textToSearch.replace(/ƒ∞/g,'I').replace(/ƒ±/g,'i').replace(/√ñ/g,'O').replace(/√ú/g,'U').replace(/≈û/g,'S').replace(/√á/g,'C').replace(/ƒû/g,'G');
                return normText.includes(normP);
            });
            if(matchedPersonKey) {
                for(let k in map) {
                    let v = (cols[map[k]]||"").trim();
                    if(v) people[matchedPersonKey].data[k] = v;
                }
            }
        }
    });

    Object.values(people).forEach(p => {
        days.forEach(day => { let k = getKey(day); if(!p.data[k]) p.data[k] = (day.getDay()===0||day.getDay()===6) ? "HT" : "08:00-18:00"; });
    });

    const HDR = [
        {n:"√áalƒ±≈üma G√ºn√º", c:"s-calisma"}, {n:"ƒ∞≈üe Gelme G√ºn√º(Yol)", c:"s-yol"}, {n:"Raporlu G√ºn Sayƒ±sƒ±", c:"s-rapor"}, 
        {n:"ƒ∞zinli Olduƒüu G√ºn Sayƒ±sƒ±", c:"s-izin"}, {n:"Hafta Tatili Toplamƒ±(HT)", c:"s-ht"}, {n:"Resmi Tatil(Tam G√ºn)(RT)", c:"s-rt"}, 
        {n:"Resmi Tatil √áalƒ±≈ümasƒ±(RT√á)", c:"s-rtc"}, {n:"G√ºnd√ºz Fazla Mesai Toplamƒ±", c:"s-fm"}, {n:"ƒ∞≈û SAƒûLIƒûI VE G√úVENLƒ∞ƒûƒ∞ (YOL)", c:"s-isg"}
    ];
    
    let sayfaHtml = ""; 
    let gArr = Object.values(people).reduce((acc, p) => { acc[p.gAd] = acc[p.gAd]||[]; acc[p.gAd].push(p); return acc; }, {});
    
    for(let gAd in gArr) {
        let fullList = gArr[gAd].sort((a,b) => {
            let isimA = a.n.includes("-") ? a.n.split("-")[1].trim() : a.n;
            let isimB = b.n.includes("-") ? b.n.split("-")[1].trim() : b.n;
            return isimA.localeCompare(isimB, 'tr');
        });
        
        let gunSutunSayisi = 0;
        days.forEach((d, idx) => {
            gunSutunSayisi++;
            if (d.getDay() === 0 || idx === days.length - 1) gunSutunSayisi += 3;
        });
        
        let toplamSutun = 5 + gunSutunSayisi + HDR.length + 2; 

        let chunkSize = 15;
        let globalIndex = 1;
        
        for (let i = 0; i < fullList.length; i += chunkSize) {
            let list = fullList.slice(i, i + chunkSize);

            let h = `<div class="sayfa"><table class="veri-tablosu" data-grup="${gAd}">
            <colgroup><col class="c-sno"><col class="c-tc"><col class="c-isim"><col class="c-isim"><col class="c-sno">`;
            
            days.forEach((d, idx)=>{ 
                h+=`<col class="c-gun">`; 
                if(d.getDay()===0 || idx === days.length - 1) h+=`<col class="c-gun"><col class="c-gun"><col class="c-gun">`; 
            });
            HDR.forEach(()=>h+=`<col class="c-gun">`);
            h+=`<col class="c-gun"><col class="c-gun"></colgroup><thead>
            
            <tr>
                <td colspan="${toplamSutun}" style="border: none !important; padding: 15px 0; text-align: left; font-size: 14px; font-weight: bold;">
                    ANTALYA ƒ∞L SAƒûLIK M√úD√úRL√úƒû√ú D√ñ≈ûEMEALTI DEVLET HASTANESƒ∞ S√úREKLƒ∞ ƒ∞≈û√áƒ∞ PERSONEL PUANTAJ Bƒ∞LDƒ∞Rƒ∞Mƒ∞
                </td>
            </tr>
            <tr>
                <td colspan="5" style="border: none !important; text-align: left; font-weight: bold; font-size: 11px; padding-bottom: 10px;">
                    Bƒ∞Rƒ∞M ADI    :   TEMƒ∞ZLƒ∞K
                </td>
                <td colspan="${toplamSutun - 5}" style="border: none !important; text-align: left; font-weight: bold; font-size: 11px; padding-bottom: 10px;">
                    ${str}
                </td>
            </tr>`;

            let tr1 = `<tr>
                <th rowspan="2"><div class="baslik-dik">SIRA NO</div></th>
                <th rowspan="2" class="kalin-yatay">T.C. Kƒ∞MLƒ∞K NUMARASI</th>
                <th rowspan="2" class="isim-yatay">PERSONELƒ∞N ADI</th>
                <th rowspan="2" class="isim-yatay">PERSONELƒ∞N SOYADI</th>
                <th rowspan="2"><div class="baslik-dik">Devreden √áalƒ±≈üma Saati</div></th>`;
            
            let tr2 = `<tr>`;

            let weekCount = 1;
            days.forEach((d, idx)=>{
                let tamTarihStr = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth()+1).padStart(2, '0')}.${d.getFullYear()}`;
                let gunAdi = d.toLocaleDateString('tr-TR', { weekday: 'long' }).toUpperCase();
                
                let bgStyle = (d.getDay()===0||d.getDay()===6) ? 'background:#eee;' : '';
                
                tr1 += `<th style="${bgStyle} padding: 2px;" data-tarih="${tamTarihStr}"><div class="baslik-dik">${tamTarihStr}</div></th>`;
                tr2 += `<th style="${bgStyle} padding: 2px;" data-gun="${gunAdi}"><div class="baslik-dik-kucuk">${gunAdi}</div></th>`;
                
                if(d.getDay()===0 || idx === days.length - 1) {
                    tr1 += `<th rowspan="2" class="bg-hafta"><div class="baslik-dik">${weekCount}-Haftalƒ±k ƒ∞≈üe Gelme G√ºn√º</div></th>
                            <th rowspan="2" class="bg-hafta"><div class="baslik-dik">${weekCount}.Hafta Toplamƒ±</div></th>
                            <th rowspan="2" class="bg-hafta"><div class="baslik-dik">${weekCount}.Hafta Fazla Mesai</div></th>`;
                    weekCount++;
                }
            });

            HDR.forEach(b => { tr1 += `<th rowspan="2" class="bg-genel"><div class="baslik-dik">${b.n}</div></th>`; });
            tr1 += `<th rowspan="2" class="bg-gece"><div class="baslik-dik">Gece Fazla Mesai Toplamƒ± (Saat)</div></th><th rowspan="2" class="bg-gece"><div class="baslik-dik">Toplam Gece √áalƒ±≈ümasƒ± (Saat)</div></th></tr>`;
            tr2 += `</tr>`;

            h += tr1 + tr2 + `</thead><tbody>`;

            list.forEach((p, index)=>{
                let tcNo = ""; let ad = p.n; let soyad = "";
                if (p.n.includes("-")) {
                    let parts = p.n.split("-"); tcNo = parts[0].trim(); let tamIsim = parts[1].trim(); let isimParcalari = tamIsim.split(" ");
                    if(isimParcalari.length > 1) { soyad = isimParcalari.pop(); ad = isimParcalari.join(" "); } else { ad = tamIsim; }
                }
                h+=`<tr>
                    <td class="kalin-yatay" contenteditable="true">${globalIndex++}</td>
                    <td class="kalin-yatay" contenteditable="true">${tcNo}</td>
                    <td class="isim-yatay" contenteditable="true">${ad}</td>
                    <td class="isim-yatay" contenteditable="true">${soyad}</td>
                    <td class="kalin-yatay" contenteditable="true">0</td>`;
                
                days.forEach((d, idx)=>{
                    let v = p.data[getKey(d)] || ""; 
                    let info = getVardiyaInfo(v); 
                    let bg=(d.getDay()===0||d.getDay()===6)?'hucre-haftasonu':''; 
                    if(info.tip==='izin') bg='hucre-izin';
                    
                    // ONFOCUS VE ONBLUR ƒ∞LE KLAVYE/HESAP DOSTU Sƒ∞STEM EKLENDƒ∞
                    h+=`<td contenteditable="true" class="veri-hucre ${bg}" onfocus="temizleFormat(this)" onblur="uygulaFormat(this)" oninput="satirHesapla(this)">${formatliVardiya(v)}</td>`;
                    
                    if(d.getDay()===0 || idx === days.length - 1){
                        h+=`<th class="bg-hafta veri-hucre kalin-yatay" data-type="h-gun"></th>
                            <th class="bg-hafta veri-hucre kalin-yatay" data-type="h-saat"></th>
                            <th class="bg-hafta veri-hucre kalin-yatay" style="color:red;" data-type="h-fm"></th>`;
                    }
                });
                HDR.forEach(b => { h += `<th class="bg-genel kalin-yatay ${b.c}" ${b.c === 's-isg' ? 'contenteditable="true"' : ''}>0</th>`; });
                h += `<th class="bg-gece kalin-yatay s-gecefm">0</th><th class="bg-gece kalin-yatay s-gece">0</th></tr>`;
            });

            h+=`</tbody>
            <tfoot>
                <tr><td colspan="${toplamSutun}" style="border: none; text-align: left; padding-top: 5px;"><div style="font-size: 10px; font-weight: bold; color: #2c3e50;">NOT: "Fazla Mesai Saat" = Haftalƒ±k 45 Saati A≈üan Mesailer Toplamƒ±dƒ±r.</div></td></tr>
                <tr><td colspan="${toplamSutun}" style="border: none; text-align: center; font-weight: bold; font-size: 11px; padding: 5px 0;">A√áIKLAMALAR</td></tr>
                <tr><td colspan="${toplamSutun}" style="border: 1px solid #000; text-align: left; font-size: 10px; padding: 6px;" contenteditable="true"><strong>1-</strong> (A√ßƒ±klamalarƒ±nƒ±zƒ± buraya yazƒ±n...)</td></tr>
                <tr>
                    <td colspan="${Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 12px; padding-top: 30px;" contenteditable="true"><strong>D√ºzenleyen</strong><br>TEMƒ∞ZLƒ∞K Birim Sorumlusu<br><br><br>...................</td>
                    <td colspan="${Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 12px; padding-top: 30px;" contenteditable="true"><strong>Kontrol Eden</strong><br>ƒ∞DARƒ∞ VE MALƒ∞ ƒ∞≈ûLER M√ºd√ºr Yardƒ±mcƒ±sƒ±<br><br><br>...................</td>
                    <td colspan="${toplamSutun - 2*Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 12px; padding-top: 30px;" contenteditable="true"><strong>Onaylayan</strong><br>ƒ∞DARƒ∞ VE MALƒ∞ ƒ∞≈ûLER M√ºd√ºr√º<br><br><br>...................</td>
                </tr>
            </tfoot>
            </table></div>`;
            sayfaHtml+=h;
        }
    }
    document.getElementById('raporAlani').innerHTML = sayfaHtml;
    document.querySelectorAll('.veri-hucre').forEach(td => satirHesapla(td));
    document.getElementById('btnExceleKopyala').style.display = "block";
}

let isSelecting = false; let startCell = null; let selectedCells = [];
function getRowIdx(td) { return Array.from(td.parentNode.parentNode.children).indexOf(td.parentNode); }
function getColIdx(td) { let tr = td.parentNode; let idx = 0; for (let i = 0; i < tr.children.length; i++) { if (tr.children[i] === td) return idx; idx += parseInt(tr.children[i].getAttribute('colspan') || 1); } return idx; }
function clearSelection() { selectedCells.forEach(td => { if(td) td.classList.remove('selected-cell'); }); selectedCells = []; }
function selectRectangle(start, end) {
    clearSelection(); let r1 = getRowIdx(start), r2 = getRowIdx(end); let c1 = getColIdx(start), c2 = getColIdx(end);
    let minR = Math.min(r1, r2), maxR = Math.max(r1, r2); let minC = Math.min(c1, c2), maxC = Math.max(c1, c2);
    let rows = start.closest('tbody').children;
    for (let r = minR; r <= maxR; r++) { let tds = rows[r].children; for (let c = minC; c <= maxC; c++) { let td = tds[c]; if (td && td.style.display !== 'none' && !td.hasAttribute('colspan')) { td.classList.add('selected-cell'); selectedCells.push(td); } } }
}
document.addEventListener('mousedown', function(e) { if (e.button !== 0 || e.target.closest('#tableContextMenu')) return; if (e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) { isSelecting = true; startCell = e.target; clearSelection(); e.target.classList.add('selected-cell'); selectedCells.push(e.target); } else clearSelection(); });
document.addEventListener('mouseover', function(e) { if (isSelecting && e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) selectRectangle(startCell, e.target); });
document.addEventListener('mouseup', function() { isSelecting = false; });
document.addEventListener('contextmenu', function(e) { if (e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) { e.preventDefault(); if (!selectedCells.includes(e.target)) { clearSelection(); e.target.classList.add('selected-cell'); selectedCells.push(e.target); } let ctxMenu = document.getElementById('tableContextMenu'); ctxMenu.style.display = 'block'; ctxMenu.style.left = e.pageX + 'px'; ctxMenu.style.top = e.pageY + 'px'; } });

function mergeSelectedCells() {
    document.getElementById('tableContextMenu').style.display = 'none'; if (selectedCells.length <= 1) return clearSelection();
    selectedCells.sort((a, b) => { let rDiff = getRowIdx(a) - getRowIdx(b); return rDiff !== 0 ? rDiff : getColIdx(a) - getColIdx(b); });
    let mainCell = selectedCells[0]; let mergeId = "merge_" + Date.now();
    let isRowMerge = getRowIdx(selectedCells[0]) === getRowIdx(selectedCells[1]);
    if (isRowMerge) {
        let totalColSpan = 0; let mergedText = "";
        selectedCells.forEach((td, index) => { totalColSpan += parseInt(td.getAttribute('colspan') || 1); if(getCleanValue(td.innerText || td.textContent) !== "" && mergedText === "") mergedText = td.innerHTML; if (index > 0) { td.style.display = 'none'; td.setAttribute('data-merged-by', mergeId); } });
        mainCell.setAttribute('colspan', totalColSpan); mainCell.setAttribute('data-merge-id', mergeId); mainCell.innerHTML = mergedText;
    } else {
        let totalRowSpan = 0; let mergedText = "";
        selectedCells.forEach((td, index) => { totalRowSpan += parseInt(td.getAttribute('rowspan') || 1); if(getCleanValue(td.innerText || td.textContent) !== "" && mergedText === "") mergedText = td.innerHTML; if (index > 0) { td.style.display = 'none'; td.setAttribute('data-merged-by', mergeId); } });
        mainCell.setAttribute('rowspan', totalRowSpan); mainCell.setAttribute('data-merge-id', mergeId); mainCell.innerHTML = mergedText;
    }
    satirHesapla(mainCell); clearSelection();
}
function unmergeSelectedCells() {
    document.getElementById('tableContextMenu').style.display = 'none';
    selectedCells.forEach(td => {
        let mergeId = td.getAttribute('data-merge-id');
        if (mergeId) {
            td.removeAttribute('colspan'); td.removeAttribute('rowspan'); td.removeAttribute('data-merge-id');
            td.closest('tbody').querySelectorAll(`td[data-merged-by="${mergeId}"]`).forEach(hiddenTd => { hiddenTd.style.display = ''; hiddenTd.removeAttribute('data-merged-by'); satirHesapla(hiddenTd); });
        }
    });
    if(selectedCells.length > 0) satirHesapla(selectedCells[0]); clearSelection();
}

function shiftMasterdanCek() {
    let basInput = document.getElementById('inpTarihBas').value; let bitInput = document.getElementById('inpTarihBit').value;
    if(!basInput || !bitInput) return alert("Tarih se√ßin!");
    let btn = document.querySelector('button[onclick="shiftMasterdanCek()"]'); let oldText = btn.innerHTML;
    btn.innerHTML = "‚è≥ √áEKƒ∞Lƒ∞YOR..."; btn.style.pointerEvents = "none";
    let bas = getSafeDate(basInput); let bit = getSafeDate(bitInput);

    db.ref("arsivlenmis_shiftler").once("value").then(snap => {
        let data = snap.val(); if(!data) { alert("Buluta kayƒ±tlƒ± ar≈üiv bulunamadƒ±!"); btn.innerHTML = oldText; btn.style.pointerEvents = "auto"; return; }
        let personelShiftleri = {};
        Object.values(data).forEach(arsiv => {
            let tablolar = arsiv.tables ? arsiv.tables : (arsiv.data ? [arsiv] : []);
            tablolar.forEach(tablo => {
                let tBas = getSafeDate(tablo.startDate);
                tablo.data.forEach(satir => {
                    let isim = satir.name.trim().toUpperCase(); if(!personelShiftleri[isim]) personelShiftleri[isim] = {};
                    satir.shifts.forEach((shiftObj, index) => {
                        let suankiTarih = new Date(tBas.getTime()); suankiTarih.setDate(tBas.getDate() + index);
                        suankiTarih.setHours(0,0,0,0); let basCheck = new Date(bas.getTime()); basCheck.setHours(0,0,0,0); let bitCheck = new Date(bit.getTime()); bitCheck.setHours(0,0,0,0);
                        if(suankiTarih >= basCheck && suankiTarih <= bitCheck) {
                            let tStr = `${String(suankiTarih.getDate()).padStart(2,'0')}.${String(suankiTarih.getMonth()+1).padStart(2,'0')}.${suankiTarih.getFullYear()}`;
                            if(shiftObj.text) personelShiftleri[isim][tStr] = shiftObj.text;
                        }
                    });
                });
            });
        });
        
        let days = []; let d = new Date(bas.getTime()); d.setHours(0,0,0,0); let bitCheck2 = new Date(bit.getTime()); bitCheck2.setHours(0,0,0,0);
        while(d <= bitCheck2) { days.push(`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`); d.setDate(d.getDate() + 1); }
        let excelStr = "AD SOYAD\t" + days.join("\t") + "\n";
        Object.keys(personelShiftleri).forEach(isim => { let satirStr = isim; days.forEach(t => satirStr += "\t" + (personelShiftleri[isim][t] || "")); excelStr += satirStr + "\n"; });
        document.getElementById('inpExcel').value = excelStr;
        btn.innerHTML = "‚úÖ BA≈ûARILI"; setTimeout(() => { btn.innerHTML = oldText; btn.style.pointerEvents = "auto"; }, 2000);
        raporuOlustur();
    });
}

function exceleSifirKayipsizIndir() {
    const tablolar = document.querySelectorAll('.veri-tablosu');
    if (tablolar.length === 0) return alert("L√ºtfen √∂nce tabloyu olu≈üturun.");

    let combinedHtml = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head>
        <meta charset="utf-8">
        <style>
            table { border-collapse: collapse; font-family: 'Arial', sans-serif; font-size: 11px; }
            td, th { border: 0.5pt solid black; text-align: center; vertical-align: middle; }
        </style>
        </head>
    <body>`;

    tablolar.forEach(tablo => {
        let clone = tablo.cloneNode(true);
        clone.querySelectorAll('script, button').forEach(el => el.remove());
        clone.querySelectorAll('td[style*="display: none"], th[style*="display: none"]').forEach(c => c.remove());

        clone.querySelectorAll('th, td').forEach(el => {
            let inlineStyle = `border: 0.5pt solid black; vertical-align: middle; `;
            
            if (el.classList.contains('bg-hafta')) inlineStyle += "background-color: #dff0d8;";
            else if (el.classList.contains('bg-genel')) inlineStyle += "background-color: #fcf3cf;";
            else if (el.classList.contains('bg-gece')) inlineStyle += "background-color: #e8daef;";
            else if (el.classList.contains('hucre-izin')) inlineStyle += "background-color: #fadbd8; color: #c0392b;";
            else if (el.classList.contains('hucre-haftasonu')) inlineStyle += "background-color: #f2f2f2;";

            if (el.classList.contains('kalin-yatay')) {
                inlineStyle += "font-weight: bold; font-size: 12px; text-align: center;";
            } else if (el.classList.contains('isim-yatay')) {
                inlineStyle += "font-weight: bold; font-size: 12px; text-align: left;";
            } else {
                inlineStyle += "text-align: center;";
            }

            if (el.hasAttribute('data-tarih')) {
                el.innerHTML = el.getAttribute('data-tarih');
                inlineStyle += "mso-rotate: 90; height: 75pt; white-space: nowrap; font-weight: bold;";
            }
            else if (el.hasAttribute('data-gun')) {
                el.innerHTML = el.getAttribute('data-gun');
                inlineStyle += "mso-rotate: 90; height: 60pt; white-space: nowrap; font-weight: normal; font-size: 9px;";
            }
            else {
                // Temizlenmi≈ü h√ºcre verisi
                let raw = el.innerText || el.textContent || "";
                raw = raw.trim();
                
                if (el.classList.contains('veri-hucre') && raw) {
                    raw = raw.replace(/\s+/g, '-').replace(/-+/g, '-');
                    el.innerHTML = raw;
                    inlineStyle += "mso-rotate: 90; height: 90pt; white-space: nowrap; font-weight: bold;";
                }
                else {
                    let dikeyBaslik = el.querySelector('.baslik-dik');
                    if (dikeyBaslik) {
                        el.innerHTML = dikeyBaslik.innerHTML;
                        inlineStyle += "mso-rotate: 90; height: 130pt; white-space: normal;";
                    }
                }
            }
            el.setAttribute('style', inlineStyle);
        });

        combinedHtml += clone.outerHTML + "<br><br><br>"; 
    });

    combinedHtml += "</body></html>";

    const blob = new Blob(['\ufeff' + combinedHtml], { type: 'application/vnd.ms-excel;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Hastane_Puantaj_Resmi_Format_Son_v2.xls';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
