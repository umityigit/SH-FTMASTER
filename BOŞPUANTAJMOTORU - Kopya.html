<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEMÄ°ZLÄ°K BÄ°RÄ°MÄ° PUANTAJ SÄ°STEMÄ° v127 (DÄ°NAMÄ°K BUTONLAR & HIZLI EKLE/SÄ°L)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --green: #27ae60; --orange: #e67e22; --red: #c0392b; --blue: #2980b9; --dark: #1a252f; }
        body { margin: 0; background: #eef2f5; font-family: 'Roboto', sans-serif; }

        #mainContent { display: block; padding-bottom: 50px; }
        
        /* === YENÄ° NESÄ°L BUTONLU ANA EKRAN === */
        .hero-search { background: white; padding: 30px 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; margin: 20px auto; width: 95%; max-width: 1200px; border-top: 8px solid var(--orange); }
        .hero-title { color: var(--primary); margin-top: 0; font-size: 26px; text-transform: uppercase; }
        .hero-desc { color: #7f8c8d; font-size: 15px; margin-bottom: 20px; }
        
        .hero-input-group { display: inline-block; text-align: left; margin: 10px 15px; }
        .hero-label { font-weight: bold; font-size: 14px; color: var(--blue); margin-bottom: 8px; display: block; text-transform: uppercase; text-align: center;}
        .hero-input { font-size: 18px; padding: 12px 20px; border: 2px solid #bdc3c7; border-radius: 8px; width: 200px; text-align: center; font-weight: bold; color: var(--primary); transition: 0.3s; }
        
        /* KÄ°ÅÄ° BUTONLARI VE KART TASARIMI (YENÄ°) */
        .personel-grid { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 15px; }
        .personel-card { position: relative; display: inline-block; }
        
        .btn-kisi { background: white; border: 2px solid #bdc3c7; color: var(--primary); padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.2s; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        .btn-kisi:hover { background: var(--blue); border-color: var(--blue); color: white; transform: translateY(-3px); box-shadow: 0 6px 12px rgba(41, 128, 185, 0.3); }
        .btn-kisi:active { transform: translateY(0); }
        
        /* Ã‡Ã–P TENEKESÄ° ROZETÄ° */
        .btn-sil-badge { position: absolute; top: -8px; right: -8px; background: var(--red); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: 0.2s; z-index: 10; opacity: 0.6; }
        .btn-sil-badge:hover { transform: scale(1.3); opacity: 1; }
        
        /* YENÄ° KÄ°ÅÄ° EKLE BUTONU */
        .btn-yeni-kisi { background: #f8f9fa; border: 2px dashed var(--green); color: var(--green); }
        .btn-yeni-kisi:hover { background: var(--green); border-color: var(--green); color: white; }

        .grup-baslik { width: 100%; text-align: center; font-size: 16px; color: var(--orange); font-weight: bold; margin-top: 25px; margin-bottom: 10px; border-bottom: 2px dashed #eee; padding-bottom: 5px; }

        .btn-tam-dokum { font-size: 18px; padding: 20px 40px; background: var(--green); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 35px; transition: 0.3s; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); width: 100%; max-width: 500px; display: block; margin-left: auto; margin-right: auto; }
        .btn-tam-dokum:hover { background: #219653; transform: scale(1.02); }

        .print-btn { font-size: 14px; padding: 12px 30px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.3s; }
        
        /* GÄ°ZLÄ° AYARLAR PANELÄ° */
        details summary::-webkit-details-marker { display:none; }
        .settings-panel { background: white; padding: 15px; border-radius: 10px; display: flex; gap: 15px; flex-wrap: wrap; border: 1px solid #ddd; margin-top: 10px;}
        
        .panel-col { flex: 1; min-width: 280px; display: flex; flex-direction: column; gap: 8px; position: relative; }
        h3 { margin: 0; font-size: 14px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: var(--primary); text-transform: uppercase; cursor: text;}
        .personel-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .modern-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; box-sizing: border-box;}
        .personel-listesi { height: 180px; overflow-y: auto; border: 1px solid #ddd; background: #fff; padding: 5px; border-radius: 5px; }
        .personel-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; border-bottom: 1px solid #f0f0f0; font-size: 11px; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-add { background: var(--green); padding: 5px 10px; }
        .btn-del { background: var(--red); padding: 2px 6px; font-size: 10px; }
        .btn-del-group { position: absolute; right: 0; top: 0; background: var(--red); padding: 2px 8px; font-size: 10px; }
        .btn-big { width: 100%; padding: 15px; font-size: 14px; margin-top: 5px; text-transform: uppercase; }
        .btn-org { background: var(--orange); } .btn-grn { background: var(--green); } .btn-blu { background: var(--blue); }
        .vardiya-chip { display:flex; align-items:center; background:#2ecc71; color:white; padding:6px 10px; border-radius:5px; font-size:11px; font-weight:bold; margin-bottom:5px;}
        .vardiya-chip.izin { background:#e74c3c; }
        .vardiya-del { margin-left:10px; cursor:pointer; font-size:12px;}

        /* TABLO ALANI */
        .sayfa-container { width: 100%; overflow-x: auto; padding-bottom: 20px; text-align: center; }
        .sayfa { background: white; padding: 20px; display: inline-block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-top: 20px; text-align: left; page-break-after: always; transition: all 0.3s;}
        table { width: 2350px !important; border-collapse: collapse; table-layout: fixed; border: 1px solid #000; margin: 0; padding: 0; user-select: none; }
        th, td { border: 1px solid #000; text-align: center; vertical-align: middle; padding: 1px; line-height: 1.1; word-break: break-word; overflow: visible; }
        
        .veri-hucre { height: 75px !important; padding: 0 !important; cursor: text; transition: all 0.2s;}
        .veri-hucre:focus { background: #fff9c4 !important; outline: 2px solid #e67e22; font-size: 14px; font-weight: bold; }
        .dik-yazi { writing-mode: vertical-lr; transform: rotate(180deg); font-size: 11px; font-weight: bold; white-space: nowrap; display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; pointer-events: none; }
        .selected-cell { background-color: #d0ebff !important; outline: 2px solid #1c7ed6 !important; z-index: 10; }
        .ctx-item { padding: 8px 15px; font-size: 13px; cursor: pointer; transition: 0.2s; font-family: 'Roboto', sans-serif; color: #333; }
        .ctx-item:hover { background-color: #f1f3f5; color: var(--blue); }

        col.c-sno { width: 35px; } col.c-tc { width: 100px; } col.c-isim { width: 130px; } col.c-gun { width: 38px; } 
        .kalin-yatay { font-weight: bold !important; font-size: 11px !important; text-align: center; padding: 2px !important; }
        .isim-yatay { font-weight: bold !important; font-size: 11px !important; text-align: left; padding-left: 3px !important; }
        th { background: #eee; padding: 2px; font-size: 10px; }
        
        .bg-hafta { background-color: #dff0d8 !important; border-left: 2px solid #000; }
        .bg-genel { background-color: #fcf3cf !important; border-left: 2px solid #000; }
        .bg-gece { background-color: #e8daef !important; border-left: 2px solid #000; }
        .hucre-izin { background-color: #fadbd8 !important; color: #c0392b; font-weight: bold; }
        .hucre-haftasonu { background-color: #f2f2f2 !important; }
        
        .baslik-dik { writing-mode: vertical-lr; transform: rotate(180deg); white-space: nowrap; margin: auto; font-size: 11px; font-weight: bold; padding: 2px 0; }
        .baslik-dik-kucuk { writing-mode: vertical-lr; transform: rotate(180deg); white-space: nowrap; margin: auto; font-size: 9px; font-weight: normal; padding: 2px 0; color: #444; }

        #btnExceleKopyala { position: fixed; bottom: 20px; right: 20px; background: #27ae60; color: white; border: none; padding: 15px 25px; border-radius: 50px; font-size: 14px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: none; z-index: 100000; transition: 0.3s; }
        #btnExceleKopyala:hover { background: #219653; transform: scale(1.05); }

        @media print {
            @page { size: A4 landscape; margin: 5mm; } 
            body { zoom: 50%; margin: 0; padding: 0; background: white; } 
            .hero-search, details, #tableContextMenu, #btnExceleKopyala { display: none !important; }
            #mainContent { display: block !important; overflow: visible; padding:0; margin:0;}
            .sayfa-container { overflow: visible; width: 100%; padding:0;}
            .sayfa { margin: 0; padding: 0; width: 100%; border: none; box-shadow: none; page-break-after: always; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            tr { page-break-inside: avoid; }
            .selected-cell { outline: none !important; background-color: inherit !important; } 
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="mainContent">
    
    <div class="hero-search">
        <h1 class="hero-title">ğŸ“‹ HIZLI PUANTAJ PANELÄ°</h1>
        <p class="hero-desc">Ä°ÅŸlem yapmak istediÄŸiniz personelin Ã¼zerine tÄ±klayÄ±n veya alt kÄ±sÄ±mdan tam dÃ¶kÃ¼m alÄ±n.<br><em>Yeni personel eklemek iÃ§in listenin sonundaki <b>ğŸ‘¤+ EKLE</b> butonunu, silmek iÃ§in ismin kÃ¶ÅŸesindeki <b>ğŸ—‘ï¸ Ã‡Ã¶p Tenekesi</b>ni kullanabilirsiniz.</em></p>
        
        <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 20px;">
            <div class="hero-input-group">
                <label class="hero-label">BAÅLANGIÃ‡</label>
                <input type="date" id="inpTarihBas" class="hero-input">
            </div>
            <div class="hero-input-group">
                <label class="hero-label">BÄ°TÄ°Å</label>
                <input type="date" id="inpTarihBit" class="hero-input">
            </div>
        </div>

        <div id="personelButonAlani" class="personel-grid"></div>

        <button id="btnTamDokum" onclick="veriyiCekVeOlustur('')" class="btn-tam-dokum">ğŸ“„ TÃœM LÄ°STENÄ°N TAM DÃ–KÃœMÃœNÃœ AL</button>
        
        <div>
            <button onclick="window.print()" class="print-btn">ğŸ–¨ï¸ HAZIRLANAN RAPORU YAZDIR</button>
        </div>
    </div>

    <details style="margin: 20px auto; width: 95%; max-width: 1200px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <summary style="padding: 15px; font-weight: bold; font-size: 14px; color: #7f8c8d; cursor: pointer; border-left: 5px solid #bdc3c7; border-radius: 10px; outline: none;">
            âš™ï¸ GELÄ°ÅMÄ°Å AYARLAR (YÃ¶netici Paneli - TÄ±klayÄ±n)
        </summary>
        <div class="settings-panel">
            <div style="width:100%; padding-bottom:5px; border-bottom:2px solid #eee; margin-bottom:10px;">
                <h3 style="border:none; padding:0; display:inline-block; color:var(--orange);">VARDÄ°YA YÃ–NETÄ°MÄ°</h3>
            </div>
            <div style="width:100%; display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                <div style="flex:2; min-width: 150px;">
                    <label style="font-size:10px; font-weight:bold;">Vardiya AdÄ± / Kodu</label>
                    <input type="text" id="vAd" class="modern-input" placeholder="Ã–rn: 08:00-20:00 veya NÄ°">
                </div>
                <div style="flex:1; min-width: 80px;">
                    <label style="font-size:10px; font-weight:bold;">Toplam Saat</label>
                    <input type="number" id="vSaat" class="modern-input" placeholder="Ã–rn: 11" step="0.5">
                </div>
                <div style="flex:1; min-width: 80px;">
                    <label style="font-size:10px; font-weight:bold;">Gece Saati</label>
                    <input type="number" id="vGece" class="modern-input" placeholder="Ã–rn: 0" step="0.5">
                </div>
                <div style="flex:1.5; min-width: 120px;">
                    <label style="font-size:10px; font-weight:bold;">TÃ¼r</label>
                    <select id="vTip" class="modern-input">
                        <option value="calisma">Ã‡alÄ±ÅŸma / Mesai</option>
                        <option value="izin">Ä°zin / Ä°stirahat</option>
                    </select>
                </div>
                <div>
                    <button onclick="vardiyaEkle()" class="btn-big btn-grn" style="margin:0; padding:8px 20px;">EKLE</button>
                </div>
            </div>
            <div id="vardiyaListesi" style="width:100%; display:flex; gap:8px; flex-wrap:wrap; margin-top:5px;"></div>
            
            <div id="dynamicGroups" style="display: flex; gap: 15px; flex-wrap: wrap; width: 100%; margin-top: 15px; border-top: 2px solid #eee; padding-top: 15px;"></div>
            <div class="panel-col" style="flex:1; min-width: 250px; justify-content: center; align-items: center; border: 2px dashed #ccc; border-radius: 10px; padding: 20px;">
                <button onclick="yeniGrupEkle()" class="btn-big btn-blu">+ YENÄ° GRUP EKLE</button>
            </div>
            
            <textarea id="inpExcel" style="display:none;"></textarea>
        </div>
    </details>

    <div class="sayfa-container" id="raporScrollNoktasi">
        <div id="raporAlani"></div>
    </div>
</div>

<button id="btnExceleKopyala" onclick="exceleSifirKayipsizIndir()">ğŸ“¥ EXCEL DOSYASI Ä°NDÄ°R</button>

<div id="tableContextMenu" style="display:none; position:absolute; background:white; border:1px solid #ced4da; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:99999; border-radius:5px; overflow:hidden;">
    <div class="ctx-item" onclick="mergeSelectedCells()">ğŸ”— SeÃ§ili HÃ¼creleri BirleÅŸtir</div>
    <div style="border-bottom: 1px solid #eee;"></div>
    <div class="ctx-item" onclick="unmergeSelectedCells()">âœ‚ï¸ HÃ¼cre BirleÅŸtirmesini AyÄ±r</div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyAAqT74kCwyr6ZULTR_ClRDJ5Iu4AhmXJQ", databaseURL: "https://shiftmaster1-7fc5f-default-rtdb.europe-west1.firebasedatabase.app", projectId: "shiftmaster1-7fc5f" };
firebase.initializeApp(firebaseConfig); const db = firebase.database();

document.addEventListener('DOMContentLoaded', function() {
    let bugun = new Date();
    let bas = new Date(bugun.getFullYear(), bugun.getMonth(), 15);
    let bit = new Date(bugun.getFullYear(), bugun.getMonth() + 1, 14);
    
    document.getElementById('inpTarihBas').value = `${bas.getFullYear()}-${String(bas.getMonth()+1).padStart(2,'0')}-${String(bas.getDate()).padStart(2,'0')}`;
    document.getElementById('inpTarihBit').value = `${bit.getFullYear()}-${String(bit.getMonth()+1).padStart(2,'0')}-${String(bit.getDate()).padStart(2,'0')}`;
    
    bulutBaglantisiniKur();
});

const DEFAULT_VARDIYALAR = { 
    "08:00-18:00":{t:9,g:0, tip:"calisma"}, "08:00-20:00":{t:11,g:0, tip:"calisma"}, "08:00-16:00":{t:7.5,g:0, tip:"calisma"}, 
    "20:00-08:00":{t:11,g:11, tip:"calisma"}, "16:00-24:00":{t:7.5,g:4, tip:"calisma"}, "24:00-08:00":{t:7.5,g:6, tip:"calisma"}, 
    "HT":{t:0,g:0, tip:"izin"}, "YÄ°":{t:0,g:0, tip:"izin"}, "R":{t:0,g:0, tip:"izin"}, "Ä°":{t:0,g:0, tip:"izin"}, 
    "NÄ°":{t:0,g:0, tip:"izin"}, "RT":{t:0,g:0, tip:"izin"}, "RTÃ‡":{t:9,g:0, tip:"calisma"} 
};

let appData = { gruplar: [], vardiyalar: null };

function ilkKurulumuYap() {
    appData = { gruplar: [], vardiyalar: DEFAULT_VARDIYALAR };
    const genelListe = [
        "10006543166 - NEJLA NÄ°LÄ°", "10580422338 - TAYYÄ°P DOÄAN", "11620640910 - ZELÄ°HA ERSOY", "12547486254 - MEHMET OÄUZ DÃ–ÄÃœN", 
        "13097253044 - ORHAN KAHRAMAN", "14671540086 - GÃœLBAHAR ÃœNVER", "15097363778 - MERVE Ã–Z", "15958477590 - NAZMÄ°YE DURAN", 
        "16015509254 - SONGÃœL ERDOÄAN", "16709091126 - GÃœLLÃœ TOSUN", "16900491572 - SONGÃœL DÄ°LEK", "19589057206 - SEDA YILMAZ", 
        "19741371508 - Ã–ZLEM DURSUN", "21283980216 - ÅAHABETTÄ°N ORHAN", "22918496584 - HATÄ°CE YILDIRIM", "24475058656 - ZEYNEP BOZAN", 
        "25282186846 - BURCU DERELÄ°OÄLU", "25624852712 - SONGÃœL Ã–ZTÃœRK", "26872123876 - HURÄ°YE ELMAS", "27091143096 - KADÄ°R GAMSIZ", 
        "28543103354 - AYÅE BOZKAYA", "29386066998 - SAFÄ°YE DENECÄ°", "30163049264 - ADEM KÃ–MÃœR", "30623331236 - SADIK MACÄ°T", 
        "30937798466 - ALÄ° GENÃ‡EL", "37927835576 - HALÄ°L VAR", "40186499618 - DENÄ°Z USLU", "45925910836 - ENES ABDULLAH ALTUN", 
        "53164244964 - MAKBULE DENK", "58708122418 - MUSTAFA DÄ°K", "61585026564 - FATMA Ã‡ALIÅKAN", "10588692368 - ÃœMÄ°T YÄ°ÄÄ°T", 
        "21604545568 - NUSRETTÄ°N Ã–ZSOY", "23665254878 - ÃœMMÃœ KURU", "26542158924 - HAFÄ°SE DÄ°KMEN", "29056059848 - FATMA IÅIK", 
        "30328031684 - BURAK TURAN", "32827531146 - HATÄ°CE KARAKUÅ", "00000000000 - FATMA KOÃ‡AR", "10546692058 - HAFÄ°ZE Ã–NAL", 
        "23467244800 - FUNDA POYRAZ", "62074286230 - BETÃœL ÅÄ°MÅEK"
    ];
    appData.gruplar = [{ id: "g_1", ad: "DÃ–ÅEMEALTI DEVLET HASTANESÄ°", kisiler: genelListe }];
    veriKaydet(); 
}

function bulutBaglantisiniKur() {
    db.ref("puantaj_v115_zorunlu_gecis").once("value", snap => {
        if(!snap.val()) {
            ilkKurulumuYap();
            db.ref("puantaj_v115_zorunlu_gecis").set(true);
            arayuzCiz(); vardiyaArayuzCiz();
        } else {
            db.ref("puantaj_motoru_ayarlar").on("value", snap => {
                let data = snap.val();
                if(data) {
                    appData = data;
                    if (!appData.vardiyalar) appData.vardiyalar = DEFAULT_VARDIYALAR;
                    if (!appData.gruplar || appData.gruplar.length === 0) appData.gruplar = [{ id: "g_1", ad: "HASTANE PERSONELÄ°", kisiler: [] }];
                    arayuzCiz();
                    vardiyaArayuzCiz();
                    anaEkranaButonlariCiz(); 
                } else {
                    ilkKurulumuYap();
                }
            });
        }
    });
}

function veriKaydet() { db.ref("puantaj_motoru_ayarlar").set(appData); }

function vardiyaEkle() {
    let kod = document.getElementById("vAd").value.trim().toUpperCase();
    let t = parseFloat(document.getElementById("vSaat").value) || 0;
    let g = parseFloat(document.getElementById("vGece").value) || 0;
    let tip = document.getElementById("vTip").value;
    if(!kod) return alert("Vardiya adÄ± boÅŸ olamaz!");
    appData.vardiyalar[kod] = { t: t, g: g, tip: tip };
    veriKaydet(); 
}

function vardiyaSil(kod) { if(confirm(kod + " silinsin mi?")) { delete appData.vardiyalar[kod]; veriKaydet(); } }

function vardiyaArayuzCiz() {
    const root = document.getElementById("vardiyaListesi"); root.innerHTML = "";
    for(let v in appData.vardiyalar) {
        let info = appData.vardiyalar[v];
        let cClass = info.tip === 'izin' ? 'izin' : 'calisma';
        let desc = info.tip === 'calisma' ? `(${info.t}s / G:${info.g}s)` : '(Ä°zin)';
        root.innerHTML += `<div class="vardiya-chip ${cClass}"><span>${v} ${desc}</span><span class="vardiya-del" onclick="vardiyaSil('${v}')">âœ–</span></div>`;
    }
}

// ==== YENÄ°: ANA EKRANA SÄ°LME VE EKLEME BUTONLARIYLA LÄ°STEYÄ° DÄ°ZEN FONKSÄ°YON ====
function anaEkranaButonlariCiz() {
    const container = document.getElementById("personelButonAlani");
    container.innerHTML = "";
    
    appData.gruplar.forEach(grup => {
        let html = `<div style="width: 100%;"><div class="grup-baslik">ğŸ¢ ${grup.ad} PERSONEL LÄ°STESÄ°</div><div class="personel-grid">`;
        
        if(grup.kisiler && grup.kisiler.length > 0) {
            // KiÅŸileri alfabetik sÄ±ralayÄ±p kart yap
            grup.kisiler.sort((a,b) => {
                let isimA = a.includes("-") ? a.split("-")[1].trim() : a;
                let isimB = b.includes("-") ? b.split("-")[1].trim() : b;
                return isimA.localeCompare(isimB, 'tr');
            }).forEach((isimTam) => {
                let sadeceIsim = isimTam.includes("-") ? isimTam.split("-")[1].trim() : isimTam;
                let guvenliIsimTam = isimTam.replace(/'/g, "\\'"); // JS HatasÄ±nÄ± Ã¶nlemek iÃ§in tÄ±rnak korumasÄ±
                
                html += `
                <div class="personel-card">
                    <button class="btn-kisi" onclick="veriyiCekVeOlustur('${sadeceIsim}')">ğŸ‘¤ ${sadeceIsim}</button>
                    <button class="btn-sil-badge" title="Bu Personeli Listeden Sil" onclick="anaEkrandanPersonelSil('${grup.id}', '${guvenliIsimTam}')">ğŸ—‘ï¸</button>
                </div>`;
            });
        }
        
        // GRUBUN SONUNA 'YENÄ° KÄ°ÅÄ° EKLE' BUTONU KOY
        html += `
            <div class="personel-card">
                <button class="btn-kisi btn-yeni-kisi" title="Bu Gruba Yeni KiÅŸi Ekle" onclick="anaEkrandanPersonelEkle('${grup.id}')">ğŸ‘¤+ EKLE</button>
            </div>
        `;
        
        html += `</div></div>`;
        container.innerHTML += html;
    });
}

// ==== YENÄ°: ANA EKRANDAN HIZLI EKLEME VE SÄ°LME Ä°ÅLEMLERÄ° ====
function anaEkrandanPersonelEkle(grupId) {
    let isim = prompt("LÃ¼tfen eklenecek personelin T.C. Kimlik numarasÄ±nÄ± ve AdÄ±nÄ± girin.\n(Ã–rn: 12345678912 - AHMET YILMAZ)\nEÄŸer TC'sini bilmiyorsanÄ±z sadece adÄ±nÄ± da yazabilirsiniz.");
    
    if(isim && isim.trim() !== "") {
        isim = isim.trim().toUpperCase('tr');
        let grup = appData.gruplar.find(g => g.id === grupId);
        if(!grup.kisiler) grup.kisiler = [];
        
        if(!grup.kisiler.includes(isim)) {
            grup.kisiler.push(isim);
            veriKaydet(); 
        } else {
            alert("Bu personel zaten listede ekli!");
        }
    }
}

function anaEkrandanPersonelSil(grupId, isimTam) {
    let sadeceIsim = isimTam.includes("-") ? isimTam.split("-")[1].trim() : isimTam;
    
    if(confirm(`âš ï¸ DÄ°KKAT!\n\n${sadeceIsim} isimli personeli listeden silmek istediÄŸinize emin misiniz?`)) {
        let grup = appData.gruplar.find(g => g.id === grupId);
        grup.kisiler = grup.kisiler.filter(k => k !== isimTam);
        veriKaydet();
    }
}
// ==========================================================

function getCleanValue(text) { 
    if(!text) return ""; 
    return text.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '').trim().toUpperCase(); 
}

function temizleFormat(td) {
    let metin = td.innerText || td.textContent || "";
    metin = metin.trim();
    td.innerHTML = metin; 
}

function uygulaFormat(td) {
    let metin = getCleanValue(td.innerText || td.textContent);
    if (metin !== "") {
        td.innerHTML = `<div class="dik-yazi">${metin}</div>`;
    } else {
        td.innerHTML = "";
    }
    satirHesapla(td); 
}

function formatliVardiya(val) { 
    if(!val) return ""; 
    val = val.trim(); 
    return `<div class="dik-yazi">${val}</div>`;
}

function getVardiyaInfo(val) {
    if (!val) return {t:0, g:0, tip:"bilinmeyen", val:""};
    let cleanVal = val.replace(/<br\s*\/?>/gi, "-").trim().toUpperCase(); 
    if (appData.vardiyalar && appData.vardiyalar[cleanVal]) return { ...appData.vardiyalar[cleanVal], val: cleanVal };
    let valWithHyphen = cleanVal.replace(/[\s\n\r]+/g, "-");
    if (appData.vardiyalar && appData.vardiyalar[valWithHyphen]) return { ...appData.vardiyalar[valWithHyphen], val: valWithHyphen };
    return {t:0, g:0, tip:"bilinmeyen", val: cleanVal};
}

function yeniGrupEkle() { appData.gruplar.push({ id: "g_" + Date.now(), ad: "YENÄ° BÄ°RÄ°M / HASTANE", kisiler: [] }); veriKaydet(); }
function grupSil(id) { if (confirm("Grup silinsin mi?")) { appData.gruplar = appData.gruplar.filter(g => g.id !== id); veriKaydet(); } }
function grupAdiGuncelle(id, ad) { let g = appData.gruplar.find(g => g.id === id); if (g) { g.ad = ad.trim() || "Ä°SÄ°MSÄ°Z GRUP"; veriKaydet(); } }

function personelEkle(grupId) {
    let input = document.getElementById("add_" + grupId); let isim = input.value.trim().toUpperCase();
    let grup = appData.gruplar.find(g => g.id === grupId);
    if(!grup.kisiler) grup.kisiler = [];
    if (isim && grup && !grup.kisiler.includes(isim)) { grup.kisiler.push(isim); veriKaydet(); }
    input.value = "";
}
function personelSil(gId, isim) { if (confirm("Silinsin mi?")) { let g = appData.gruplar.find(g => g.id === gId); g.kisiler = g.kisiler.filter(k => k !== isim); veriKaydet(); } }

function arayuzCiz() {
    const container = document.getElementById("dynamicGroups"); container.innerHTML = "";
    appData.gruplar.forEach(grup => {
        let html = `
        <div class="panel-col">
            <button class="btn-del-group" onclick="grupSil('${grup.id}')">X</button>
            <h3 contenteditable="true" onblur="grupAdiGuncelle('${grup.id}', this.innerText)">${grup.ad}</h3>
            <div class="personel-row"><input type="text" id="add_${grup.id}" class="modern-input" placeholder="12345678912 - PERSONEL ADI..." onkeypress="if(event.key==='Enter') personelEkle('${grup.id}')"><button onclick="personelEkle('${grup.id}')" class="btn-add">+</button></div>
            <div class="personel-listesi">`;
        if(grup.kisiler) {
            grup.kisiler.sort((a,b) => {
                let isimA = a.includes("-") ? a.split("-")[1].trim() : a;
                let isimB = b.includes("-") ? b.split("-")[1].trim() : b;
                return isimA.localeCompare(isimB, 'tr');
            }).forEach((isim) => {
                html += `<div class="personel-item"><span>${isim}</span><button onclick="personelSil('${grup.id}', '${isim}')" class="btn-del">X</button></div>`;
            });
        }
        container.innerHTML += html + `</div></div>`;
    });
}

function getSafeDate(val) {
    if (!val) return new Date();
    val = val.trim();
    let p;
    if (val.includes('-')) p = val.split('-');
    else if (val.includes('.')) p = val.split('.');
    else if (val.includes('/')) p = val.split('/');
    else return new Date(val);
    if (p && p.length === 3) {
        let y = parseInt(p[0].length === 4 ? p[0] : p[2]);
        let m = parseInt(p[1]) - 1;
        let d = parseInt(p[0].length === 4 ? p[2] : p[0]);
        return new Date(y, m, d);
    }
    return new Date(val);
}

function tarihGuncelle(){ 
    let bas = getSafeDate(document.getElementById('inpTarihBas').value); 
    let bit = getSafeDate(document.getElementById('inpTarihBit').value); 
    let str = `${String(bas.getDate()).padStart(2,'0')}.${String(bas.getMonth()+1).padStart(2,'0')}.${bas.getFullYear()} - ${String(bit.getDate()).padStart(2,'0')}.${String(bit.getMonth()+1).padStart(2,'0')}.${bit.getFullYear()}`;
    return {bas, bit, str}; 
}
function getKey(d){return d.getFullYear()+(d.getMonth()+1).toString().padStart(2,'0')+d.getDate().toString().padStart(2,'0');}
function excelTarih(s){
    if(!s)return null; 
    s = s.trim();
    let m = s.match(/^(\d{1,2})[./](\d{1,2})[./](\d{4})$/); 
    if(m) return m[3]+m[2].padStart(2,'0')+m[1].padStart(2,'0');
    let m2 = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if(m2) return m2[1]+m2[2].padStart(2,'0')+m2[3].padStart(2,'0');
    return null;
}

function satirHesapla(td) {
    if (!td) return;
    const tr = td.closest('tr');
    if (!tr) return;

    const rawVal = getCleanValue(td.innerText || td.textContent);
    const info = getVardiyaInfo(rawVal);
    
    const manuelSaat = parseFloat(rawVal.replace(",", "."));
    const aktifSaat = (info && info.t > 0) ? info.t : (!isNaN(manuelSaat) ? manuelSaat : 0);

    td.classList.remove('hucre-izin');
    if (aktifSaat === 0 && rawVal !== "" && rawVal !== "0") {
        td.classList.add('hucre-izin');
    }

    let tAg = 0, n_rt = 0, n_ht = 0, n_r = 0, n_i = 0, n_rtc = 0, n_htc = 0, tAge = 0, tFM = 0;
    let wHs = 0, wHg = 0;

    const allCells = Array.from(tr.children);
    allCells.forEach(c => {
        if (c.style.display === 'none' || c.hasAttribute('data-merged-by')) return;

        if (c.classList.contains('veri-hucre') && !c.classList.contains('bg-hafta')) {
            const v = getCleanValue(c.innerText || c.textContent);
            if (v === "" || v === "0") return;

            const inf = getVardiyaInfo(v);
            const mS = parseFloat(v.replace(",", "."));
            const s = (inf && inf.t > 0) ? inf.t : (!isNaN(mS) ? mS : 0);

            tAg++; 
            if (v === "RT") n_rt++;
            else if (v === "HT" && s === 0) n_ht++;
            else if (v === "R") n_r++;
            else if (inf && inf.tip === "izin") n_i++;

            if (s > 0) {
                wHs += s;
                wHg++;
                tAge += (inf.g || 0);
                if (v === "RTÃ‡") n_rtc++;
                if (c.classList.contains('hucre-haftasonu')) n_htc++;
            }
        }

        if (c.classList.contains('bg-hafta')) {
            const type = c.getAttribute('data-type');
            if (type === 'h-gun') {
                c.innerText = wHg > 0 ? wHg : "";
            } else if (type === 'h-saat') {
                c.innerText = wHs > 0 ? Number(wHs.toFixed(2)) : "";
            } else if (type === 'h-fm') {
                let wFm = wHs > 45 ? (wHs - 45) : 0;
                c.innerText = wFm > 0 ? Number(wFm.toFixed(2)) : "";
                tFM += wFm; 
                wHs = 0; wHg = 0;
            }
        }
    });

    const update = (cls, v) => {
        const el = tr.querySelector(cls);
        if (el) el.innerText = (v === 0 || !v) ? "0" : Number(v.toFixed(2));
    };

    update('.s-calisma', tAg); update('.s-yol', tAg + n_rtc); update('.s-rapor', n_r);
    update('.s-izin', n_i); update('.s-ht', n_ht); update('.s-rt', n_rt);
    update('.s-rtc', n_rtc); update('.s-fm', tFM); update('.s-gecefm', 0); update('.s-gece', tAge);
}

function veriyiCekVeOlustur(arananIsim) {
    let basInput = document.getElementById('inpTarihBas').value; 
    let bitInput = document.getElementById('inpTarihBit').value;
    if(!basInput || !bitInput) return alert("LÃ¼tfen BaÅŸlangÄ±Ã§ ve BitiÅŸ Tarihi seÃ§in!");

    document.body.style.cursor = "wait";
    
    let bas = getSafeDate(basInput); 
    let bit = getSafeDate(bitInput);

    db.ref("arsivlenmis_shiftler").once("value").then(snap => {
        let data = snap.val(); 
        if(!data) { 
            alert("Buluta kayÄ±tlÄ± arÅŸiv bulunamadÄ±!"); 
            document.body.style.cursor = "default";
            return; 
        }
        
        let personelShiftleri = {};
        Object.values(data).forEach(arsiv => {
            let tablolar = arsiv.tables ? arsiv.tables : (arsiv.data ? [arsiv] : []);
            tablolar.forEach(tablo => {
                let tBas = getSafeDate(tablo.startDate);
                tablo.data.forEach(satir => {
                    let isim = satir.name.trim().toUpperCase(); if(!personelShiftleri[isim]) personelShiftleri[isim] = {};
                    satir.shifts.forEach((shiftObj, index) => {
                        let suankiTarih = new Date(tBas.getTime()); suankiTarih.setDate(tBas.getDate() + index);
                        suankiTarih.setHours(0,0,0,0); let basCheck = new Date(bas.getTime()); basCheck.setHours(0,0,0,0); let bitCheck = new Date(bit.getTime()); bitCheck.setHours(0,0,0,0);
                        if(suankiTarih >= basCheck && suankiTarih <= bitCheck) {
                            let tStr = `${String(suankiTarih.getDate()).padStart(2,'0')}.${String(suankiTarih.getMonth()+1).padStart(2,'0')}.${suankiTarih.getFullYear()}`;
                            if(shiftObj.text) personelShiftleri[isim][tStr] = shiftObj.text;
                        }
                    });
                });
            });
        });
        
        let days = []; let d = new Date(bas.getTime()); d.setHours(0,0,0,0); let bitCheck2 = new Date(bit.getTime()); bitCheck2.setHours(0,0,0,0);
        while(d <= bitCheck2) { days.push(`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`); d.setDate(d.getDate() + 1); }
        
        let excelStr = "AD SOYAD\t" + days.join("\t") + "\n";
        Object.keys(personelShiftleri).forEach(isim => { let satirStr = isim; days.forEach(t => satirStr += "\t" + (personelShiftleri[isim][t] || "")); excelStr += satirStr + "\n"; });
        
        document.getElementById('inpExcel').value = excelStr;
        
        raporuOlustur(arananIsim);
        document.body.style.cursor = "default";
        document.getElementById("raporScrollNoktasi").scrollIntoView({behavior: "smooth"});
    });
}

function raporuOlustur(filtreIsim) {
    const {bas,bit,str} = tarihGuncelle();
    let days=[]; let d=new Date(bas.getTime()); while(d<=bit){ days.push(new Date(d.getTime())); d.setDate(d.getDate()+1); }
    
    let arananKisi = filtreIsim ? filtreIsim.toUpperCase('tr') : "";
    
    let people = {};
    appData.gruplar.forEach(grup => {
        if(grup.kisiler) {
            grup.kisiler.forEach(n => { people[n] = { n: n, gId: grup.id, gAd: grup.ad, data: {} }; });
        }
    });

    const raw = document.getElementById('inpExcel').value.split('\n').filter(r=>r.trim());
    let map = {};
    raw.forEach(row => {
        let cols = row.split('\t'); let isHead=false, tmp={};
        cols.forEach((c,i)=>{ let k=excelTarih(c); if(k){tmp[k]=i; isHead=true;} });
        if(isHead) map=tmp;
        else {
            let textToSearch = cols.slice(0, 5).join(" ").toUpperCase();
            let matchedPersonKey = Object.keys(people).find(pKey => {
                let cleanPKey = pKey.includes("-") ? pKey.split("-")[1].trim() : pKey;
                cleanPKey = cleanPKey.replace(/\s\d+$/, '').replace(/\s+/g, ' ').trim(); 
                let normP = cleanPKey.replace(/Ä°/g,'I').replace(/Ä±/g,'i').replace(/Ã–/g,'O').replace(/Ãœ/g,'U').replace(/Å/g,'S').replace(/Ã‡/g,'C').replace(/Ä/g,'G');
                let normText = textToSearch.replace(/Ä°/g,'I').replace(/Ä±/g,'i').replace(/Ã–/g,'O').replace(/Ãœ/g,'U').replace(/Å/g,'S').replace(/Ã‡/g,'C').replace(/Ä/g,'G');
                return normText.includes(normP);
            });
            if(matchedPersonKey) {
                for(let k in map) {
                    let v = (cols[map[k]]||"").trim();
                    if(v) people[matchedPersonKey].data[k] = v;
                }
            }
        }
    });

    Object.values(people).forEach(p => {
        days.forEach(day => { let k = getKey(day); if(!p.data[k]) p.data[k] = (day.getDay()===0||day.getDay()===6) ? "HT" : "08:00-18:00"; });
    });

    const HDR = [
        {n:"Ã‡alÄ±ÅŸma GÃ¼nÃ¼", c:"s-calisma"}, {n:"Ä°ÅŸe Gelme GÃ¼nÃ¼(Yol)", c:"s-yol"}, {n:"Raporlu GÃ¼n SayÄ±sÄ±", c:"s-rapor"}, 
        {n:"Ä°zinli OlduÄŸu GÃ¼n SayÄ±sÄ±", c:"s-izin"}, {n:"Hafta Tatili ToplamÄ±(HT)", c:"s-ht"}, {n:"Resmi Tatil(Tam GÃ¼n)(RT)", c:"s-rt"}, 
        {n:"Resmi Tatil Ã‡alÄ±ÅŸmasÄ±(RTÃ‡)", c:"s-rtc"}, {n:"GÃ¼ndÃ¼z Fazla Mesai ToplamÄ±", c:"s-fm"}, {n:"Ä°Å SAÄLIÄI VE GÃœVENLÄ°ÄÄ° (YOL)", c:"s-isg"}
    ];
    
    let sayfaHtml = ""; 
    
    let gArr = Object.values(people).reduce((acc, p) => { 
        let tamAd = p.n.toUpperCase('tr');
        
        if (arananKisi !== "") {
            let normalizeAd = tamAd.replace(/Ä°/g,'I').replace(/Ä±/g,'i').replace(/Ã–/g,'O').replace(/Ãœ/g,'U').replace(/Å/g,'S').replace(/Ã‡/g,'C').replace(/Ä/g,'G');
            let normalizeAranan = arananKisi.replace(/Ä°/g,'I').replace(/Ä±/g,'i').replace(/Ã–/g,'O').replace(/Ãœ/g,'U').replace(/Å/g,'S').replace(/Ã‡/g,'C').replace(/Ä/g,'G');
            if(!normalizeAd.includes(normalizeAranan)) {
                return acc; 
            }
        }

        acc[p.gAd] = acc[p.gAd]||[]; 
        acc[p.gAd].push(p); 
        return acc; 
    }, {});
    
    if(Object.keys(gArr).length === 0) {
        document.getElementById('raporAlani').innerHTML = `<h3 style="color:var(--red); font-size: 20px; padding: 30px; background: white; border-radius: 10px; margin-top:20px;">Sistemde veri bulunamadÄ±.</h3>`;
        document.getElementById('btnExceleKopyala').style.display = "none";
        return;
    }

    for(let gAd in gArr) {
        let fullList = gArr[gAd].sort((a,b) => {
            let isimA = a.n.includes("-") ? a.n.split("-")[1].trim() : a.n;
            let isimB = b.n.includes("-") ? b.n.split("-")[1].trim() : b.n;
            return isimA.localeCompare(isimB, 'tr');
        });
        
        let gunSutunSayisi = 0;
        days.forEach((d, idx) => {
            gunSutunSayisi++;
            if (d.getDay() === 0 || idx === days.length - 1) gunSutunSayisi += 3;
        });
        
        let toplamSutun = 5 + gunSutunSayisi + HDR.length + 2; 
        let chunkSize = 16;
        let globalIndex = 1;
        
        for (let i = 0; i < fullList.length; i += chunkSize) {
            let list = fullList.slice(i, i + chunkSize);

            let h = `<div class="sayfa"><table class="veri-tablosu" data-grup="${gAd}">
            <colgroup><col class="c-sno"><col class="c-tc"><col class="c-isim"><col class="c-isim"><col class="c-sno">`;
            
            days.forEach((d, idx)=>{ 
                h+=`<col class="c-gun">`; 
                if(d.getDay()===0 || idx === days.length - 1) h+=`<col class="c-gun"><col class="c-gun"><col class="c-gun">`; 
            });
            HDR.forEach(()=>h+=`<col class="c-gun">`);
            h+=`<col class="c-gun"><col class="c-gun"></colgroup><thead>
            
            <tr>
                <td colspan="${toplamSutun}" style="border: none !important; padding: 10px 0; text-align: left; font-size: 14px; font-weight: bold;">
                    ANTALYA Ä°L SAÄLIK MÃœDÃœRLÃœÄÃœ ${gAd.toUpperCase()} SÃœREKLÄ° Ä°ÅÃ‡Ä° PERSONEL PUANTAJ BÄ°LDÄ°RÄ°MÄ°
                </td>
            </tr>
            <tr>
                <td colspan="5" style="border: none !important; text-align: left; font-weight: bold; font-size: 11px; padding-bottom: 5px;">
                    BÄ°RÄ°M ADI    :   TEMÄ°ZLÄ°K
                </td>
                <td colspan="${toplamSutun - 5}" style="border: none !important; text-align: left; font-weight: bold; font-size: 11px; padding-bottom: 5px;">
                    ${str}
                </td>
            </tr>`;

            let tr1 = `<tr>
                <th rowspan="2"><div class="baslik-dik">SIRA NO</div></th>
                <th rowspan="2" class="kalin-yatay">T.C. KÄ°MLÄ°K NUMARASI</th>
                <th rowspan="2" class="isim-yatay">PERSONELÄ°N ADI</th>
                <th rowspan="2" class="isim-yatay">PERSONELÄ°N SOYADI</th>
                <th rowspan="2"><div class="baslik-dik">Devreden Ã‡alÄ±ÅŸma Saati</div></th>`;
            
            let tr2 = `<tr>`;

            let weekCount = 1;
            days.forEach((d, idx)=>{
                let tamTarihStr = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth()+1).padStart(2, '0')}.${d.getFullYear()}`;
                let gunAdi = d.toLocaleDateString('tr-TR', { weekday: 'long' }).toUpperCase();
                let bgStyle = (d.getDay()===0||d.getDay()===6) ? 'background:#eee;' : '';
                
                tr1 += `<th style="${bgStyle} padding: 1px;" data-tarih="${tamTarihStr}"><div class="baslik-dik">${tamTarihStr}</div></th>`;
                tr2 += `<th style="${bgStyle} padding: 1px;" data-gun="${gunAdi}"><div class="baslik-dik-kucuk">${gunAdi}</div></th>`;
                
                if(d.getDay()===0 || idx === days.length - 1) {
                    tr1 += `<th rowspan="2" class="bg-hafta"><div class="baslik-dik">${weekCount}-HaftalÄ±k Ä°ÅŸe Gelme GÃ¼nÃ¼</div></th>
                            <th rowspan="2" class="bg-hafta"><div class="baslik-dik">${weekCount}.Hafta ToplamÄ±</div></th>
                            <th rowspan="2" class="bg-hafta"><div class="baslik-dik">${weekCount}.Hafta Fazla Mesai</div></th>`;
                    weekCount++;
                }
            });

            HDR.forEach(b => { tr1 += `<th rowspan="2" class="bg-genel"><div class="baslik-dik">${b.n}</div></th>`; });
            tr1 += `<th rowspan="2" class="bg-gece"><div class="baslik-dik">Gece Fazla Mesai ToplamÄ± (Saat)</div></th><th rowspan="2" class="bg-gece"><div class="baslik-dik">Toplam Gece Ã‡alÄ±ÅŸmasÄ± (Saat)</div></th></tr>`;
            tr2 += `</tr>`;

            h += tr1 + tr2 + `</thead><tbody>`;

            list.forEach((p, index)=>{
                let tcNo = ""; let ad = p.n; let soyad = "";
                if (p.n.includes("-")) {
                    let parts = p.n.split("-"); tcNo = parts[0].trim(); let tamIsim = parts[1].trim(); let isimParcalari = tamIsim.split(" ");
                    if(isimParcalari.length > 1) { soyad = isimParcalari.pop(); ad = isimParcalari.join(" "); } else { ad = tamIsim; }
                }
                h+=`<tr>
                    <td class="kalin-yatay" contenteditable="true">${globalIndex++}</td>
                    <td class="kalin-yatay" contenteditable="true">${tcNo}</td>
                    <td class="isim-yatay" contenteditable="true">${ad}</td>
                    <td class="isim-yatay" contenteditable="true">${soyad}</td>
                    <td class="kalin-yatay" contenteditable="true">0</td>`;
                
                days.forEach((d, idx)=>{
                    let v = p.data[getKey(d)] || ""; 
                    let info = getVardiyaInfo(v); 
                    let bg=(d.getDay()===0||d.getDay()===6)?'hucre-haftasonu':''; 
                    if(info.tip==='izin') bg='hucre-izin';
                    
                    h+=`<td contenteditable="true" class="veri-hucre ${bg}" onfocus="temizleFormat(this)" onblur="uygulaFormat(this)" oninput="satirHesapla(this)">${formatliVardiya(v)}</td>`;
                    
                    if(d.getDay()===0 || idx === days.length - 1){
                        h+=`<th class="bg-hafta veri-hucre kalin-yatay" data-type="h-gun"></th>
                            <th class="bg-hafta veri-hucre kalin-yatay" data-type="h-saat"></th>
                            <th class="bg-hafta veri-hucre kalin-yatay" style="color:red;" data-type="h-fm"></th>`;
                    }
                });
                HDR.forEach(b => { h += `<th class="bg-genel kalin-yatay ${b.c}" ${b.c === 's-isg' ? 'contenteditable="true"' : ''}>0</th>`; });
                h += `<th class="bg-gece kalin-yatay s-gecefm">0</th><th class="bg-gece kalin-yatay s-gece">0</th></tr>`;
            });

            h+=`</tbody>
            <tfoot>
                <tr><td colspan="${toplamSutun}" style="border: none; text-align: left; padding-top: 5px;"><div style="font-size: 9px; font-weight: bold; color: #2c3e50;">NOT: "Fazla Mesai Saat" = HaftalÄ±k 45 Saati AÅŸan Mesailer ToplamÄ±dÄ±r.</div></td></tr>
                <tr><td colspan="${toplamSutun}" style="border: none; text-align: center; font-weight: bold; font-size: 11px; padding: 2px 0;">AÃ‡IKLAMALAR</td></tr>
                <tr><td colspan="${toplamSutun}" style="border: 1px solid #000; text-align: left; font-size: 10px; padding: 4px;" contenteditable="true"><strong>1-</strong> (AÃ§Ä±klamalarÄ±nÄ±zÄ± buraya yazÄ±n...)</td></tr>
                <tr>
                    <td colspan="${Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 11px; padding-top: 15px;" contenteditable="true"><strong>DÃ¼zenleyen</strong><br>TEMÄ°ZLÄ°K Birim Sorumlusu<br><br><br>...................</td>
                    <td colspan="${Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 11px; padding-top: 15px;" contenteditable="true"><strong>Kontrol Eden</strong><br>Ä°DARÄ° VE MALÄ° Ä°ÅLER MÃ¼dÃ¼r YardÄ±mcÄ±sÄ±<br><br><br>...................</td>
                    <td colspan="${toplamSutun - 2*Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 11px; padding-top: 15px;" contenteditable="true"><strong>Onaylayan</strong><br>Ä°DARÄ° VE MALÄ° Ä°ÅLER MÃ¼dÃ¼rÃ¼<br><br><br>...................</td>
                </tr>
            </tfoot>
            </table></div>`;
            sayfaHtml+=h;
        }
    }
    document.getElementById('raporAlani').innerHTML = sayfaHtml;
    document.querySelectorAll('.veri-hucre').forEach(td => satirHesapla(td));
    document.getElementById('btnExceleKopyala').style.display = "block";
}

let isSelecting = false; let startCell = null; let selectedCells = [];
function getRowIdx(td) { return Array.from(td.parentNode.parentNode.children).indexOf(td.parentNode); }
function getColIdx(td) { let tr = td.parentNode; let idx = 0; for (let i = 0; i < tr.children.length; i++) { if (tr.children[i] === td) return idx; idx += parseInt(tr.children[i].getAttribute('colspan') || 1); } return idx; }
function clearSelection() { selectedCells.forEach(td => { if(td) td.classList.remove('selected-cell'); }); selectedCells = []; }
function selectRectangle(start, end) {
    clearSelection(); let r1 = getRowIdx(start), r2 = getRowIdx(end); let c1 = getColIdx(start), c2 = getColIdx(end);
    let minR = Math.min(r1, r2), maxR = Math.max(r1, r2); let minC = Math.min(c1, c2), maxC = Math.max(c1, c2);
    let rows = start.closest('tbody').children;
    for (let r = minR; r <= maxR; r++) { let tds = rows[r].children; for (let c = minC; c <= maxC; c++) { let td = tds[c]; if (td && td.style.display !== 'none' && !td.hasAttribute('colspan')) { td.classList.add('selected-cell'); selectedCells.push(td); } } }
}
document.addEventListener('mousedown', function(e) { if (e.button !== 0 || e.target.closest('#tableContextMenu')) return; if (e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) { isSelecting = true; startCell = e.target; clearSelection(); e.target.classList.add('selected-cell'); selectedCells.push(e.target); } else clearSelection(); });
document.addEventListener('mouseover', function(e) { if (isSelecting && e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) selectRectangle(startCell, e.target); });
document.addEventListener('mouseup', function() { isSelecting = false; });
document.addEventListener('contextmenu', function(e) { if (e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) { e.preventDefault(); if (!selectedCells.includes(e.target)) { clearSelection(); e.target.classList.add('selected-cell'); selectedCells.push(e.target); } let ctxMenu = document.getElementById('tableContextMenu'); ctxMenu.style.display = 'block'; ctxMenu.style.left = e.pageX + 'px'; ctxMenu.style.top = e.pageY + 'px'; } });

function mergeSelectedCells() {
    document.getElementById('tableContextMenu').style.display = 'none'; if (selectedCells.length <= 1) return clearSelection();
    selectedCells.sort((a, b) => { let rDiff = getRowIdx(a) - getRowIdx(b); return rDiff !== 0 ? rDiff : getColIdx(a) - getColIdx(b); });
    let mainCell = selectedCells[0]; let mergeId = "merge_" + Date.now();
    let isRowMerge = getRowIdx(selectedCells[0]) === getRowIdx(selectedCells[1]);
    if (isRowMerge) {
        let totalColSpan = 0; let mergedText = "";
        selectedCells.forEach((td, index) => { totalColSpan += parseInt(td.getAttribute('colspan') || 1); if(getCleanValue(td.innerText || td.textContent) !== "" && mergedText === "") mergedText = td.innerHTML; if (index > 0) { td.style.display = 'none'; td.setAttribute('data-merged-by', mergeId); } });
        mainCell.setAttribute('colspan', totalColSpan); mainCell.setAttribute('data-merge-id', mergeId); mainCell.innerHTML = mergedText;
    } else {
        let totalRowSpan = 0; let mergedText = "";
        selectedCells.forEach((td, index) => { totalRowSpan += parseInt(td.getAttribute('rowspan') || 1); if(getCleanValue(td.innerText || td.textContent) !== "" && mergedText === "") mergedText = td.innerHTML; if (index > 0) { td.style.display = 'none'; td.setAttribute('data-merged-by', mergeId); } });
        mainCell.setAttribute('rowspan', totalRowSpan); mainCell.setAttribute('data-merge-id', mergeId); mainCell.innerHTML = mergedText;
    }
    satirHesapla(mainCell); clearSelection();
}
function unmergeSelectedCells() {
    document.getElementById('tableContextMenu').style.display = 'none';
    selectedCells.forEach(td => {
        let mergeId = td.getAttribute('data-merge-id');
        if (mergeId) {
            td.removeAttribute('colspan'); td.removeAttribute('rowspan'); td.removeAttribute('data-merge-id');
            td.closest('tbody').querySelectorAll(`td[data-merged-by="${mergeId}"]`).forEach(hiddenTd => { hiddenTd.style.display = ''; hiddenTd.removeAttribute('data-merged-by'); satirHesapla(hiddenTd); });
        }
    });
    if(selectedCells.length > 0) satirHesapla(selectedCells[0]); clearSelection();
}

function exceleSifirKayipsizIndir() {
    const tablolar = document.querySelectorAll('.veri-tablosu');
    if (tablolar.length === 0) return alert("LÃ¼tfen Ã¶nce tabloyu oluÅŸturun.");

    let combinedHtml = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head>
        <meta charset="utf-8">
        <style>
            table { border-collapse: collapse; font-family: 'Arial', sans-serif; font-size: 11px; }
            td, th { border: 0.5pt solid black; text-align: center; vertical-align: middle; }
        </style>
        </head>
    <body>`;

    tablolar.forEach(tablo => {
        if(tablo.closest('.sayfa').style.display === 'none') return;

        let clone = tablo.cloneNode(true);
        clone.querySelectorAll('script, button').forEach(el => el.remove());
        clone.querySelectorAll('td[style*="display: none"], th[style*="display: none"]').forEach(c => c.remove());

        clone.querySelectorAll('th, td').forEach(el => {
            let inlineStyle = `border: 0.5pt solid black; vertical-align: middle; `;
            
            if (el.classList.contains('bg-hafta')) inlineStyle += "background-color: #dff0d8;";
            else if (el.classList.contains('bg-genel')) inlineStyle += "background-color: #fcf3cf;";
            else if (el.classList.contains('bg-gece')) inlineStyle += "background-color: #e8daef;";
            else if (el.classList.contains('hucre-izin')) inlineStyle += "background-color: #fadbd8; color: #c0392b;";
            else if (el.classList.contains('hucre-haftasonu')) inlineStyle += "background-color: #f2f2f2;";

            if (el.classList.contains('kalin-yatay')) {
                inlineStyle += "font-weight: bold; font-size: 11px; text-align: center;";
            } else if (el.classList.contains('isim-yatay')) {
                inlineStyle += "font-weight: bold; font-size: 11px; text-align: left;";
            } else {
                inlineStyle += "text-align: center;";
            }

            if (el.hasAttribute('data-tarih')) {
                el.innerHTML = el.getAttribute('data-tarih');
                inlineStyle += "mso-rotate: 90; height: 60pt; white-space: nowrap; font-weight: bold;";
            }
            else if (el.hasAttribute('data-gun')) {
                el.innerHTML = el.getAttribute('data-gun');
                inlineStyle += "mso-rotate: 90; height: 45pt; white-space: nowrap; font-weight: normal; font-size: 9px;";
            }
            else {
                let raw = el.innerText || el.textContent || "";
                raw = raw.trim();
                
                if (el.classList.contains('veri-hucre') && raw) {
                    raw = raw.replace(/\s+/g, '-').replace(/-+/g, '-');
                    el.innerHTML = raw;
                    inlineStyle += "mso-rotate: 90; height: 65pt; white-space: nowrap; font-weight: bold;";
                }
                else {
                    let dikeyBaslik = el.querySelector('.baslik-dik');
                    if (dikeyBaslik) {
                        el.innerHTML = dikeyBaslik.innerHTML;
                        inlineStyle += "mso-rotate: 90; height: 110pt; white-space: normal;";
                    }
                }
            }
            el.setAttribute('style', inlineStyle);
        });

        combinedHtml += clone.outerHTML + "<br><br><br>"; 
    });

    combinedHtml += "</body></html>";

    const blob = new Blob(['\ufeff' + combinedHtml], { type: 'application/vnd.ms-excel;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Hastane_Puantaj_Listesi.xls';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
