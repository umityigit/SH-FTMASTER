<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEMƒ∞ZLƒ∞K Bƒ∞Rƒ∞Mƒ∞ PUANTAJ Sƒ∞STEMƒ∞ v133 (TAM SENKRON & YAPI≈ûKAN TABLO)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --green: #27ae60; --orange: #e67e22; --red: #c0392b; --blue: #2980b9; --dark: #1a252f; }
        body { margin: 0; background: #eef2f5; font-family: 'Roboto', sans-serif; }

        #mainContent { display: block; padding-bottom: 50px; }
        
        /* === ANA EKRAN === */
        .hero-search { background: white; padding: 30px 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; margin: 20px auto; width: 95%; max-width: 1200px; border-top: 8px solid var(--orange); }
        .hero-title { color: var(--primary); margin-top: 0; font-size: 26px; text-transform: uppercase; }
        .hero-desc { color: #7f8c8d; font-size: 15px; margin-bottom: 20px; }
        
        .hero-input-group { display: inline-block; text-align: left; margin: 10px 15px; }
        .hero-label { font-weight: bold; font-size: 14px; color: var(--blue); margin-bottom: 8px; display: block; text-transform: uppercase; text-align: center;}
        .hero-input { font-size: 18px; padding: 12px 20px; border: 2px solid #bdc3c7; border-radius: 8px; width: 200px; text-align: center; font-weight: bold; color: var(--primary); transition: 0.3s; }
        
        .personel-grid { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 15px; }
        .personel-card { position: relative; display: inline-block; }
        
        .btn-kisi { background: white; border: 2px solid #bdc3c7; color: var(--primary); padding: 12px 20px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.2s; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        .btn-kisi:hover { background: var(--blue); border-color: var(--blue); color: white; transform: translateY(-3px); box-shadow: 0 6px 12px rgba(41, 128, 185, 0.3); }
        .btn-sil-badge { position: absolute; top: -8px; right: -8px; background: var(--red); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: 0.2s; z-index: 10; opacity: 0.6; }
        .btn-sil-badge:hover { transform: scale(1.3); opacity: 1; }
        .btn-yeni-kisi { background: #f8f9fa; border: 2px dashed var(--green); color: var(--green); }
        .btn-yeni-kisi:hover { background: var(--green); border-color: var(--green); color: white; }

        .grup-baslik { width: 100%; text-align: center; font-size: 16px; color: var(--orange); font-weight: bold; margin-top: 25px; margin-bottom: 10px; border-bottom: 2px dashed #eee; padding-bottom: 5px; }
        .btn-tam-dokum { font-size: 18px; padding: 20px 40px; background: var(--green); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 35px; transition: 0.3s; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); width: 100%; max-width: 500px; display: block; margin-left: auto; margin-right: auto; }
        .btn-tam-dokum:hover { background: #219653; transform: scale(1.02); }
        .print-btn { font-size: 14px; padding: 12px 30px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.3s; }
        
        details summary::-webkit-details-marker { display:none; }
        .settings-panel { background: white; padding: 15px; border-radius: 10px; display: flex; gap: 15px; flex-wrap: wrap; border: 1px solid #ddd; margin-top: 10px;}
        .panel-col { flex: 1; min-width: 280px; display: flex; flex-direction: column; gap: 8px; position: relative; }
        h3 { margin: 0; font-size: 14px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: var(--primary); text-transform: uppercase; }
        .personel-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .modern-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; box-sizing: border-box;}
        .personel-listesi { height: 180px; overflow-y: auto; border: 1px solid #ddd; background: #fff; padding: 5px; border-radius: 5px; }
        .personel-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; border-bottom: 1px solid #f0f0f0; font-size: 11px; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-add { background: var(--green); padding: 5px 10px; }
        .btn-del { background: var(--red); padding: 2px 6px; font-size: 10px; }
        .btn-del-group { position: absolute; right: 0; top: 0; background: var(--red); padding: 2px 8px; font-size: 10px; }
        .btn-big { width: 100%; padding: 15px; font-size: 14px; margin-top: 5px; text-transform: uppercase; }
        .btn-org { background: var(--orange); } .btn-grn { background: var(--green); } .btn-blu { background: var(--blue); }
        .vardiya-chip { display:flex; align-items:center; background:#2ecc71; color:white; padding:6px 10px; border-radius:5px; font-size:11px; font-weight:bold; margin-bottom:5px;}
        .vardiya-chip.izin { background:#e74c3c; }
        .vardiya-del { margin-left:10px; cursor:pointer; font-size:12px;}

        /* === YAPI≈ûKAN (STICKY) TABLO ALANI === */
        .sayfa-container { 
            width: 98%; 
            max-height: 75vh; /* Dƒ∞KEY KAYDIRMA ƒ∞√áƒ∞N */
            overflow: auto; 
            margin: 20px auto; 
            background: white; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            border: 2px solid #bdc3c7;
            border-radius: 8px;
        }
        
        table { width: 2350px !important; border-collapse: collapse; table-layout: fixed; margin: 0; padding: 0; user-select: none; }
        th, td { border: 1px solid #000; text-align: center; vertical-align: middle; padding: 1px; line-height: 1.1; word-break: break-word; overflow: visible; background: white;}
        
        /* TEPEDEKƒ∞ TARƒ∞HLERƒ∞ SABƒ∞TLEME */
        thead { position: sticky; top: 0; z-index: 30; }
        thead th, thead td { background: #eee; box-shadow: inset 0 0 0 1px #000; /* Kenarlƒ±klarƒ±n kaybolmamasƒ± i√ßin */ }
        
        /* SOLDAKƒ∞ ƒ∞Sƒ∞MLERƒ∞ SABƒ∞TLEME */
        .stick-1 { position: sticky; left: 0px; z-index: 10; background: white; box-shadow: inset 0 0 0 1px #000; }
        .stick-2 { position: sticky; left: 35px; z-index: 10; background: white; box-shadow: inset 0 0 0 1px #000; }
        .stick-3 { position: sticky; left: 135px; z-index: 10; background: white; box-shadow: inset 0 0 0 1px #000; }
        .stick-4 { position: sticky; left: 265px; z-index: 10; background: white; box-shadow: inset 0 0 0 1px #000; }
        
        /* K√ñ≈ûE KESƒ∞≈ûƒ∞Mƒ∞ (HEM √úST HEM SOL) */
        thead .stick-1, thead .stick-2, thead .stick-3, thead .stick-4 { z-index: 40; background: #ddd; }

        .veri-hucre { height: 75px !important; padding: 0 !important; cursor: crosshair !important; transition: all 0.2s;}
        .veri-hucre:focus { background: #fff9c4 !important; outline: 3px solid #e67e22; z-index: 5; font-size: 14px; font-weight: bold; cursor: text !important;}
        
        .dik-yazi { writing-mode: vertical-lr; transform: rotate(180deg); font-size: 11px; font-weight: bold; white-space: nowrap; display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; pointer-events: none; }
        .selected-cell { background-color: #d0ebff !important; box-shadow: inset 0 0 0 2px #1c7ed6 !important; z-index: 5; }
        
        #tableContextMenu { font-family: 'Roboto', sans-serif; min-width: 160px; }
        .ctx-header { background: #f8f9fa; padding: 8px 10px; font-size: 11px; font-weight: bold; color: #7f8c8d; text-align: center; border-bottom: 2px solid #3498db; text-transform: uppercase; letter-spacing: 1px;}
        .ctx-item { padding: 10px 15px; font-size: 13px; font-weight: 500; cursor: pointer; transition: 0.2s; color: #333; display: flex; align-items: center; gap: 8px; }
        .ctx-item:hover { background-color: #e3f2fd; color: var(--blue); padding-left: 20px; }
        .ctx-item.danger { color: var(--red); }
        .ctx-item.danger:hover { background-color: #fdedec; color: #c0392b; }

        col.c-sno { width: 35px; } col.c-tc { width: 100px; } col.c-isim { width: 130px; } col.c-gun { width: 38px; } 
        .kalin-yatay { font-weight: bold !important; font-size: 11px !important; text-align: center; padding: 2px !important; }
        .isim-yatay { font-weight: bold !important; font-size: 11px !important; text-align: left; padding-left: 3px !important; }
        th { background: #eee; padding: 2px; font-size: 10px; }
        
        .bg-hafta { background-color: #dff0d8 !important; border-left: 2px solid #000; }
        .bg-genel { background-color: #fcf3cf !important; border-left: 2px solid #000; }
        .bg-gece { background-color: #e8daef !important; border-left: 2px solid #000; }
        .hucre-izin { background-color: #fadbd8 !important; color: #c0392b; font-weight: bold; }
        .hucre-haftasonu { background-color: #f2f2f2 !important; }
        
        .baslik-dik { writing-mode: vertical-lr; transform: rotate(180deg); white-space: nowrap; margin: auto; font-size: 11px; font-weight: bold; padding: 2px 0; }
        .baslik-dik-kucuk { writing-mode: vertical-lr; transform: rotate(180deg); white-space: nowrap; margin: auto; font-size: 9px; font-weight: normal; padding: 2px 0; color: #444; }

        #btnExceleKopyala { position: fixed; bottom: 20px; right: 20px; background: #27ae60; color: white; border: none; padding: 15px 25px; border-radius: 50px; font-size: 14px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; display: none; z-index: 100000; transition: 0.3s; }
        #btnExceleKopyala:hover { background: #219653; transform: scale(1.05); }

        /* YUVARLAK YE≈ûƒ∞L KAYDET BUTONU */
        #btnSaveToCloud { 
            position: fixed; bottom: 20px; left: 20px; background: #27ae60; color: white; border: none; 
            width: 60px; height: 60px; border-radius: 50%; font-size: 24px; 
            display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 4px 15px rgba(39,174,96,0.5); cursor: pointer; z-index: 100000; 
            display: none; transition: 0.3s; animation: pulseGreen 2s infinite; 
        }
        #btnSaveToCloud:hover { transform: scale(1.1); }
        #btnSaveToCloud::after { 
            content: "KAYDET (Ctrl+S)"; position: absolute; bottom: -25px; left: -15px; width: 90px;
            font-size: 10px; font-weight: bold; color: #27ae60; background: white; 
            padding: 3px 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-align: center;
        }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(39, 174, 96, 0); } 100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); } }

        @media print {
            @page { size: A4 landscape; margin: 5mm; } 
            body { zoom: 50%; margin: 0; padding: 0; background: white; } 
            .hero-search, details, #tableContextMenu, #btnExceleKopyala, #btnSaveToCloud { display: none !important; }
            #mainContent { display: block !important; overflow: visible; padding:0; margin:0;}
            
            /* YAZDIRIRKEN YAPI≈ûKANLIKLARI ƒ∞PTAL ET */
            .sayfa-container { overflow: visible !important; width: 100%; padding:0; max-height: none !important; border: none; box-shadow: none;}
            thead, .stick-1, .stick-2, .stick-3, .stick-4 { position: static !important; box-shadow: none !important; }
            
            .sayfa { margin: 0; padding: 0; width: 100%; border: none; box-shadow: none; page-break-after: always; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            tr { page-break-inside: avoid; }
            .selected-cell { box-shadow: none !important; outline: none !important; background-color: inherit !important; } 
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="mainContent">
    <div class="hero-search">
        <h1 class="hero-title">üìã HIZLI PUANTAJ PANELƒ∞</h1>
        <p class="hero-desc">ƒ∞≈ülem yapmak istediƒüiniz personelin √ºzerine tƒ±klayƒ±n veya alt kƒ±sƒ±mdan tam d√∂k√ºm alƒ±n.<br><em>Ekranda olu≈üan tablodaki g√ºnleri fare ile se√ßip, <b>Saƒü Tƒ±klayarak (ShiftMaster Men√ºs√º)</b> anƒ±nda vardiya atayabilirsiniz. <br>Hata yaparsanƒ±z <b>CTRL+Z</b> ile geri alabilir, deƒüi≈üiklikleri <b>CTRL+S</b> ile ShiftMaster'a kalƒ±cƒ± kaydedebilirsiniz.</em></p>
        
        <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 20px;">
            <div class="hero-input-group">
                <label class="hero-label">BA≈ûLANGI√á</label>
                <input type="date" id="inpTarihBas" class="hero-input">
            </div>
            <div class="hero-input-group">
                <label class="hero-label">Bƒ∞Tƒ∞≈û</label>
                <input type="date" id="inpTarihBit" class="hero-input">
            </div>
        </div>

        <div id="personelButonAlani" class="personel-grid"></div>

        <button id="btnTamDokum" onclick="veriyiCekVeOlustur('')" class="btn-tam-dokum">üìÑ T√úM Lƒ∞STENƒ∞N TAM D√ñK√úM√úN√ú AL</button>
        
        <div>
            <button onclick="window.print()" class="print-btn">üñ®Ô∏è HAZIRLANAN RAPORU YAZDIR</button>
        </div>
    </div>

    <details style="margin: 20px auto; width: 95%; max-width: 1200px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <summary style="padding: 15px; font-weight: bold; font-size: 14px; color: #7f8c8d; cursor: pointer; border-left: 5px solid #bdc3c7; border-radius: 10px; outline: none;">
            ‚öôÔ∏è GELƒ∞≈ûMƒ∞≈û AYARLAR (Y√∂netici Paneli - Tƒ±klayƒ±n)
        </summary>
        <div class="settings-panel">
            <div style="width:100%; padding-bottom:5px; border-bottom:2px solid #eee; margin-bottom:10px;">
                <h3 style="border:none; padding:0; display:inline-block; color:var(--orange);">VARDƒ∞YA Y√ñNETƒ∞Mƒ∞</h3>
            </div>
            <div style="width:100%; display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                <div style="flex:2; min-width: 150px;">
                    <label style="font-size:10px; font-weight:bold;">Vardiya Adƒ± / Kodu</label>
                    <input type="text" id="vAd" class="modern-input" placeholder="√ñrn: 08:00-20:00 veya Nƒ∞">
                </div>
                <div style="flex:1; min-width: 80px;">
                    <label style="font-size:10px; font-weight:bold;">Toplam Saat</label>
                    <input type="number" id="vSaat" class="modern-input" placeholder="√ñrn: 11" step="0.5">
                </div>
                <div style="flex:1; min-width: 80px;">
                    <label style="font-size:10px; font-weight:bold;">Gece Saati</label>
                    <input type="number" id="vGece" class="modern-input" placeholder="√ñrn: 0" step="0.5">
                </div>
                <div style="flex:1.5; min-width: 120px;">
                    <label style="font-size:10px; font-weight:bold;">T√ºr</label>
                    <select id="vTip" class="modern-input">
                        <option value="calisma">√áalƒ±≈üma / Mesai</option>
                        <option value="izin">ƒ∞zin / ƒ∞stirahat</option>
                    </select>
                </div>
                <div>
                    <button onclick="vardiyaEkle()" class="btn-big btn-grn" style="margin:0; padding:8px 20px;">EKLE</button>
                </div>
            </div>
            <div id="vardiyaListesi" style="width:100%; display:flex; gap:8px; flex-wrap:wrap; margin-top:5px;"></div>
            
            <div id="dynamicGroups" style="display: flex; gap: 15px; flex-wrap: wrap; width: 100%; margin-top: 15px; border-top: 2px solid #eee; padding-top: 15px;"></div>
            <div class="panel-col" style="flex:1; min-width: 250px; justify-content: center; align-items: center; border: 2px dashed #ccc; border-radius: 10px; padding: 20px;">
                <button onclick="yeniGrupEkle()" class="btn-big btn-blu">+ YENƒ∞ GRUP EKLE</button>
            </div>
            <textarea id="inpExcel" style="display:none;"></textarea>
        </div>
    </details>

    <div class="sayfa-container" id="raporScrollNoktasi">
        <div id="raporAlani"></div>
    </div>
</div>

<button id="btnExceleKopyala" onclick="exceleSifirKayipsizIndir()">üì• EXCEL DOSYASI ƒ∞NDƒ∞R</button>

<button id="btnSaveToCloud" onclick="bulutaKalƒ±cƒ±Kaydet()" title="Deƒüi≈üiklikleri ShiftMaster'a Kaydet">üíæ</button>

<div id="tableContextMenu" style="display:none; position:absolute; background:white; border:1px solid #ced4da; box-shadow:0 10px 25px rgba(0,0,0,0.2); z-index:99999; border-radius:8px; overflow:hidden;">
    <div class="ctx-header">SHIFTMASTER MEN√úS√ú</div>
    <div id="ctxDinamikVardiyalar" style="max-height: 250px; overflow-y: auto;"></div>
    <div style="border-bottom: 2px solid #eee;"></div>
    <div class="ctx-item danger" onclick="seciliHucreleriTemizle()">üßπ Se√ßili H√ºcreleri Temizle</div>
    <div style="border-bottom: 2px solid #eee;"></div>
    <div class="ctx-item" onclick="mergeSelectedCells()">üîó Se√ßili H√ºcreleri Birle≈ütir</div>
    <div class="ctx-item" onclick="unmergeSelectedCells()">‚úÇÔ∏è H√ºcre Birle≈ütirmesini Ayƒ±r</div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyAAqT74kCwyr6ZULTR_ClRDJ5Iu4AhmXJQ", databaseURL: "https://shiftmaster1-7fc5f-default-rtdb.europe-west1.firebasedatabase.app", projectId: "shiftmaster1-7fc5f" };
firebase.initializeApp(firebaseConfig); const db = firebase.database();

// === √áƒ∞FT Y√ñNL√ú SENKRON DEƒûƒ∞≈ûKENLERƒ∞ ===
window.firebaseCellPaths = {}; // H√ºcrelerin ShiftMaster adres haritasƒ±
let historyStack = []; 
let hasUnsavedChanges = false; 

function checkUnsaved() { hasUnsavedChanges = true; document.getElementById('btnSaveToCloud').style.display = 'flex'; }
function resetUnsaved() { hasUnsavedChanges = false; document.getElementById('btnSaveToCloud').style.display = 'none'; }
function pushToHistory(changesArray) { historyStack.push(changesArray); if(historyStack.length > 50) historyStack.shift(); checkUnsaved(); }

document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key.toLowerCase() === 'z') {
        e.preventDefault();
        if (historyStack.length > 0) {
            let lastChanges = historyStack.pop();
            lastChanges.forEach(ch => { ch.td.innerHTML = ch.oldVal; satirHesapla(ch.td); });
            checkUnsaved();
        }
    }
    if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); if (hasUnsavedChanges) bulutaKalƒ±cƒ±Kaydet(); }
});

// === YARIM KAYDETME SORUNUNU √á√ñZEN GELƒ∞≈ûMƒ∞≈û KAYIT MOTORU ===
function bulutaKalƒ±cƒ±Kaydet() {
    if(!confirm("‚ö†Ô∏è Dƒ∞KKAT!\n\nYaptƒ±ƒüƒ±nƒ±z deƒüi≈üiklikler SHIFTMASTER veritabanƒ±na kalƒ±cƒ± olarak i≈ülenecek.\nEmin misiniz?")) return;

    let btn = document.getElementById('btnSaveToCloud');
    btn.innerHTML = "‚è≥"; btn.style.pointerEvents = "none";

    let updates = {};
    document.querySelectorAll('td.veri-hucre').forEach(td => {
        let isim = td.getAttribute('data-smisim');
        let tarih = td.getAttribute('data-tarih');
        
        if(isim && tarih && window.firebaseCellPaths) {
            let path = window.firebaseCellPaths[`${isim}_${tarih}`];
            if(path) {
                let text = getCleanValue(td.innerText || td.textContent);
                updates[path] = text;
            }
        }
    });

    if(Object.keys(updates).length === 0) {
        alert("Bulut baƒülantƒ±lƒ± bir veri bulunamadƒ±!");
        btn.innerHTML = "üíæ"; btn.style.pointerEvents = "auto";
        return;
    }

    db.ref().update(updates).then(() => {
        btn.innerHTML = "‚úÖ"; btn.style.background = "#2ecc71";
        setTimeout(() => { resetUnsaved(); btn.innerHTML = "üíæ"; btn.style.background = "#27ae60"; btn.style.pointerEvents = "auto"; }, 2000);
    }).catch(err => { alert("Hata: " + err); btn.innerHTML = "üíæ"; btn.style.pointerEvents = "auto"; });
}

document.addEventListener('DOMContentLoaded', function() {
    let bugun = new Date();
    let bas = new Date(bugun.getFullYear(), bugun.getMonth(), 15);
    let bit = new Date(bugun.getFullYear(), bugun.getMonth() + 1, 14);
    
    document.getElementById('inpTarihBas').value = `${bas.getFullYear()}-${String(bas.getMonth()+1).padStart(2,'0')}-${String(bas.getDate()).padStart(2,'0')}`;
    document.getElementById('inpTarihBit').value = `${bit.getFullYear()}-${String(bit.getMonth()+1).padStart(2,'0')}-${String(bit.getDate()).padStart(2,'0')}`;
    
    bulutBaglantisiniKur();
});

const DEFAULT_VARDIYALAR = { 
    "08:00-18:00":{t:9,g:0, tip:"calisma"}, "08:00-20:00":{t:11,g:0, tip:"calisma"}, "08:00-16:00":{t:7.5,g:0, tip:"calisma"}, 
    "20:00-08:00":{t:11,g:11, tip:"calisma"}, "16:00-24:00":{t:7.5,g:4, tip:"calisma"}, "24:00-08:00":{t:7.5,g:6, tip:"calisma"}, 
    "HT":{t:0,g:0, tip:"izin"}, "Yƒ∞":{t:0,g:0, tip:"izin"}, "R":{t:0,g:0, tip:"izin"}, "ƒ∞":{t:0,g:0, tip:"izin"}, 
    "Nƒ∞":{t:0,g:0, tip:"izin"}, "RT":{t:0,g:0, tip:"izin"}, "RT√á":{t:9,g:0, tip:"calisma"} 
};

let appData = { gruplar: [], vardiyalar: null };

function ilkKurulumuYap() {
    appData = { gruplar: [], vardiyalar: DEFAULT_VARDIYALAR };
    const genelListe = [
        "10006543166 - NEJLA Nƒ∞Lƒ∞", "10580422338 - TAYYƒ∞P DOƒûAN", "11620640910 - ZELƒ∞HA ERSOY", "12547486254 - MEHMET OƒûUZ D√ñƒû√úN", 
        "13097253044 - ORHAN KAHRAMAN", "14671540086 - G√úLBAHAR √úNVER", "15097363778 - MERVE √ñZ", "15958477590 - NAZMƒ∞YE DURAN", 
        "16015509254 - SONG√úL ERDOƒûAN", "16709091126 - G√úLL√ú TOSUN", "16900491572 - SONG√úL Dƒ∞LEK", "19589057206 - SEDA YILMAZ", 
        "19741371508 - √ñZLEM DURSUN", "21283980216 - ≈ûAHABETTƒ∞N ORHAN", "22918496584 - HATƒ∞CE YILDIRIM", "24475058656 - ZEYNEP BOZAN", 
        "25282186846 - BURCU DERELƒ∞OƒûLU", "25624852712 - SONG√úL √ñZT√úRK", "26872123876 - HURƒ∞YE ELMAS", "27091143096 - KADƒ∞R GAMSIZ", 
        "28543103354 - AY≈ûE BOZKAYA", "29386066998 - SAFƒ∞YE DENECƒ∞", "30163049264 - ADEM K√ñM√úR", "30623331236 - SADIK MACƒ∞T", 
        "30937798466 - ALƒ∞ GEN√áEL", "37927835576 - HALƒ∞L VAR", "40186499618 - DENƒ∞Z USLU", "45925910836 - ENES ABDULLAH ALTUN", 
        "53164244964 - MAKBULE DENK", "58708122418 - MUSTAFA Dƒ∞K", "61585026564 - FATMA √áALI≈ûKAN", "10588692368 - √úMƒ∞T Yƒ∞ƒûƒ∞T", 
        "21604545568 - NUSRETTƒ∞N √ñZSOY", "23665254878 - √úMM√ú KURU", "26542158924 - HAFƒ∞SE Dƒ∞KMEN", "29056059848 - FATMA I≈ûIK", 
        "30328031684 - BURAK TURAN", "32827531146 - HATƒ∞CE KARAKU≈û", "00000000000 - FATMA KO√áAR", "10546692058 - HAFƒ∞ZE √ñNAL", 
        "23467244800 - FUNDA POYRAZ", "62074286230 - BET√úL ≈ûƒ∞M≈ûEK"
    ];
    appData.gruplar = [{ id: "g_1", ad: "D√ñ≈ûEMEALTI DEVLET HASTANESƒ∞", kisiler: genelListe }];
    veriKaydet(); 
}

function bulutBaglantisiniKur() {
    db.ref("puantaj_v115_zorunlu_gecis").once("value", snap => {
        if(!snap.val()) {
            ilkKurulumuYap(); db.ref("puantaj_v115_zorunlu_gecis").set(true);
            arayuzCiz(); vardiyaArayuzCiz();
        } else {
            db.ref("puantaj_motoru_ayarlar").on("value", snap => {
                let data = snap.val();
                if(data) {
                    appData = data;
                    if (!appData.vardiyalar) appData.vardiyalar = DEFAULT_VARDIYALAR;
                    if (!appData.gruplar || appData.gruplar.length === 0) appData.gruplar = [{ id: "g_1", ad: "HASTANE PERSONELƒ∞", kisiler: [] }];
                    arayuzCiz(); vardiyaArayuzCiz(); anaEkranaButonlariCiz(); 
                } else { ilkKurulumuYap(); }
            });
        }
    });
}

function veriKaydet() { db.ref("puantaj_motoru_ayarlar").set(appData); }

function vardiyaEkle() {
    let kod = document.getElementById("vAd").value.trim().toUpperCase();
    let t = parseFloat(document.getElementById("vSaat").value) || 0;
    let g = parseFloat(document.getElementById("vGece").value) || 0;
    let tip = document.getElementById("vTip").value;
    if(!kod) return alert("Vardiya adƒ± bo≈ü olamaz!");
    appData.vardiyalar[kod] = { t: t, g: g, tip: tip };
    veriKaydet(); 
}
function vardiyaSil(kod) { if(confirm(kod + " silinsin mi?")) { delete appData.vardiyalar[kod]; veriKaydet(); } }

function vardiyaArayuzCiz() {
    const root = document.getElementById("vardiyaListesi"); root.innerHTML = "";
    for(let v in appData.vardiyalar) {
        let info = appData.vardiyalar[v];
        let cClass = info.tip === 'izin' ? 'izin' : 'calisma';
        let desc = info.tip === 'calisma' ? `(${info.t}s / G:${info.g}s)` : '(ƒ∞zin)';
        root.innerHTML += `<div class="vardiya-chip ${cClass}"><span>${v} ${desc}</span><span class="vardiya-del" onclick="vardiyaSil('${v}')">‚úñ</span></div>`;
    }
}

function anaEkranaButonlariCiz() {
    const container = document.getElementById("personelButonAlani"); container.innerHTML = "";
    appData.gruplar.forEach(grup => {
        let html = `<div style="width: 100%;"><div class="grup-baslik">üè¢ ${grup.ad} PERSONEL Lƒ∞STESƒ∞</div><div class="personel-grid">`;
        if(grup.kisiler && grup.kisiler.length > 0) {
            grup.kisiler.sort((a,b) => {
                let isimA = a.includes("-") ? a.split("-")[1].trim() : a;
                let isimB = b.includes("-") ? b.split("-")[1].trim() : b;
                return isimA.localeCompare(isimB, 'tr');
            }).forEach((isimTam) => {
                let sadeceIsim = isimTam.includes("-") ? isimTam.split("-")[1].trim() : isimTam;
                let guvenliIsimTam = isimTam.replace(/'/g, "\\'"); 
                html += `<div class="personel-card"><button class="btn-kisi" onclick="veriyiCekVeOlustur('${sadeceIsim}')">üë§ ${sadeceIsim}</button><button class="btn-sil-badge" title="Sil" onclick="anaEkrandanPersonelSil('${grup.id}', '${guvenliIsimTam}')">üóëÔ∏è</button></div>`;
            });
        }
        html += `<div class="personel-card"><button class="btn-kisi btn-yeni-kisi" onclick="anaEkrandanPersonelEkle('${grup.id}')">üë§+ EKLE</button></div></div></div>`;
        container.innerHTML += html;
    });
}

function anaEkrandanPersonelEkle(grupId) {
    let isim = prompt("L√ºtfen eklenecek personelin T.C. Kimlik numarasƒ±nƒ± ve Adƒ±nƒ± girin.\n(√ñrn: 12345678912 - AHMET YILMAZ)");
    if(isim && isim.trim() !== "") {
        isim = isim.trim().toUpperCase('tr'); let grup = appData.gruplar.find(g => g.id === grupId);
        if(!grup.kisiler) grup.kisiler = [];
        if(!grup.kisiler.includes(isim)) { grup.kisiler.push(isim); veriKaydet(); } else { alert("Bu personel zaten var!"); }
    }
}
function anaEkrandanPersonelSil(grupId, isimTam) {
    let sadeceIsim = isimTam.includes("-") ? isimTam.split("-")[1].trim() : isimTam;
    if(confirm(`‚ö†Ô∏è Dƒ∞KKAT!\n\n${sadeceIsim} personeli silinsin mi?`)) { let grup = appData.gruplar.find(g => g.id === grupId); grup.kisiler = grup.kisiler.filter(k => k !== isimTam); veriKaydet(); }
}

function getCleanValue(text) { 
    if(!text) return ""; 
    return text.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '').trim().toUpperCase(); 
}

function hucreOdaklan(td) { td._oldVal = td.innerHTML; temizleFormat(td); }
function hucreCik(td) { let beforeVal = td._oldVal; uygulaFormat(td); if(td.innerHTML !== beforeVal) { pushToHistory([{ td: td, oldVal: beforeVal, newVal: td.innerHTML }]); } }
function temizleFormat(td) { let metin = td.innerText || td.textContent || ""; td.innerHTML = metin.trim(); }
function uygulaFormat(td) { let metin = getCleanValue(td.innerText || td.textContent); if (metin !== "") { td.innerHTML = `<div class="dik-yazi">${metin}</div>`; } else { td.innerHTML = ""; } satirHesapla(td); }
function formatliVardiya(val) { if(!val) return ""; return `<div class="dik-yazi">${val.trim()}</div>`; }
function getVardiyaInfo(val) {
    if (!val) return {t:0, g:0, tip:"bilinmeyen", val:""};
    let cleanVal = val.replace(/<br\s*\/?>/gi, "-").trim().toUpperCase(); 
    if (appData.vardiyalar && appData.vardiyalar[cleanVal]) return { ...appData.vardiyalar[cleanVal], val: cleanVal };
    let valWithHyphen = cleanVal.replace(/[\s\n\r]+/g, "-");
    if (appData.vardiyalar && appData.vardiyalar[valWithHyphen]) return { ...appData.vardiyalar[valWithHyphen], val: valWithHyphen };
    return {t:0, g:0, tip:"bilinmeyen", val: cleanVal};
}

function yeniGrupEkle() { appData.gruplar.push({ id: "g_" + Date.now(), ad: "YENƒ∞ Bƒ∞Rƒ∞M", kisiler: [] }); veriKaydet(); }
function grupSil(id) { if (confirm("Grup silinsin mi?")) { appData.gruplar = appData.gruplar.filter(g => g.id !== id); veriKaydet(); } }
function grupAdiGuncelle(id, ad) { let g = appData.gruplar.find(g => g.id === id); if (g) { g.ad = ad.trim() || "ƒ∞Sƒ∞MSƒ∞Z GRUP"; veriKaydet(); } }
function personelEkle(grupId) { let input = document.getElementById("add_" + grupId); let isim = input.value.trim().toUpperCase(); let grup = appData.gruplar.find(g => g.id === grupId); if(!grup.kisiler) grup.kisiler = []; if (isim && grup && !grup.kisiler.includes(isim)) { grup.kisiler.push(isim); veriKaydet(); } input.value = ""; }
function personelSil(gId, isim) { if (confirm("Silinsin mi?")) { let g = appData.gruplar.find(g => g.id === gId); g.kisiler = g.kisiler.filter(k => k !== isim); veriKaydet(); } }

function arayuzCiz() {
    const container = document.getElementById("dynamicGroups"); container.innerHTML = "";
    appData.gruplar.forEach(grup => {
        let html = `<div class="panel-col"><button class="btn-del-group" onclick="grupSil('${grup.id}')">X</button><h3 contenteditable="true" onblur="grupAdiGuncelle('${grup.id}', this.innerText)">${grup.ad}</h3><div class="personel-row"><input type="text" id="add_${grup.id}" class="modern-input" placeholder="12345678912 - PERSONEL ADI..." onkeypress="if(event.key==='Enter') personelEkle('${grup.id}')"><button onclick="personelEkle('${grup.id}')" class="btn-add">+</button></div><div class="personel-listesi">`;
        if(grup.kisiler) { grup.kisiler.sort().forEach((isim) => { html += `<div class="personel-item"><span>${isim}</span><button onclick="personelSil('${grup.id}', '${isim}')" class="btn-del">X</button></div>`; }); }
        container.innerHTML += html + `</div></div>`;
    });
}

function getSafeDate(val) {
    if (!val) return new Date(); val = val.trim(); let p;
    if (val.includes('-')) p = val.split('-'); else if (val.includes('.')) p = val.split('.'); else if (val.includes('/')) p = val.split('/'); else return new Date(val);
    if (p && p.length === 3) { let y = parseInt(p[0].length === 4 ? p[0] : p[2]); let m = parseInt(p[1]) - 1; let d = parseInt(p[0].length === 4 ? p[2] : p[0]); return new Date(y, m, d); }
    return new Date(val);
}

function tarihGuncelle(){ 
    let bas = getSafeDate(document.getElementById('inpTarihBas').value); let bit = getSafeDate(document.getElementById('inpTarihBit').value); 
    let str = `${String(bas.getDate()).padStart(2,'0')}.${String(bas.getMonth()+1).padStart(2,'0')}.${bas.getFullYear()} - ${String(bit.getDate()).padStart(2,'0')}.${String(bit.getMonth()+1).padStart(2,'0')}.${bit.getFullYear()}`;
    return {bas, bit, str}; 
}
function getKey(d){return d.getFullYear()+(d.getMonth()+1).toString().padStart(2,'0')+d.getDate().toString().padStart(2,'0');}

// ==== G√úN HESAPLAMA MANTIƒûI ====
function satirHesapla(td) {
    if (!td) return; const tr = td.closest('tr'); if (!tr) return;
    let tAg = 0, n_rt = 0, n_ht = 0, n_r = 0, n_i = 0, n_rtc = 0, n_htc = 0, tAge = 0, tFM = 0;
    let wHs = 0, wHg = 0; let tGun = 0; 

    Array.from(tr.children).forEach(c => {
        if (c.style.display === 'none' || c.hasAttribute('data-merged-by')) return;
        if (c.classList.contains('veri-hucre') && !c.classList.contains('bg-hafta')) {
            tGun++; 
            const v = getCleanValue(c.innerText || c.textContent);
            if (v === "" || v === "0") return;
            const inf = getVardiyaInfo(v); const mS = parseFloat(v.replace(",", ".")); const s = (inf && inf.t > 0) ? inf.t : (!isNaN(mS) ? mS : 0);
            c.classList.remove('hucre-izin');

            if (s > 0) { tAg++; wHg++; wHs += s; tAge += (inf.g || 0); if (v === "RT√á") n_rtc++; if (c.classList.contains('hucre-haftasonu')) n_htc++; } 
            else {
                if (v === "RT") n_rt++; else if (v === "HT") n_ht++;
                else if (v === "R" || v === "RAPOR") { n_r++; c.classList.add('hucre-izin'); }
                else if (v === "Yƒ∞" || v === "ƒ∞" || v === "Nƒ∞" || (inf && inf.tip === "izin")) { n_i++; c.classList.add('hucre-izin'); }
                else if (v !== "" && v !== "0") { c.classList.add('hucre-izin'); }
            }
        }
        if (c.classList.contains('bg-hafta')) {
            const type = c.getAttribute('data-type');
            if (type === 'h-gun') { c.innerText = wHg > 0 ? wHg : ""; } 
            else if (type === 'h-saat') { c.innerText = wHs > 0 ? Number(wHs.toFixed(2)) : ""; } 
            else if (type === 'h-fm') { let wFm = wHs > 45 ? (wHs - 45) : 0; c.innerText = wFm > 0 ? Number(wFm.toFixed(2)) : ""; tFM += wFm; wHs = 0; wHg = 0; }
        }
    });

    const update = (cls, v) => { const el = tr.querySelector(cls); if (el) el.innerText = (v === 0 || !v) ? "0" : Number(v.toFixed(2)); };
    update('.s-calisma', tGun); update('.s-yol', tAg); update('.s-rapor', n_r); update('.s-izin', n_i); update('.s-ht', n_ht); update('.s-rt', n_rt); update('.s-rtc', n_rtc); update('.s-fm', tFM); update('.s-gecefm', 0); update('.s-gece', tAge);
}

// === ƒ∞≈ûTE YARIM KAYDETMEYƒ∞ √á√ñZEN YENƒ∞ VERƒ∞ √áEKME MOTORU ===
function veriyiCekVeOlustur(arananIsim) {
    let basInput = document.getElementById('inpTarihBas').value; let bitInput = document.getElementById('inpTarihBit').value;
    if(!basInput || !bitInput) return alert("L√ºtfen Ba≈ülangƒ±√ß ve Biti≈ü Tarihi se√ßin!");

    document.body.style.cursor = "wait";
    window.firebaseCellPaths = {}; // Adres haritasƒ±nƒ± sƒ±fƒ±rla
    historyStack = []; resetUnsaved(); 
    
    let bas = getSafeDate(basInput); let bit = getSafeDate(bitInput);

    db.ref("arsivlenmis_shiftler").once("value").then(snap => {
        let data = snap.val(); 
        if(!data) { alert("Buluta kayƒ±tlƒ± ar≈üiv bulunamadƒ±!"); document.body.style.cursor = "default"; return; }
        
        let personelShiftleri = {};
        
        Object.keys(data).forEach(arsivKey => {
            let arsiv = data[arsivKey];
            let tablolar = arsiv.tables ? arsiv.tables : (arsiv.data ? [arsiv] : []);
            
            let genelBaslangic = getSafeDate(arsiv.startDate || (tablolar[0] && tablolar[0].startDate));
            let gunOffset = 0; // ƒ∞kinci tablonun tarih sapmasƒ±nƒ± tutan deƒüi≈üken
            
            tablolar.forEach((tablo, tIdx) => {
                let currentTableStart = tablo.startDate ? getSafeDate(tablo.startDate) : null;
                // Eƒüer tablo kendi ba≈ülangƒ±√ß tarihine sahip deƒüilse, bir √∂nceki tablolarƒ±n toplam g√ºn√ºn√º ekle (YARIM KAYDETME √á√ñZ√úM√ú)
                if(!currentTableStart) {
                    currentTableStart = new Date(genelBaslangic.getTime());
                    currentTableStart.setDate(currentTableStart.getDate() + gunOffset);
                }
                
                let daysInThisTable = 0;

                tablo.data.forEach((satir, sIdx) => {
                    let isim = satir.name.trim().toUpperCase(); 
                    if(!personelShiftleri[isim]) personelShiftleri[isim] = {};
                    if(satir.shifts.length > daysInThisTable) daysInThisTable = satir.shifts.length;
                    
                    satir.shifts.forEach((shiftObj, index) => {
                        let suankiTarih = new Date(currentTableStart.getTime()); 
                        suankiTarih.setDate(currentTableStart.getDate() + index);
                        suankiTarih.setHours(0,0,0,0); 
                        let basCheck = new Date(bas.getTime()); basCheck.setHours(0,0,0,0); 
                        let bitCheck = new Date(bit.getTime()); bitCheck.setHours(0,0,0,0);
                        
                        if(suankiTarih >= basCheck && suankiTarih <= bitCheck) {
                            let tStr = `${String(suankiTarih.getDate()).padStart(2,'0')}.${String(suankiTarih.getMonth()+1).padStart(2,'0')}.${suankiTarih.getFullYear()}`;
                            if(shiftObj.text) personelShiftleri[isim][tStr] = shiftObj.text;
                            
                            // H√úCRE ADRESƒ∞Nƒ∞ HARƒ∞TAYA KAYDET
                            let path = arsiv.tables
                                ? `arsivlenmis_shiftler/${arsivKey}/tables/${tIdx}/data/${sIdx}/shifts/${index}/text`
                                : `arsivlenmis_shiftler/${arsivKey}/data/${sIdx}/shifts/${index}/text`;
                            window.firebaseCellPaths[`${isim}_${tStr}`] = path;
                        }
                    });
                });
                gunOffset += daysInThisTable; // Sonraki tablo i√ßin ofseti b√ºy√ºt
            });
        });
        
        // Excel kopyalama i√ßin arka plan hazƒ±rlƒ±ƒüƒ±
        let days = []; let d = new Date(bas.getTime()); d.setHours(0,0,0,0); let bitCheck2 = new Date(bit.getTime()); bitCheck2.setHours(0,0,0,0);
        while(d <= bitCheck2) { days.push(`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`); d.setDate(d.getDate() + 1); }
        let excelStr = "AD SOYAD\t" + days.join("\t") + "\n";
        Object.keys(personelShiftleri).forEach(isim => { let satirStr = isim; days.forEach(t => satirStr += "\t" + (personelShiftleri[isim][t] || "")); excelStr += satirStr + "\n"; });
        document.getElementById('inpExcel').value = excelStr;
        
        raporuOlustur(arananIsim, personelShiftleri);
        document.body.style.cursor = "default";
        document.getElementById("raporScrollNoktasi").scrollIntoView({behavior: "smooth"});
    });
}

function raporuOlustur(filtreIsim, pShiftleri) {
    const {bas,bit,str} = tarihGuncelle();
    let days=[]; let d=new Date(bas.getTime()); while(d<=bit){ days.push(new Date(d.getTime())); d.setDate(d.getDate()+1); }
    let arananKisi = filtreIsim ? filtreIsim.toUpperCase('tr') : "";
    
    let people = {};
    appData.gruplar.forEach(grup => {
        if(grup.kisiler) {
            grup.kisiler.forEach(n => { 
                let exactName = ""; let parts = n.includes("-") ? n.split("-")[1].trim() : n;
                // ShiftMaster tam ismini e≈üle≈ütir
                Object.keys(pShiftleri).forEach(sm => {
                    let normSM = sm.replace(/ƒ∞/g,'I').replace(/ƒ±/g,'i').replace(/√ñ/g,'O').replace(/√ú/g,'U').replace(/≈û/g,'S').replace(/√á/g,'C').replace(/ƒû/g,'G');
                    let normP = parts.replace(/ƒ∞/g,'I').replace(/ƒ±/g,'i').replace(/√ñ/g,'O').replace(/√ú/g,'U').replace(/≈û/g,'S').replace(/√á/g,'C').replace(/ƒû/g,'G');
                    if (normSM.includes(normP)) exactName = sm;
                });
                people[n] = { n: n, gId: grup.id, gAd: grup.ad, data: exactName ? pShiftleri[exactName] : {}, smName: exactName }; 
            });
        }
    });

    Object.values(people).forEach(p => { days.forEach(day => { let k = getKey(day); let tStr = `${String(day.getDate()).padStart(2,'0')}.${String(day.getMonth()+1).padStart(2,'0')}.${day.getFullYear()}`; if(!p.data[tStr]) p.data[tStr] = (day.getDay()===0||day.getDay()===6) ? "HT" : "08:00-18:00"; }); });

    const HDR = [
        {n:"√áalƒ±≈üma G√ºn√º", c:"s-calisma"}, {n:"ƒ∞≈üe Gelme G√ºn√º(Yol)", c:"s-yol"}, {n:"Raporlu G√ºn Sayƒ±sƒ±", c:"s-rapor"}, 
        {n:"ƒ∞zinli Olduƒüu G√ºn Sayƒ±sƒ±", c:"s-izin"}, {n:"Hafta Tatili Toplamƒ±(HT)", c:"s-ht"}, {n:"Resmi Tatil(Tam G√ºn)(RT)", c:"s-rt"}, 
        {n:"Resmi Tatil √áalƒ±≈ümasƒ±(RT√á)", c:"s-rtc"}, {n:"ƒ∞≈û SAƒûLIƒûI VE G√úVENLƒ∞ƒûƒ∞ (YOL)", c:"s-isg"}, {n:"G√ºnd√ºz Fazla Mesai Toplamƒ±", c:"s-fm"}
    ];
    
    let sayfaHtml = ""; 
    let gArr = Object.values(people).reduce((acc, p) => { 
        let tamAd = p.n.toUpperCase('tr');
        if (arananKisi !== "") {
            let normalizeAd = tamAd.replace(/ƒ∞/g,'I').replace(/ƒ±/g,'i').replace(/√ñ/g,'O').replace(/√ú/g,'U').replace(/≈û/g,'S').replace(/√á/g,'C').replace(/ƒû/g,'G');
            let normalizeAranan = arananKisi.replace(/ƒ∞/g,'I').replace(/ƒ±/g,'i').replace(/√ñ/g,'O').replace(/√ú/g,'U').replace(/≈û/g,'S').replace(/√á/g,'C').replace(/ƒû/g,'G');
            if(!normalizeAd.includes(normalizeAranan)) return acc; 
        }
        acc[p.gAd] = acc[p.gAd]||[]; acc[p.gAd].push(p); return acc; 
    }, {});
    
    if(Object.keys(gArr).length === 0) {
        document.getElementById('raporAlani').innerHTML = `<h3 style="color:var(--red); font-size: 20px; padding: 30px; background: white; border-radius: 10px; margin-top:20px;">Sistemde veri bulunamadƒ±.</h3>`;
        document.getElementById('btnExceleKopyala').style.display = "none"; return;
    }

    for(let gAd in gArr) {
        let fullList = gArr[gAd].sort((a,b) => {
            let isimA = a.n.includes("-") ? a.n.split("-")[1].trim() : a.n;
            let isimB = b.n.includes("-") ? b.n.split("-")[1].trim() : b.n;
            return isimA.localeCompare(isimB, 'tr');
        });
        
        let gunSutunSayisi = 0;
        days.forEach((d, idx) => { gunSutunSayisi++; if (d.getDay() === 0 || idx === days.length - 1) gunSutunSayisi += 3; });
        
        let toplamSutun = 5 + gunSutunSayisi + HDR.length + 2; 
        let chunkSize = 16; let globalIndex = 1;
        
        for (let i = 0; i < fullList.length; i += chunkSize) {
            let list = fullList.slice(i, i + chunkSize);

            let h = `<div class="sayfa"><table class="veri-tablosu" data-grup="${gAd}">
            <colgroup><col class="c-sno"><col class="c-tc"><col class="c-isim"><col class="c-isim"><col class="c-sno">`;
            
            days.forEach((d, idx)=>{ h+=`<col class="c-gun">`; if(d.getDay()===0 || idx === days.length - 1) h+=`<col class="c-gun"><col class="c-gun"><col class="c-gun">`; });
            HDR.forEach(()=>h+=`<col class="c-gun">`); h+=`<col class="c-gun"><col class="c-gun"></colgroup><thead>
            
            <tr>
                <td colspan="5" class="stick-1" style="border: none !important; padding: 10px 0; text-align: left; font-size: 14px; font-weight: bold; background: white; z-index:40;">
                    ANTALYA ƒ∞L SAƒûLIK M√úD√úRL√úƒû√ú
                </td>
                <td colspan="${toplamSutun - 5}" style="border: none !important; padding: 10px 0; text-align: left; font-size: 14px; font-weight: bold; background: white;">
                    ${gAd.toUpperCase()} S√úREKLƒ∞ ƒ∞≈û√áƒ∞ PERSONEL PUANTAJ Bƒ∞LDƒ∞Rƒ∞Mƒ∞
                </td>
            </tr>
            <tr>
                <td colspan="5" class="stick-1" style="border: none !important; text-align: left; font-weight: bold; font-size: 11px; padding-bottom: 5px; background: white; z-index:40;">
                    Bƒ∞Rƒ∞M ADI    :   TEMƒ∞ZLƒ∞K
                </td>
                <td colspan="${toplamSutun - 5}" style="border: none !important; text-align: left; font-weight: bold; font-size: 11px; padding-bottom: 5px; background: white;">
                    ${str}
                </td>
            </tr>`;

            let tr1 = `<tr>
                <th rowspan="2" class="stick-1"><div class="baslik-dik">SIRA NO</div></th>
                <th rowspan="2" class="kalin-yatay stick-2">T.C. Kƒ∞MLƒ∞K NUMARASI</th>
                <th rowspan="2" class="isim-yatay stick-3">PERSONELƒ∞N ADI</th>
                <th rowspan="2" class="isim-yatay stick-4">PERSONELƒ∞N SOYADI</th>
                <th rowspan="2"><div class="baslik-dik">Devreden √áalƒ±≈üma Saati</div></th>`;
            
            let tr2 = `<tr>`;

            let weekCount = 1;
            days.forEach((d, idx)=>{
                let tamTarihStr = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth()+1).padStart(2, '0')}.${d.getFullYear()}`;
                let gunAdi = d.toLocaleDateString('tr-TR', { weekday: 'long' }).toUpperCase();
                let bgStyle = (d.getDay()===0||d.getDay()===6) ? 'background:#e0e0e0;' : '';
                
                tr1 += `<th style="${bgStyle} padding: 1px;" data-tarih="${tamTarihStr}"><div class="baslik-dik">${tamTarihStr}</div></th>`;
                tr2 += `<th style="${bgStyle} padding: 1px;" data-gun="${gunAdi}"><div class="baslik-dik-kucuk">${gunAdi}</div></th>`;
                
                if(d.getDay()===0 || idx === days.length - 1) {
                    tr1 += `<th rowspan="2" class="bg-hafta"><div class="baslik-dik">${weekCount}-Haftalƒ±k ƒ∞≈üe Gelme G√ºn√º</div></th>
                            <th rowspan="2" class="bg-hafta"><div class="baslik-dik">${weekCount}.Hafta Toplamƒ±</div></th>
                            <th rowspan="2" class="bg-hafta"><div class="baslik-dik">${weekCount}.Hafta Fazla Mesai</div></th>`;
                    weekCount++;
                }
            });

            HDR.forEach(b => { tr1 += `<th rowspan="2" class="bg-genel"><div class="baslik-dik">${b.n}</div></th>`; });
            tr1 += `<th rowspan="2" class="bg-gece"><div class="baslik-dik">Gece Fazla Mesai Toplamƒ± (Saat)</div></th><th rowspan="2" class="bg-gece"><div class="baslik-dik">Toplam Gece √áalƒ±≈ümasƒ± (Saat)</div></th></tr>`;
            tr2 += `</tr>`;

            h += tr1 + tr2 + `</thead><tbody>`;

            list.forEach((p, index)=>{
                let tcNo = ""; let ad = p.n; let soyad = "";
                if (p.n.includes("-")) {
                    let parts = p.n.split("-"); tcNo = parts[0].trim(); let tamIsim = parts[1].trim(); let isimParcalari = tamIsim.split(" ");
                    if(isimParcalari.length > 1) { soyad = isimParcalari.pop(); ad = isimParcalari.join(" "); } else { ad = tamIsim; }
                }
                h+=`<tr>
                    <td class="kalin-yatay stick-1" contenteditable="true">${globalIndex++}</td>
                    <td class="kalin-yatay stick-2" contenteditable="true">${tcNo}</td>
                    <td class="isim-yatay stick-3" contenteditable="true">${ad}</td>
                    <td class="isim-yatay stick-4" contenteditable="true">${soyad}</td>
                    <td class="kalin-yatay" contenteditable="true">0</td>`;
                
                days.forEach((d, idx)=>{
                    let tamTarihStr = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth()+1).padStart(2, '0')}.${d.getFullYear()}`;
                    let v = p.data[tamTarihStr] || ""; 
                    let info = getVardiyaInfo(v); 
                    let bg=(d.getDay()===0||d.getDay()===6)?'hucre-haftasonu':''; 
                    if(info.tip==='izin') bg='hucre-izin';
                    
                    h+=`<td contenteditable="true" class="veri-hucre ${bg}" data-smisim="${p.smName}" data-tarih="${tamTarihStr}" onfocus="hucreOdaklan(this)" onblur="hucreCik(this)">${formatliVardiya(v)}</td>`;
                    
                    if(d.getDay()===0 || idx === days.length - 1){
                        h+=`<th class="bg-hafta veri-hucre kalin-yatay" data-type="h-gun"></th>
                            <th class="bg-hafta veri-hucre kalin-yatay" data-type="h-saat"></th>
                            <th class="bg-hafta veri-hucre kalin-yatay" style="color:red;" data-type="h-fm"></th>`;
                    }
                });
                HDR.forEach(b => { h += `<th class="bg-genel kalin-yatay ${b.c}" ${b.c === 's-isg' ? 'contenteditable="true"' : ''}>0</th>`; });
                h += `<th class="bg-gece kalin-yatay s-gecefm">0</th><th class="bg-gece kalin-yatay s-gece">0</th></tr>`;
            });

            h+=`</tbody>
            <tfoot>
                <tr><td colspan="${toplamSutun}" style="border: none; text-align: left; padding-top: 5px;"><div style="font-size: 9px; font-weight: bold; color: #2c3e50;">NOT: "Fazla Mesai Saat" = Haftalƒ±k 45 Saati A≈üan Mesailer Toplamƒ±dƒ±r.</div></td></tr>
                <tr><td colspan="${toplamSutun}" style="border: none; text-align: center; font-weight: bold; font-size: 11px; padding: 2px 0;">A√áIKLAMALAR</td></tr>
                <tr><td colspan="${toplamSutun}" style="border: 1px solid #000; text-align: left; font-size: 10px; padding: 4px;" contenteditable="true"><strong>1-</strong> (A√ßƒ±klamalarƒ±nƒ±zƒ± buraya yazƒ±n...)</td></tr>
                <tr>
                    <td colspan="${Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 11px; padding-top: 15px;" contenteditable="true"><strong>D√ºzenleyen</strong><br>TEMƒ∞ZLƒ∞K Birim Sorumlusu<br><br><br>...................</td>
                    <td colspan="${Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 11px; padding-top: 15px;" contenteditable="true"><strong>Kontrol Eden</strong><br>ƒ∞DARƒ∞ VE MALƒ∞ ƒ∞≈ûLER M√ºd√ºr Yardƒ±mcƒ±sƒ±<br><br><br>...................</td>
                    <td colspan="${toplamSutun - 2*Math.floor(toplamSutun/3)}" style="border: none; text-align: center; font-size: 11px; padding-top: 15px;" contenteditable="true"><strong>Onaylayan</strong><br>ƒ∞DARƒ∞ VE MALƒ∞ ƒ∞≈ûLER M√ºd√ºr√º<br><br><br>...................</td>
                </tr>
            </tfoot>
            </table></div>`;
            sayfaHtml+=h;
        }
    }
    document.getElementById('raporAlani').innerHTML = sayfaHtml;
    document.querySelectorAll('.veri-hucre').forEach(td => satirHesapla(td));
    document.getElementById('btnExceleKopyala').style.display = "block";
}

// ==== SAƒû TIK MEN√úS√ú & TOPLU SE√áƒ∞M ====
let isSelecting = false; let startCell = null; let selectedCells = [];
function getRowIdx(td) { return Array.from(td.parentNode.parentNode.children).indexOf(td.parentNode); }
function getColIdx(td) { let tr = td.parentNode; let idx = 0; for (let i = 0; i < tr.children.length; i++) { if (tr.children[i] === td) return idx; idx += parseInt(tr.children[i].getAttribute('colspan') || 1); } return idx; }
function clearSelection() { selectedCells.forEach(td => { if(td) td.classList.remove('selected-cell'); }); selectedCells = []; }
function selectRectangle(start, end) {
    clearSelection(); let r1 = getRowIdx(start), r2 = getRowIdx(end); let c1 = getColIdx(start), c2 = getColIdx(end);
    let minR = Math.min(r1, r2), maxR = Math.max(r1, r2); let minC = Math.min(c1, c2), maxC = Math.max(c1, c2);
    let rows = start.closest('tbody').children;
    for (let r = minR; r <= maxR; r++) { let tds = rows[r].children; for (let c = minC; c <= maxC; c++) { let td = tds[c]; if (td && td.style.display !== 'none' && !td.hasAttribute('colspan')) { td.classList.add('selected-cell'); selectedCells.push(td); } } }
}
document.addEventListener('mousedown', function(e) { if (e.button !== 0 || e.target.closest('#tableContextMenu')) return; if (e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) { isSelecting = true; startCell = e.target; clearSelection(); e.target.classList.add('selected-cell'); selectedCells.push(e.target); } else clearSelection(); });
document.addEventListener('mouseover', function(e) { if (isSelecting && e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) selectRectangle(startCell, e.target); });
document.addEventListener('mouseup', function() { isSelecting = false; });

document.addEventListener('contextmenu', function(e) { 
    if (e.target.tagName === 'TD' && e.target.closest('.veri-tablosu') && !e.target.hasAttribute('colspan')) { 
        e.preventDefault(); 
        if (!selectedCells.includes(e.target)) { clearSelection(); e.target.classList.add('selected-cell'); selectedCells.push(e.target); } 
        
        let ctxMenuDiv = document.getElementById('ctxDinamikVardiyalar'); ctxMenuDiv.innerHTML = '';
        if(appData.vardiyalar) {
            for(let v in appData.vardiyalar) {
                let info = appData.vardiyalar[v]; let icon = info.tip === 'izin' ? 'üî¥' : 'üü¢';
                ctxMenuDiv.innerHTML += `<div class="ctx-item" onclick="seciliHucrelereVardiyaYaz('${v}')">${icon} ${v}</div>`;
            }
        }
        let ctxMenu = document.getElementById('tableContextMenu'); 
        ctxMenu.style.display = 'block'; ctxMenu.style.left = e.pageX + 'px'; ctxMenu.style.top = e.pageY + 'px'; 
    } 
});
document.addEventListener('click', function(e) { if(!e.target.closest('#tableContextMenu')) document.getElementById('tableContextMenu').style.display = 'none'; });

function seciliHucrelereVardiyaYaz(vardiyaKodu) {
    document.getElementById('tableContextMenu').style.display = 'none'; let batch = [];
    selectedCells.forEach(td => {
        if(td.style.display !== 'none' && td.classList.contains('veri-hucre')) {
            batch.push({ td: td, oldVal: td.innerHTML }); td.innerHTML = formatliVardiya(vardiyaKodu); satirHesapla(td); batch[batch.length-1].newVal = td.innerHTML;
        }
    });
    if(batch.length > 0) pushToHistory(batch); clearSelection();
}
function seciliHucreleriTemizle() {
    document.getElementById('tableContextMenu').style.display = 'none'; let batch = [];
    selectedCells.forEach(td => {
        if(td.style.display !== 'none' && td.classList.contains('veri-hucre')) {
            batch.push({ td: td, oldVal: td.innerHTML }); td.innerHTML = ''; td.classList.remove('hucre-izin'); satirHesapla(td); batch[batch.length-1].newVal = td.innerHTML;
        }
    });
    if(batch.length > 0) pushToHistory(batch); clearSelection();
}

function mergeSelectedCells() {
    document.getElementById('tableContextMenu').style.display = 'none'; if (selectedCells.length <= 1) return clearSelection();
    selectedCells.sort((a, b) => { let rDiff = getRowIdx(a) - getRowIdx(b); return rDiff !== 0 ? rDiff : getColIdx(a) - getColIdx(b); });
    let mainCell = selectedCells[0]; let mergeId = "merge_" + Date.now(); let isRowMerge = getRowIdx(selectedCells[0]) === getRowIdx(selectedCells[1]);
    if (isRowMerge) {
        let totalColSpan = 0; let mergedText = "";
        selectedCells.forEach((td, index) => { totalColSpan += parseInt(td.getAttribute('colspan') || 1); if(getCleanValue(td.innerText || td.textContent) !== "" && mergedText === "") mergedText = td.innerHTML; if (index > 0) { td.style.display = 'none'; td.setAttribute('data-merged-by', mergeId); } });
        mainCell.setAttribute('colspan', totalColSpan); mainCell.setAttribute('data-merge-id', mergeId); mainCell.innerHTML = mergedText;
    } else {
        let totalRowSpan = 0; let mergedText = "";
        selectedCells.forEach((td, index) => { totalRowSpan += parseInt(td.getAttribute('rowspan') || 1); if(getCleanValue(td.innerText || td.textContent) !== "" && mergedText === "") mergedText = td.innerHTML; if (index > 0) { td.style.display = 'none'; td.setAttribute('data-merged-by', mergeId); } });
        mainCell.setAttribute('rowspan', totalRowSpan); mainCell.setAttribute('data-merge-id', mergeId); mainCell.innerHTML = mergedText;
    }
    satirHesapla(mainCell); clearSelection();
}
function unmergeSelectedCells() {
    document.getElementById('tableContextMenu').style.display = 'none';
    selectedCells.forEach(td => {
        let mergeId = td.getAttribute('data-merge-id');
        if (mergeId) {
            td.removeAttribute('colspan'); td.removeAttribute('rowspan'); td.removeAttribute('data-merge-id');
            td.closest('tbody').querySelectorAll(`td[data-merged-by="${mergeId}"]`).forEach(hiddenTd => { hiddenTd.style.display = ''; hiddenTd.removeAttribute('data-merged-by'); satirHesapla(hiddenTd); });
        }
    });
    if(selectedCells.length > 0) satirHesapla(selectedCells[0]); clearSelection();
}

function exceleSifirKayipsizIndir() {
    const tablolar = document.querySelectorAll('.veri-tablosu'); if (tablolar.length === 0) return alert("L√ºtfen √∂nce tabloyu olu≈üturun.");
    let combinedHtml = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><style>table { border-collapse: collapse; font-family: 'Arial', sans-serif; font-size: 11px; } td, th { border: 0.5pt solid black; text-align: center; vertical-align: middle; }</style></head><body>`;
    tablolar.forEach(tablo => {
        if(tablo.closest('.sayfa').style.display === 'none') return;
        let clone = tablo.cloneNode(true);
        clone.querySelectorAll('script, button').forEach(el => el.remove()); clone.querySelectorAll('td[style*="display: none"], th[style*="display: none"]').forEach(c => c.remove());
        clone.querySelectorAll('th, td').forEach(el => {
            let inlineStyle = `border: 0.5pt solid black; vertical-align: middle; `;
            if (el.classList.contains('bg-hafta')) inlineStyle += "background-color: #dff0d8;"; else if (el.classList.contains('bg-genel')) inlineStyle += "background-color: #fcf3cf;"; else if (el.classList.contains('bg-gece')) inlineStyle += "background-color: #e8daef;"; else if (el.classList.contains('hucre-izin')) inlineStyle += "background-color: #fadbd8; color: #c0392b;"; else if (el.classList.contains('hucre-haftasonu')) inlineStyle += "background-color: #f2f2f2;";
            if (el.classList.contains('kalin-yatay')) inlineStyle += "font-weight: bold; font-size: 11px; text-align: center;"; else if (el.classList.contains('isim-yatay')) inlineStyle += "font-weight: bold; font-size: 11px; text-align: left;"; else inlineStyle += "text-align: center;";
            
            if (el.hasAttribute('data-tarih') && el.tagName === 'TH') { el.innerHTML = el.getAttribute('data-tarih'); inlineStyle += "mso-rotate: 90; height: 60pt; white-space: nowrap; font-weight: bold;"; }
            else if (el.hasAttribute('data-gun')) { el.innerHTML = el.getAttribute('data-gun'); inlineStyle += "mso-rotate: 90; height: 45pt; white-space: nowrap; font-weight: normal; font-size: 9px;"; }
            else {
                let raw = el.innerText || el.textContent || ""; raw = raw.trim();
                if (el.classList.contains('veri-hucre') && raw) { raw = raw.replace(/\s+/g, '-').replace(/-+/g, '-'); el.innerHTML = raw; inlineStyle += "mso-rotate: 90; height: 65pt; white-space: nowrap; font-weight: bold;"; }
                else { let dikeyBaslik = el.querySelector('.baslik-dik'); if (dikeyBaslik) { el.innerHTML = dikeyBaslik.innerHTML; inlineStyle += "mso-rotate: 90; height: 110pt; white-space: normal;"; } }
            }
            el.setAttribute('style', inlineStyle);
        });
        combinedHtml += clone.outerHTML + "<br><br><br>"; 
    });
    combinedHtml += "</body></html>";
    const blob = new Blob(['\ufeff' + combinedHtml], { type: 'application/vnd.ms-excel;charset=utf-8' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'Hastane_Puantaj_Listesi.xls'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}
</script>
</body>
</html>
